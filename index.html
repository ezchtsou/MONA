<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ–°é€²å“¡å·¥è¨“ç·´å›é¥‹ç³»çµ±</title>
  <style>
    :root{--bg:#f8fafc;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--brand:#0ea5e9;--active:#dbeafe;--danger:#fecaca}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans CJK TC",sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.5px}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{border:1px solid #e5e7eb;background:#fff;color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
    .tab.active{border-color:var(--brand);box-shadow:0 0 0 1px inset var(--brand)}
    main{padding:24px}
    section.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:20px;margin:18px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input[type=text],input[type=date],input[type=email],select,textarea{width:100%;background:#fff;color:var(--text);border:1px solid #e5e7eb;border-radius:10px;padding:10px}
    textarea{min-height:88px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    button{border:1px solid #e5e7eb;background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button.primary{border-color:var(--brand);box-shadow:0 0 0 1px inset var(--brand)}
    .muted{color:var(--muted);font-size:12px}
    .toast{position:fixed;right:16px;bottom:16px;padding:10px 14px;background:#fff;border:1px solid #e5e7eb;border-radius:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{text-align:left;border-bottom:1px solid #e5e7eb;padding:6px}
    /* é«˜äº®å·²é¸çš„å–®é¸æ¡†æ‰€åœ¨å„²å­˜æ ¼ï¼ˆç¾ä»£ç€è¦½å™¨æ”¯æ´ :hasï¼‰ */
    td:has(input[type=radio]:checked){background:var(--active)}

</style>
  
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
</head>
<body>
  <header>
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h1>æ–°é€²å“¡å·¥è¨“ç·´å›é¥‹ç³»çµ±</h1>
        <span class="muted">ä½¿ç”¨è€…IDï¼š<strong id="userIdBadge">æœªè¨­å®š</strong></span>
      </div>
      <nav id="tabs" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"></nav>
    </div>
  </header>
  <main class="wrap">
    <!-- âœ… ç¬¬ä¸€å¼µå¡ç‰‡ï¼šåŸºæœ¬è³‡è¨Š -->
<section id="tab-0" class="card">
  <h2>ğŸ”‘ åŸºæœ¬è³‡è¨Š</h2>
  <div class="row">
    <div>
      <label>å“¡å·¥ç·¨è™Ÿï¼ˆemployeeIdï¼‰</label>
      <input id="employeeId" type="text" placeholder="ä¾‹å¦‚ï¼š9999M0000" />
    </div>
    <div>
      <label>å§“å</label>
      <input id="fullName" type="text" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" />
    </div>
  </div>
  <div class="row">
    <div>
      <label>å–®ä½ / éƒ¨é–€</label>
      <input id="dept" type="text" placeholder="ä¾‹å¦‚ï¼šè»Šè¼›èª²ï¼è»ŒåœŸèª²ï¼é€šè™Ÿèª²" />
    </div>
    <div>
      <label>ä»Šå¤©æ—¥æœŸ</label>
      <input id="date" type="date" />
      <div class="btns">
        <button id="fillToday" type="button">å¡«å…¥ä»Šå¤©</button>
        <button id="clearIdentityBtn" type="button">ğŸ§¹æ¸…é™¤è³‡æ–™</button>
      </div>
    </div>
  </div>
</section>

<!-- âœ… ç¬¬äºŒå¼µå¡ç‰‡ï¼šå¡«å¯«èªªæ˜èˆ‡æ™‚ç¨‹ï¼ˆæ”¾åœ¨ tab-0 ä¹‹å¾Œï¼‰ -->
<section id="tab-0-guide" class="card">
  <h2>ğŸ—’ å¡«å¯«èªªæ˜èˆ‡æ™‚ç¨‹</h2>
  <p class="muted">
    ä»¥ä¸‹ç‚ºå„å•å·çš„ç›®çš„ã€å»ºè­°å¡«å¯«æ™‚é»èˆ‡å¹³å‡æ‰€éœ€æ™‚é–“ã€‚é»å³å´æŒ‰éˆ•å¯ç›´æ¥åˆ‡æ›åˆ°è©²å•å·ã€‚
  </p>
  <table>
    <thead>
      <tr>
        <th>å•å·</th>
        <th>ç›®çš„ / å…§å®¹é‡é»</th>
        <th>å»ºè­°å¡«å¯«å°è±¡</th>
        <th>é »ç‡</th>
        <th>å»ºè­°æ™‚é–“</th>
        <th>æˆªæ­¢/æ™‚é»</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>ğŸ“˜ èª²å ‚å•å·</td>
        <td>å–®å ‚èª²æ»¿æ„åº¦èˆ‡é‡é»å›é¥‹ã€‚</td>
        <td>åƒèˆ‡è©²å ‚èª²çš„å­¸å“¡</td>
        <td>æ¯å ‚èª²ä¸€æ¬¡</td>
        <td> 1 åˆ†é˜ä»¥å…§</td>
        <td>ä¸‹èª²å¾Œç«‹åˆ»å¡«å¯«</td>
        <td><button data-goto="tab-7">ç«‹å³å‰å¾€</button></td>
      </tr>
      <tr>
        <td>ğŸ§­ æ¯å‘¨å•å·</td>
        <td>è¿½è¹¤æœ¬é€±ä»»å‹™é€²å±•ã€å­¸ç¿’å›°é›£èˆ‡å»ºè­°ã€‚</td>
        <td>æ–°é€²å“¡å·¥æœ¬äºº</td>
        <td>æ¯å‘¨ä¸€æ¬¡</td>
        <td>ç´„ 4-6 åˆ†é˜</td>
        <td>æ¯é€±äº” 23:59</td>
        <td><button data-goto="tab-6">ç«‹å³å‰å¾€</button></td>
      </tr>
      <tr>
        <td>ğŸ‘Œ åˆæœŸå•å·</td>
        <td>äº†è§£æ–°äººå°ç’°å¢ƒ/åˆ¶åº¦/ç³»çµ±ç­‰ç†Ÿæ‚‰åº¦ã€‚</td>
        <td>æ–°é€²å“¡å·¥æœ¬äºº</td>
        <td>ä¸€æ¬¡</td>
        <td>ç´„ 3â€“5 åˆ†é˜</td>
        <td>å…¥è· 3 å¤©å…§</td>
        <td><button data-goto="tab-1">ç«‹å³å‰å¾€</button></td>
      </tr>
      <tr>
        <td>ğŸ’¡ ä¸­æœŸå•å·</td>
        <td>è©•ä¼°ç†è«–/å¯¦ä½œçš„èª²ç¨‹æŒæ¡åº¦èˆ‡å·¥ä½œé©æ‡‰ã€‚</td>
        <td>æ–°é€²å“¡å·¥æœ¬äºº</td>
        <td>ä¸€æ¬¡</td>
        <td>ç´„ 5â€“7 åˆ†é˜</td>
        <td>å…¥è·ç¬¬ 2 å€‹æœˆ</td>
        <td><button data-goto="tab-2">ç«‹å³å‰å¾€</button></td>
      </tr>
      <tr>
        <td>ğŸ”¶ å¾ŒæœŸäº”å‘åº¦è©•ä¼°</td>
        <td>å¾å·¥ä½œè¡¨ç¾ã€åœ˜éšŠã€æ…‹åº¦ã€å•é¡Œè§£æ±ºã€æ•´é«”è²¢ç»åšäº”å‘åº¦è©•ä¼°ã€‚</td>
        <td>è‡ªè©•ï¼ä¸»ç®¡æˆ–å°å¸«ï¼åŒäº‹</td>
        <td>ä¸€æ¬¡</td>
        <td>ç´„ 5-7 åˆ†é˜</td>
        <td>å…¥è·ç¬¬ 4 å€‹æœˆ</td>
        <td><button data-goto="tab-3">ç«‹å³å‰å¾€</button></td>
      </tr>
      <tr>
        <td>ğŸ’¬ æ„è¦‹åæ˜ </td>
        <td>ä»»ä½•æ™‚é–“çš„å•é¡Œå›å ±ã€å»ºè­°æˆ–éœ€æ±‚ã€‚</td>
        <td>æ‰€æœ‰å­¸å“¡</td>
        <td>â€”</td>
        <td><button data-goto="tab-4">ç«‹å³å‰å¾€</button></td>
      </tr>
    </tbody>
  </table>
</section>

 <section id="tab-7" class="card">
  <h2>ğŸ“˜ èª²å ‚å•å· <span id="courseHeader" class="muted"></span></h2>
  <div id="coursePicker" class="row" style="margin-bottom:12px; display:none">
    <div>
      <label>é¸æ“‡èª²ç¨‹ï¼ˆè£œå¡«ï¼‰</label>
      <select id="courseSelect"><option value="">è«‹é¸æ“‡èª²ç¨‹</option></select>
    </div>
  </div>
  <p class="muted">è«‹ä»¥äº”é»é‡è¡¨ä½œç­”ï¼ˆ1ï¼éå¸¸ä¸åŒæ„ï¼Œ5ï¼éå¸¸åŒæ„ï¼‰ã€‚</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">é€å‡ºèª²å ‚å•å·</button></div>
</section>
    
<!-- ğŸ—“ æ¯å‘¨å•å· -->
   <section id="tab-6" class="card">
  <h2>ğŸ§­ æ¯å‘¨å•å·</h2>
  <p>è«‹ä»¥äº”é»é‡è¡¨ä½œç­”ï¼ˆ1ï¼éå¸¸ä¸åŒæ„ï¼Œ5ï¼éå¸¸åŒæ„ï¼‰ï¼Œä¸¦å®Œæˆé–‹æ”¾é¡Œï¼š</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">é€å‡ºæ¯å‘¨å•å·</button></div>
</section>
    
   <section id="tab-1" class="card">
  <h2>ğŸ‘Œ åˆæœŸå•å·</h2>
  <p>è«‹é‡å°ä»¥ä¸‹æŒ‡æ¨™é€²è¡Œè©•åˆ†ï¼ˆ1ï¼éå¸¸ä¸åŒæ„ï¼Œ5ï¼éå¸¸åŒæ„ï¼‰ï¼š</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">é€å‡ºåˆæœŸå•å·</button></div>
</section>
    
    <section id="tab-2" class="card">
  <h2>ğŸ’¡ ä¸­æœŸèª²ç¨‹å›é¥‹</h2>
  <p>è«‹è©•ä¼°ä»¥ä¸‹å­¸ç¿’æˆæ•ˆï¼ˆ1ï¼éå¸¸ä¸åŒæ„ï¼Œ5ï¼éå¸¸åŒæ„ï¼‰ï¼š</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">é€å‡ºä¸­æœŸå•å·</button></div>
</section>

    <section id="tab-3" class="card">
  <h2>ğŸ”¶ å¾ŒæœŸäº”å€‹å‘åº¦è©•ä¼°</h2>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">é€å‡ºå¾ŒæœŸè©•ä¼°</button></div>
</section>

    <section id="tab-4" class="card">
  <h2>ğŸ’¬ æ„è¦‹åæ˜ </h2>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">é€å‡ºç•™è¨€</button></div>
</section>
    
  <section id="tab-5" class="card">
  <h2>ğŸ› ï¸ ç®¡ç†è¨­å®šï¼ˆAdminï¼‰</h2>
  <p class="muted">è¼¸å…¥ç®¡ç†é‡‘é‘°å¾Œæ‰æœƒé¡¯ç¤ºä¸¦å•Ÿç”¨ GAS Web App è¨­å®šã€‚</p>

  <div class="row">
    <div>
      <label>ç®¡ç†é‡‘é‘°</label>
      <input id="adminKey" type="password" placeholder="è«‹è¼¸å…¥é‡‘é‘°" />
      <div class="btns">
        <button id="adminUnlock" type="button">å•Ÿç”¨ç®¡ç†</button>
      </div>
    </div>
  </div>

  <!-- â˜… å¿…é ˆæœ‰ adminPanelï¼Œè§£é–å¾Œæ‰é¡¯ç¤º -->
    <div id="adminPanel" style="display:none; margin-top:16px">
      <section id="adminCharts" class="card" style="margin-top:0">
        <h3>ğŸ“ˆ åŒ¿åå½™æ•´é è¦½</h3>
        <div class="muted" style="margin-bottom:8px">è³‡æ–™ä¾†æºï¼šstats_course / weekly_compare / stats_locate / stats_skill</div>
        <div style="display:grid;grid-template-columns:1fr;gap:18px">
          <canvas id="chartCourseOverall"></canvas> <!-- â‘  å„èª²ç¨‹æ•´é«”æ»¿æ„åº¦ -->
          <canvas id="chartWeeklyTrend"></canvas>   <!-- â‘¡ æ¯å‘¨å•å·æŠ˜ç·š -->
          <canvas id="chartLocateAvg"></canvas>     <!-- â‘¢ åˆæœŸå„é¡Œ -->
          <canvas id="chartSkillAvg"></canvas>      <!-- â‘£ ä¸­æœŸå„é¡Œ -->
        </div>
      </section>
    </div>
  </section>
</main>
  
<script>
/* =========================================================
 * [01] å…¨åŸŸè¨­å®šï¼ˆAdmin é‡‘é‘° / GAS ç«¯é»ï¼‰
 * =======================================================*/
const ADMIN_SECRET     = 'ADMINKEY'; // è¦å’Œå¾Œç«¯çš„ ADMIN_KEY ç›¸åŒ
const DEFAULT_GAS_URL  = 'https://script.google.com/macros/s/AKfycbylnQs-FaohoCe0wdEw_xQyhLNX0jq_Hcou3Ndxgfq1YdPcs4114PNTp64b619qUpGa/exec';      // â† ç›´æ¥æ”¾æ­£å¼ /exec

// â˜… ä¿®æ­£å¾Œï¼šå›ºå®šç«¯é»ï¼ˆä¸è¦æ®˜ç•™èˆŠç¨‹å¼ç¢¼åœ¨å…¨åŸŸï¼‰
function getEndpoint(){ return DEFAULT_GAS_URL.trim(); }
function setEndpoint(){ /* no-op */ }

/* =========================================================
 * [02] å°å·¥å…·ï¼ˆQuery è§£æ / æç¤º / ä½¿ç”¨è€…åŸºæœ¬è³‡æ–™ï¼‰
 * =======================================================*/
function getQuery(){ try { return Object.fromEntries(new URL(location.href).searchParams.entries()); } catch { return {}; } }
window.profile = window.profile || { employeeId:'', fullName:'', dept:'', date:(new Date()).toISOString().slice(0,10) };
window.toast = (msg)=>{
  let t = document.querySelector('.toast');
  if (!t) {
    t = document.createElement('div');
    t.className = 'toast';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> t.style.display='none', 2000);
};

/* =========================================================
 * [03] èˆ‡ GAS æºé€šï¼ˆé€å–®ä¸€ payloadï¼›åŒ¿ååœ–è¡¨å¦è¦‹ [09]ï¼‰
 * =======================================================*/
async function submitToGAS(payload){
  const endpoint = getEndpoint();
  let res;
  try { res = await fetch(endpoint, { method:'POST', body: JSON.stringify(payload) }); }
  catch (e) { throw new Error('ç„¡æ³•é€£ç·šåˆ° GASï¼š' + (e.message || 'é€£ç·šå¤±æ•—')); }

  const text = await res.text().catch(()=> '');
  try {
    const data = JSON.parse(text || '{}');
    if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
    return data;
  } catch {
    throw new Error('GAS é JSON å›æ‡‰ï¼š' + String(text).slice(0,200));
  }
}

/* =========================================================
 * [04] å•å·é…ç½®ï¼ˆFORM_CONFIGï¼šæ¨™ç±¤é †åºã€é¡Œç›®ã€é–‹æ”¾é¡Œã€extrasï¼‰
 * =======================================================*/
const FORM_CONFIG = {
  tabs: [
    { id:'tab-0', name:'åŸºæœ¬è³‡è¨Š', kind:'basic' },

 { id:'tab-7', name:'èª²å ‚å•å·', kind:'course', prefix:'cq',
  likertTexts:[
    'æˆ‘åœ¨é€™å ‚è¨“ç·´èª²ç¨‹å­¸ç¿’åˆ°æ–°çš„è§€å¿µèˆ‡æŠ€å·§ã€‚',
    'èª²ç¨‹å…§å®¹èˆ‡ä¸»é¡Œéå¸¸å¥‘åˆã€‚',
    'æˆ‘å°æ–¼èª²ç¨‹éå¸¸æ»¿æ„ã€‚'
  ],
     opens:[
    'è«‹å¯«ä¸‹æœ¬å ‚èª²è®“ä½ æœ€æœ‰æ”¶ç©«çš„ä¸€é»ï¼ˆæˆ–å»ºè­°æ”¹é€²ä¹‹è™•ï¼‰ã€‚']
},
    
    { id:'tab-6', name:'æ¯å‘¨å•å·', kind:'weekly', prefix:'wk',
      likertTexts:[
        'æœ¬é€±æˆ‘èƒ½é †åˆ©å®Œæˆåˆ†é…çš„ä»»å‹™èˆ‡ä½œæ¥­ã€‚',
        'æˆ‘è¦ºå¾—è‡ªå·±æ¯”ä¸Šé€±æ›´ç†Ÿæ‚‰å·¥ä½œæµç¨‹ã€‚',
        'ç•¶å·¥ä½œä¸­å‡ºç¾å•é¡Œæ™‚ï¼Œæˆ‘èƒ½æ¸…æ¥šçŸ¥é“è§£æ±ºæ–¹å‘ã€‚',
        'æœ¬é€±èˆ‡å‰è¼©æˆ–åŒäº‹çš„åˆä½œäº’å‹•é †åˆ©ã€‚',
        'æˆ‘åœ¨ç¾å ´è§€å¯Ÿåˆ°æ–°çš„çŸ¥è­˜æˆ–æŠ€å·§ï¼Œä¸¦é¡˜æ„ä¸»å‹•å­¸ç¿’ã€‚',
        'æˆ‘è¦ºå¾—è‡ªå·±çš„å°ˆæ³¨åŠ›èˆ‡é«”åŠ›èƒ½æ‡‰ä»˜ç›®å‰çš„è¨“ç·´éœ€æ±‚ã€‚',
        'æˆ‘è¦ºå¾—ç›®å‰çš„èª²ç¨‹å®‰æ’èˆ‡å¯¦ä½œæ¯”ä¾‹é©åˆæˆ‘çš„å­¸ç¿’æ­¥èª¿ã€‚',
        'åŸ¹è¨“è³‡è¨Šï¼ˆå¦‚æ™‚é–“ã€åœ°é»ã€å…§å®¹ï¼‰æ˜¯å¦æ¸…æ¥šä¸”å®¹æ˜“å–å¾—ï¼Ÿ'
      ],
      opens:[
        'è¨“ç·´å…§å®¹å›é¥‹èˆ‡å¿ƒå¾—ï¼ˆè«‹é‡å°èª²ç¨‹å…§å®¹åˆ†äº«å­¸ç¿’æ‘˜è¦èˆ‡æ”¶ç©«ï¼Œè‡³å°‘100å­—ï¼‰ã€‚',
        'è¨“ç·´èª²ç¨‹æå•ï¼ˆè«‹æå‡ºæ‚¨å°æœ¬å‘¨è¨“ç·´å…§å®¹çš„ç–‘å•ã€æ”¹é€²å»ºè­°æˆ–å¸Œæœ›åŠ å¼·çš„éƒ¨åˆ†ï¼Œä¹Ÿæ­¡è¿å‰µæ„æå•ï¼Œè‡³å°‘å¡«å¯«ä¸€é …ï¼‰'
      ]
    },
    
    { id:'tab-1', name:'åˆæœŸå•å·', kind:'locate', prefix:'loc',
      likertTexts:[
        'æˆ‘æ¸…æ¥šçŸ¥é“è’¸é£¯ç®±ã€å¾®æ³¢çˆã€æ´—ç¢—æ§½ç­‰è¨­æ–½çš„ä½ç½®èˆ‡ä½¿ç”¨è¦ç¯„ã€‚',
        'æˆ‘èƒ½é †åˆ©æ‰¾åˆ°ä¼‘æ¯å€èˆ‡æ·‹æµ´é–“ç­‰ç©ºé–“ã€‚',
        'æˆ‘çŸ¥é“å» å€å…§å„é …è¨­æ–½çš„ä½ç½®ã€‚',
        'æˆ‘äº†è§£å…¬å¸çš„æ•´é«”çµ„ç¹”æ¶æ§‹èˆ‡å„éƒ¨é–€ä½ç½®ã€‚',
        'æˆ‘çŸ¥é“è‡ªå·±éš¸å±¬çš„å–®ä½åŠå·¥ä½œä»»å‹™ã€‚',
        'æˆ‘çŸ¥é“è©²èˆ‡å“ªäº›å–®ä½æˆ–åŒäº‹é…åˆå®Œæˆå·¥ä½œã€‚',
        'æˆ‘çŸ¥é“ç›´æ¥ä¸»ç®¡æ˜¯èª°ï¼Œäº†è§£ä¸»ç®¡çš„è·è²¬èˆ‡æœŸæœ›ã€‚',
        'æˆ‘çŸ¥é“é‡åˆ°å•é¡Œæ™‚å¯ä»¥å‘å“ªäº›åŒäº‹æˆ–ä¸»ç®¡æ±‚åŠ©ã€‚',
        'æˆ‘å·²äº†è§£è–ªè³‡çµæ§‹ã€å·®å‹¤èˆ‡è«‹å‡åˆ¶åº¦ã€‚',
        'æˆ‘å·²äº†è§£å…¬å¸å„ç¶²ç«™çš„æ“ä½œï¼Œä¸¦å¯ä»¥é †åˆ©ç™»å…¥ã€‚'
      ],
      opens:['è«‹åˆ†äº«å‰ä¸‰å¤©ä¸­æœ€å¹«åŠ©ä½ èå…¥ç’°å¢ƒçš„ä¸€é …å®‰æ’ï¼Œæˆ–ä½ è¦ºå¾—å¯æ”¹é€²çš„åœ°æ–¹ã€‚']
    },

    { id:'tab-2', name:'ä¸­æœŸå•å·', kind:'skill', prefix:'sk',
      likertTexts:[
        'æŠ€èƒ½èª²ç¨‹çš„å…§å®¹èƒ½æ‡‰ç”¨æ–¼å¯¦éš›å·¥ä½œã€‚',
        'æˆ‘æ¸…æ¥šå…¬å¸çš„å®‰å…¨è¦ç¯„èˆ‡å“è³ªè¦æ±‚ã€‚',
        'æˆ‘èƒ½ç†Ÿç·´æ“ä½œèª²ç¨‹ä¸­å­¸åˆ°çš„æŠ€èƒ½ã€‚',
        'èª²ç¨‹æ™‚é–“èˆ‡é€²åº¦å®‰æ’åˆç†ã€‚',
        'æˆ‘èƒ½åˆ†è¾¨å“ªäº›è¡Œç‚ºæœƒå½±éŸ¿å®‰å…¨æˆ–å“è³ªã€‚' ,       
        'æˆ‘èƒ½æ¸…æ¥šèªªæ˜ç†è«–èª²ç¨‹ä¸­æ‰€å­¸åˆ°çš„åŸºæœ¬æ¦‚å¿µèˆ‡åŸç†ã€‚',
        'ç†è«–èª²ç¨‹å…§å®¹èˆ‡æˆ‘ç›®å‰åœ¨ç¾å ´çœ‹åˆ°çš„è¨­å‚™èˆ‡æµç¨‹ç›¸ç¬¦ã€‚',
        'ç†è«–èª²ç¨‹ä¸­çš„ç¯„ä¾‹æˆ–èªªæ˜ï¼Œæœ‰åŠ©æ–¼æˆ‘ç†è§£å¯¦éš›çš„å·¥ä½œæµç¨‹ã€‚',
        'ç†è«–èª²ç¨‹è®“æˆ‘åœ¨ç¾å ´èƒ½æ›´å¿«ç†è§£ç¶­ä¿®å·¥ä½œçš„é‚è¼¯æˆ–åŸç†ã€‚',
        'æˆ‘å·²èƒ½ç†è§£å¯¦ä½œèª²ç¨‹ä¸­å„æ­¥é©Ÿçš„ç›®çš„èˆ‡æ³¨æ„äº‹é …ã€‚',
        'æˆ‘èƒ½åœ¨å‰è¼©æŒ‡å°ä¸‹å®Œæˆéƒ¨åˆ†ç°¡å–®ä»»å‹™ï¼ˆå¦‚å”åŠ©æª¢æŸ¥ã€æ¸…æ½”ã€å·¥å…·æº–å‚™ç­‰ï¼‰ã€‚',
        'åœ¨ç¾å ´ç¶­ä¿®éç¨‹ä¸­ï¼Œæˆ‘èƒ½çœ‹ï¼è½æ‡‚æŒ‡å°äººå“¡ä½¿ç”¨çš„è¡“èªèˆ‡æµç¨‹ã€‚',
        'ç•¶çœ‹åˆ°å¯¦éš›è¨­å‚™æ™‚ï¼Œæˆ‘èƒ½è¯æƒ³åˆ°ç†è«–èª²ç¨‹ä¸­å­¸éçš„å…§å®¹ã€‚',
        'ç•¶é‡åˆ°å•é¡Œæ™‚ï¼Œæˆ‘æœƒä¸»å‹•ç¿»é–±SOPæˆ–åŸ¹è¨“æ•™æå°‹æ‰¾è§£æ±ºæ–¹å¼ã€‚',
        'æˆ‘èƒ½åˆ¤æ–·å“ªäº›å•é¡Œå¯ä»¥è‡ªå·±è™•ç†ï¼Œå“ªäº›éœ€è¦è«‹æ•™å‰è¼©ã€‚',
        'æˆ‘èƒ½å¾å‰è¼©çš„ç¤ºç¯„ä¸­å­¸ç¿’ä¸¦é€æ­¥æ”¹å–„è‡ªå·±çš„æ“ä½œæ–¹å¼ã€‚',
        'å‰è¼©æˆ–åŒäº‹é¡˜æ„çµ¦äºˆæˆ‘å…·é«”çš„æŒ‡å°èˆ‡å›é¥‹ã€‚',
        'åœ¨ç¾å ´å­¸ç¿’æ™‚ï¼Œæˆ‘èƒ½ä¸»å‹•ç™¼å•ä¸¦å¾—åˆ°æ­£å‘å›æ‡‰ã€‚'
      ],
      opens:['æˆ‘è¦ºå¾—ç†è«–èª²ç¨‹èˆ‡å¯¦ä½œèª²ç¨‹çš„éŠœæ¥ç¨‹åº¦è‰¯å¥½ï¼Œèƒ½å¹«åŠ©æˆ‘ç©©å®šæˆé•·ã€‚','è«‹å¯«ä¸‹ä½ èªç‚ºã€Œç†è«–èª²ç¨‹æœ€æœ‰å¹«åŠ©çš„éƒ¨åˆ†ã€èˆ‡ã€Œå¯¦ä½œè¨“ç·´æœ€éœ€è¦æ”¹é€²çš„åœ°æ–¹ã€ã€‚'],
    },

    { id:'tab-3', name:'å¾ŒæœŸäº”å€‹å‘åº¦è©•ä¼°å•å·', kind:'grow360', prefix:'gr',
  likertTexts:[
    'è©²å“¡å·¥èƒ½åœ¨æœŸé™å…§å®Œæˆäº¤è¾¦ä»»å‹™ã€‚',
    'è©²å“¡å·¥çš„å·¥ä½œå“è³ªç©©å®šä¸”å¯é ã€‚',
    'è©²å“¡å·¥åœ¨å·¥ä½œä¸Šæ³¨é‡ç´°ç¯€ä¸¦è¿½æ±‚æ”¹é€²ã€‚',
    'è©²å“¡å·¥èƒ½ä¾æŒ‡ç¤ºè™•ç†çªç™¼ç‹€æ³ã€‚',
    'è©²å“¡å·¥èƒ½å°è‡ªå·±çš„éå¤±è² è²¬ã€‚',
    'è©²å“¡å·¥èƒ½èˆ‡åŒäº‹è‰¯å¥½åˆä½œã€æºé€šé †æš¢ã€‚',
    'è©²å“¡å·¥èƒ½ä¸»å‹•å”åŠ©ä»–äººæˆ–æ”¯æ´åœ˜éšŠä»»å‹™ã€‚',
    'è©²å“¡å·¥åœ¨å·¥ä½œä¸­è¡¨ç¾ç©æ¥µï¼Œæ¨‚æ–¼å­¸ç¿’ã€‚',
    'ç•¶ä»»å‹™å„ªå…ˆé †åºæ”¹è®Šæ™‚ï¼Œè©²å“¡å·¥èƒ½å¿«é€Ÿèª¿æ•´ã€‚',
    'è©²å“¡å·¥åœ¨å£“åŠ›æˆ–æ‰¹è©•ä¸‹ä»èƒ½ä¿æŒå°ˆæ¥­è¡¨ç¾ã€‚',
    'è©²å“¡å·¥å…·å‚™è‰¯å¥½çš„å•é¡Œè§£æ±ºèˆ‡åˆ¤æ–·èƒ½åŠ›ã€‚',
    'æˆ‘å°è©²å“¡å·¥åšå‡ºæ­£ç¢ºæ±ºç­–çš„èƒ½åŠ›æœ‰ä¿¡å¿ƒã€‚',
    'è©²å“¡å·¥å°å·¥ä½œç’°å¢ƒçš„å½±éŸ¿æ˜¯æ­£é¢çš„ã€‚',
    'æ‚¨å‘å…¶ä»–åŒäº‹æ¨è–¦è©²å“¡å·¥çš„å¯èƒ½æ€§æœ‰å¤šå¤§ï¼Ÿï¼ˆ1ï¼çµ•ä¸æ¨è–¦ï¼Œ5ï¼éå¸¸æ¨è–¦ã€‚ï¼‰',
  ],
  opens:['è«‹åˆ—å‡ºè©²å“¡å·¥è¡¨ç¾æœ€å„ªç§€çš„ä¸‰å€‹é¢å‘ã€‚','è«‹åˆ—å‡ºè©²å“¡å·¥æœ€éœ€è¦æ”¹é€²çš„ä¸‰å€‹éƒ¨åˆ†æˆ–å»ºè­°å…¶æˆé•·æ–¹å‘ã€‚'],
  extras:[
  { key:'role', label:'è§’è‰²', type:'select', required:true,
    options:[
      {value:'self',    label:'è‡ªè©•ï¼ˆé è¨­ï¼‰'},
      {value:'manager', label:'ç›´å±¬ä¸»ç®¡/å°å¸«'},
      {value:'peer',    label:'åŒäº‹'},
    ],
    default:'self'
  }
]
},

    { id:'tab-4', name:'æ„è¦‹åæ˜ ', kind:'messages',
      opens:['ç•™è¨€å…§å®¹']
    },

    { id:'tab-5', name:'ç®¡ç†è¨­å®š', kind:'admin' },
  ]
};

/* ===== [05] åˆ†é  UI ===== */
function renderTabs(){
  const unlocked = sessionStorage.getItem('admin_unlocked') === '1';
  const host = document.getElementById('tabs');
  host.innerHTML = '';

  // ä¸éæ¿¾ï¼Œå…¨éƒ¨åˆ—å‡º
  window.__TAB_SPECS = (FORM_CONFIG.tabs||[]).map(t => ({ id:t.id, name:t.name, kind:t.kind }));

  window.__TAB_SPECS.forEach((t,i)=>{
    const btn = document.createElement('button');
    btn.className = 'tab' + (i===0 ? ' active' : '');
    // æœªè§£é–æ™‚åœ¨æ¨™ç±¤ä¸Šæç¤ºï¼ˆå¯é¸ï¼‰
    btn.textContent = t.name + (t.kind==='admin' && !unlocked ? 'ï¼ˆéœ€é‡‘é‘°ï¼‰' : '');
    btn.addEventListener('click', ()=> switchTab(i));
    host.appendChild(btn);
  });
}
  
function switchTab(index){
  const specs = window.__TAB_SPECS || [];
  const tabs = document.getElementById('tabs').children;
  for(let i=0;i<tabs.length;i++) tabs[i].classList.toggle('active', i===index);
  specs.forEach((t,i)=>{
    const sec = document.getElementById(t.id);
    if(!sec) return;
    sec.style.display = (i===index) ? 'block' : 'none';
  });
  const names = specs.map(t=>t.kind);
  const h = names[index] || 'basic';
  if (location.hash !== '#'+h) history.replaceState(null,'','#'+h);
}
function applyHash(){
  const unlocked = sessionStorage.getItem('admin_unlocked') === '1';
  const specs = window.__TAB_SPECS || [];
  const names = specs.map(t=>t.kind);
  const map = Object.fromEntries(names.map((n,i)=>[n,i]));
  let key = (location.hash||'').replace('#','');
  switchTab(map[key] ?? 0);
}

/* ===== [06] å•å·æ¸²æŸ“ ===== */
function renderAllForms(){
  FORM_CONFIG.tabs.forEach(tab=>{
    if(['basic','admin'].includes(tab.kind)) return;
    const sec = document.getElementById(tab.id);
    if(!sec) return;

    let html = '';
    if (tab.kind === 'messages') {
      const label = (tab.opens && tab.opens[0]) || 'è«‹è¼¸å…¥æ„è¦‹';
      html = `<label>${label}</label><textarea id="${tab.id}-open-0" placeholder="è«‹å¡«å¯«"></textarea>`;
    } else {
      if (Array.isArray(tab.likertTexts)) {
        const rows = tab.likertTexts.map((text,i)=>{
          const n=i+1, name=`${tab.prefix}${n}`;
          const radios=[1,2,3,4,5].map(v=>`<td><input type="radio" name="${name}" value="${v}"></td>`).join('');
          return `<tr><td>${n}. ${text}</td>${radios}</tr>`;
        }).join('');
        html += `<table><tr><th>é¡Œç›®</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>${rows}</table>`;
      }
      if (Array.isArray(tab.opens)) {
        html += tab.opens.map((t,i)=>`<label>${t}</label><textarea id="${tab.id}-open-${i}" placeholder="è«‹å¡«å¯«"></textarea>`).join('');
      }
      if (Array.isArray(tab.extras)) {
        html += tab.extras.map(ex=>{
          if (ex.type === 'select') {
            const opts = (ex.options||[]).map(o=>{
              const sel = (o.value === ex.default) ? ' selected' : '';
              return `<option value="${o.value}"${sel}>${o.label}</option>`;
            }).join('');
            return `<label>${ex.label}${ex.required?'ï¼ˆå¿…å¡«ï¼‰':''}</label><select id="${tab.id}-extra-${ex.key}">${opts}</select>`;
          } else {
            const ph = ex.label + (ex.required?'ï¼ˆå¿…å¡«ï¼‰':'');
            const val = ex.default ? ` value="${ex.default}"` : '';
            return `<label>${ex.label}${ex.required?'ï¼ˆå¿…å¡«ï¼‰':''}</label><input id="${tab.id}-extra-${ex.key}" type="text" placeholder="${ph}"${val}>`;
          }
        }).join('');
      }
    }

    let host = sec.querySelector('.form-host');
    if(!host){
      host = document.createElement('div');
      host.className='form-host';
      const btns=sec.querySelector('.btns');
      sec.insertBefore(host, btns||null);
    }
    host.innerHTML = html;

    // ç¶å®šä¸»è¦é€å‡º
    const btn = sec.querySelector('.btns .primary');
    if(btn){ btn.onclick = ()=> submitByKind(tab.kind); }    
  });
}
  
/* ===== [07] è®€å€¼/é©—è­‰/é€å‡º ===== */
function readLikert(prefix, count){
  const out = [];
  for(let i=1;i<=count;i++){
    const r = document.querySelector(`input[name='${prefix}${i}']:checked`);
    out.push(r ? Number(r.value) : null);
  }
  return out;
}
function buildPayload(tab){
  const base = { module:tab.kind, employeeId:profile.employeeId, fullName:profile.fullName, dept:profile.dept, date:profile.date, ts:Date.now() };
  if (tab.kind === 'messages') {
    const body = (document.getElementById(`${tab.id}-open-0`)?.value || '').trim();
    return { ...base, body };
  }
  const scores = Array.isArray(tab.likertTexts) ? readLikert(tab.prefix, tab.likertTexts.length) : [];
  const opens  = Array.isArray(tab.opens) ? tab.opens.map((_,i)=> (document.getElementById(`${tab.id}-open-${i}`)?.value||'').trim()) : [];
  const extras = {};
  if (Array.isArray(tab.extras)) {
    tab.extras.forEach(ex=>{
      const v = document.getElementById(`${tab.id}-extra-${ex.key}`)?.value || '';
      extras[ex.key] = v.trim();
    });
  }
  if (tab.kind === 'grow360') {
    if (!extras.role) extras.role = 'self';
    if (!extras.rateeId && profile?.employeeId) extras.rateeId = profile.employeeId;
  }
  if (tab.kind === 'course') {
    const c = window.__COURSE__ || {};
    extras.courseId    = extras.courseId    || c.id    || '';
    extras.courseTitle = extras.courseTitle || c.title || '';
  }
if (tab.kind === 'grow360') {
  if (!extras.role) extras.role = 'self';

  const pick = document.getElementById('g360RateeSelect');
  const pickVal = pick ? String(pick.value||'').trim().toUpperCase() : '';

  const filter = document.getElementById('g360RateeFilter');
  const typed  = filter ? String(filter.value||'').trim().toUpperCase() : '';

  if (extras.role === 'self') {
    extras.rateeId = profile.employeeId || pickVal || typed || extras.rateeId || '';
  } else {
    extras.rateeId = pickVal || typed || extras.rateeId || '';
  }
}
   return { ...base, scores, opens, extras };
}
function validateTab(tab){
  if (typeof readBasic === 'function') readBasic();
  if(!profile?.employeeId){ toast('è«‹å…ˆæ–¼ã€ŒåŸºæœ¬è³‡è¨Šã€å¡«å¯«å“¡å·¥ç·¨è™Ÿ'); switchTab(0); return false; }
  if (tab.kind === 'messages') {
    const body = (document.getElementById(`${tab.id}-open-0`)?.value || '').trim();
    if(!body){ toast('è«‹è¼¸å…¥æ„è¦‹å…§å®¹'); return false; }
    return true;
  }
  if (Array.isArray(tab.likertTexts)) {
    const vals = readLikert(tab.prefix, tab.likertTexts.length);
    const miss = vals.map((v,i)=> v==null ? (i+1) : null).filter(Boolean);
    if(miss.length){ toast(`è«‹å®Œæˆç¬¬ ${miss.join(', ')} é¡Œ`); return false; }
  }
  if (Array.isArray(tab.extras)) {
    for (const ex of tab.extras) {
      if (!ex.required) continue;
      let v = document.getElementById(`${tab.id}-extra-${ex.key}`)?.value?.trim() || '';
      if (tab.kind === 'grow360' && ex.key === 'rateeId' && !v && profile?.employeeId) {
        v = profile.employeeId;
        const el = document.getElementById(`${tab.id}-extra-${ex.key}`); if (el) el.value = v;
      }
      if (!v) { toast(`${ex.label} ç‚ºå¿…å¡«`); return false; }
    }
  }
if (tab.kind === 'grow360') {
  const role = document.getElementById(`${tab.id}-extra-role`)?.value || 'self';
  const pickVal = document.getElementById('g360RateeSelect')?.value || '';
  if (role !== 'self' && !pickVal) {
    toast('è«‹å…ˆå¾ä¸‹æ‹‰é¸å–®é¸æ“‡ã€Œè©•ä¼°å°è±¡ã€');
    return false;
  }
}
  return true;
}
async function submitByKind(kind, opts={}) {
  const tab = FORM_CONFIG.tabs.find(t=> t.kind===kind);
  if(!tab) return;
  if(!validateTab(tab)) return;

  const payload = buildPayload(tab);
  const btn = document.querySelector(`#${tab.id} .btns .primary`);
  const old = btn?.textContent;

  if (btn) { btn.disabled = true; btn.textContent = 'å‚³é€ä¸­â€¦'; }

  try {
    await submitToGAS(payload);
    toast(`${tab.name} å·²é€å‡º`);

    if (tab.kind === 'grow360') {
      // âœ… åœç•™åœ¨æœ¬é ï¼›æ¸…ç©ºé¡Œç›®èˆ‡é–‹æ”¾é¡Œï¼›ä¿ç•™è§’è‰²
      // è§’è‰²â‰ self æ™‚ï¼ŒåŒæ­¥æ¸…ç©ºè©•ä¼°å°è±¡ï¼ˆä¸‹æ‹‰èˆ‡è¼¸å…¥æ¡†ï¼‰ï¼Œè®“ä½ èƒ½ç›´æ¥é¸ä¸‹ä¸€ä½
      resetGrow360FormFields({ clearRatee: true });

      if (btn) { btn.disabled = false; btn.textContent = old || 'é€å‡ºæ­¤è©•ä¼°'; }
      return; // ä¸è·³é 
    }

    // å…¶ä»–æ¨¡çµ„ç¶­æŒé€å‡ºå¾Œå›åŸºæœ¬è³‡è¨Š
    if (btn) { btn.textContent = 'âœ” å·²é€å‡º'; }
    switchTab(0);

  } catch (e) {
    console.error(e);
    if (btn) { btn.disabled = false; btn.textContent = old || 'é€å‡ºæ­¤è©•ä¼°'; }
    toast('é€å‡ºå¤±æ•—ï¼š' + e.message);
  }
}

// æ¸…ç©º grow360 çš„ 1) å–®é¸é¡Œ 2) é–‹æ”¾é¡Œï¼ˆä¿ç•™åŸºæœ¬è³‡æ–™èˆ‡è§’è‰²ã€è©•ä¼°å°è±¡ï¼‰
function resetGrow360FormFields(opts = {}) {
  const { clearRatee = false } = opts;
  const tab = FORM_CONFIG.tabs.find(t=> t.kind==='grow360');
  if (!tab) return;
  const sec = document.getElementById(tab.id);
  if (!sec) return;

  // 1) æ¸…ç©º 5 é»é‡è¡¨
  if (Array.isArray(tab.likertTexts)) {
    for (let i=1; i<=tab.likertTexts.length; i++){
      const n = `${tab.prefix}${i}`;
      sec.querySelectorAll(`input[name='${n}']`).forEach(x=> x.checked = false);
    }
  }

  // 2) æ¸…ç©ºé–‹æ”¾é¡Œ
  if (Array.isArray(tab.opens)) {
    tab.opens.forEach((_,i)=>{
      const ta = sec.querySelector(`#${tab.id}-open-${i}`);
      if (ta) ta.value = '';
    });
  }

  // 3) è§’è‰²ä¿ç•™ï¼›å¿…è¦æ™‚æ¸…ç©ºè©•ä¼°å°è±¡ï¼ˆåƒ…ç•¶è§’è‰²â‰ selfï¼‰
  if (clearRatee) {
    const roleSel = document.getElementById(`${tab.id}-extra-role`);
    const isSelf  = (roleSel?.value || 'self') === 'self';
    if (!isSelf) {
      const sel = sec.querySelector('#g360RateeSelect');
      const filter = sec.querySelector('#g360RateeFilter');
      if (sel) sel.value = '';
      if (filter) filter.value = '';
    }
  }
}

// ========== [08] åŸºæœ¬è³‡è¨Šï¼å³æ™‚å°ç…§åå–®ï¼ˆåŠ å¼·ç‰ˆï¼‰ ==========
function readBasic(){
  profile.employeeId = document.getElementById('employeeId')?.value?.trim() || profile.employeeId;
  profile.fullName   = document.getElementById('fullName')?.value?.trim()   || profile.fullName;
  profile.dept       = document.getElementById('dept')?.value?.trim()       || profile.dept;
  profile.date       = document.getElementById('date')?.value               || profile.date;
  const badge = document.getElementById('userIdBadge');
  if (badge) badge.textContent = profile.employeeId || 'æœªè¨­å®š';
}

// å°å·¥å…·ï¼šç°¡å–® debounce
function debounce(fn, wait){
  let t;
  return (...args)=>{ clearTimeout(t); t = setTimeout(()=> fn.apply(null,args), wait); };
}

// åªåœ¨ã€Œå‰›å¥½ä¸€å€‹æ¬„ä½æœ‰å€¼ã€æ™‚æŸ¥ï¼›åŠ å…¥å»é‡ / å†·å»ï¼Œä¸¦é¿å… CORS é æª¢
async function resolveEmployeeInstant(source){
  const idEl = document.getElementById('employeeId');
  const nmEl = document.getElementById('fullName');
  if (!idEl || !nmEl) return;

  // å›å¡«ä¸­å°±ä¸è§¸ç™¼
  if (resolveEmployeeInstant._filling) return;

  // å†·å»æœŸï¼ˆä¹‹å‰å¤±æ•—éï¼Œå…ˆæš«åœè‡ªå‹•æŸ¥ï¼‰
  if (resolveEmployeeInstant._cooldownUntil && Date.now() < resolveEmployeeInstant._cooldownUntil) return;

  const employeeId = (idEl.value || '').trim();
  const fullName   = (nmEl.value || '').trim();

  // XORï¼šå‰›å¥½ä¸€å€‹æœ‰å€¼æ‰æŸ¥
  const hasId   = !!employeeId;
  const hasName = !!fullName;
  if (hasId === hasName) return;

  // åŒæ¨£è¼¸å…¥é‡è¤‡å°±ä¸å†é€
  const sig = employeeId + '|' + fullName;
  if (resolveEmployeeInstant._lastSig === sig) return;
  resolveEmployeeInstant._lastSig = sig;

  const endpoint = getEndpoint && getEndpoint();
  if (!endpoint){
    console.warn('[resolveEmployeeInstant] endpoint æœªè¨­å®š');
    return;
  }

  try{
    // é‡è¦ï¼šä¸è¦è¨­ Content-Typeï¼Œé¿å…ç€è¦½å™¨é€ OPTIONS é æª¢
    const res = await fetch(endpoint, {
      method:'POST',
      body: JSON.stringify({ action:'resolveEmployee', employeeId, fullName }),
      mode:'cors',
      cache:'no-store',
      redirect:'follow'
    });

    const data = await res.json().catch(()=> ({}));

    if (data?.ok && data.match){
      resolveEmployeeInstant._filling = true;
      idEl.value = data.match.employeeId || '';
      nmEl.value = data.match.fullName   || '';
      const d = document.getElementById('dept');
      if (d) d.value = data.match.dept || '';
      readBasic();
      setTimeout(()=>{ resolveEmployeeInstant._filling = false; }, 0);
    } else if (data?.error === 'AMBIGUOUS_NAME'){
      throttleToast('å§“åé‡è¤‡ï¼Œè«‹æ”¹å¡«ã€Œå“¡å·¥ç·¨è™Ÿã€ã€‚');
    } else if (data?.error === 'EMP_NOT_FOUND'){
      throttleToast('æ‰¾ä¸åˆ°é€™ä½å“¡å·¥ï¼Œè«‹ç¢ºèªå“¡å·¥ç·¨è™Ÿæˆ–å§“åã€‚');
    } else {
      throttleToast('æŸ¥è©¢å¤±æ•—ï¼ˆä¼ºæœå™¨å›å‚³ç•°å¸¸ï¼‰ã€‚');
    }
  } catch(e){
    console.error(e);
    // å¤±æ•—é€²å…¥ 10 ç§’å†·å»æœŸï¼Œé¿å…ç‹‚æ‰“ & ç‹‚è·³
    resolveEmployeeInstant._cooldownUntil = Date.now() + 10000;
    throttleToast('æŸ¥è©¢å¤±æ•—ï¼š' + (e.message || e));
  }
}

// 10 ç§’å…§ç›¸åŒå‹æ…‹çš„æç¤ºåªé¡¯ç¤ºä¸€æ¬¡
function throttleToast(msg){
  const now = Date.now();
  if (!throttleToast._muteUntil || now > throttleToast._muteUntil){
    toast(msg);
    throttleToast._muteUntil = now + 10000;
  }
}

function bindInstantResolve(){
  const idEl = document.getElementById('employeeId');
  const nmEl = document.getElementById('fullName');
  if (!idEl || !nmEl) return;

  const fireId   = ()=> resolveEmployeeInstant('id');
  const fireName = ()=> resolveEmployeeInstant('name');
  const debId    = debounce(fireId, 600);
  const debName  = debounce(fireName, 600);

  // è§¸ç™¼æ¢ä»¶ï¼šblurã€changeã€æŒ‰ Enterã€åœç­† 600ms
  idEl.addEventListener('blur', fireId);
  nmEl.addEventListener('blur', fireName);

  idEl.addEventListener('change', fireId);
  nmEl.addEventListener('change', fireName);

  idEl.addEventListener('keyup', (e)=> { if (e.key === 'Enter') fireId(); else debId(); });
  nmEl.addEventListener('keyup', (e)=> { if (e.key === 'Enter') fireName(); else debName(); });

  // åˆå§‹è¼‰å…¥æ™‚ä¹ŸåŒæ­¥ä¸€æ¬¡ badge
  readBasic();
}

// ä¸€éµæ¸…é™¤ï¼ˆå¯é¸ï¼‰
function clearIdentity(){
  const idEl = document.getElementById('employeeId');
  const nmEl = document.getElementById('fullName');
  const dEl  = document.getElementById('dept');
  resolveEmployeeInstant._filling = true;
  if (idEl) idEl.value = '';
  if (nmEl) nmEl.value = '';
  if (dEl)  dEl.value  = '';
  resolveEmployeeInstant._filling = false;
  readBasic();
}

// === è®€åå†Šï¼Œå›å‚³ [{employeeId, fullName, dept}, ...] ===
async function fetchRoster(){
  const url = `${getEndpoint()}?action=roster&key=${encodeURIComponent(ADMIN_SECRET)}&t=${Date.now()}`;
  try {
    const res  = await fetch(url, { cache:'no-store', mode:'cors' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    if (!data?.ok || !Array.isArray(data.items)) throw new Error('invalid payload');

    // å¾Œç«¯æ¬„ä½å¯èƒ½æ˜¯ employee_id / name / departmentï¼Œé€™è£¡åšä¸€æ¬¡æ˜ å°„
    const mapped = data.items.map(r => ({
      employeeId: r.employeeId || r.employee_id || r.id || '',
      fullName:   r.fullName   || r.name       || r.full_name || '',
      dept:       r.dept       || r.department || r.unit      || ''
    })).filter(p => p.employeeId || p.fullName);

    window.__ROSTER__ = mapped;     // å¿«å–
    return mapped;
  } catch (e) {
    console.warn('fetchRoster() å¤±æ•—ï¼š', e);
    toast('åå†Šè®€å–å¤±æ•—ï¼Œæš«ç”¨å¿«å–æˆ–æ‰‹å‹•è¼¸å…¥');
    return Array.isArray(window.__ROSTER__) ? window.__ROSTER__ : [];
  }
}

// === åœ¨ grow360 è¡¨å–®é ‚ç«¯æ’å…¥ã€Œè©•ä¼°å°è±¡ã€ä¸‹æ‹‰ + æœå°‹ï¼ˆä¸é–æ§åˆ¶é …ï¼‰ ===
async function ensureGrow360RateePicker(){
  const tab = FORM_CONFIG.tabs.find(t=> t.kind==='grow360');
  if (!tab) return;
  const sec = document.getElementById(tab.id);
  if (!sec) return;

  // å·²å»ºç«‹å°±ä¸é‡è¤‡
  if (sec.querySelector('.g360-ratee-picker')) return;

  const host = sec.querySelector('.form-host');
  if (!host) return;

  const box = document.createElement('div');
  box.className = 'g360-ratee-picker';
  box.style.marginBottom = '12px';
  box.innerHTML = `
    <label>è©•ä¼°å°è±¡ï¼ˆå¾åå†Šé¸ï¼‰</label>
    <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center">
      <input id="g360RateeFilter" type="text" placeholder="è¼¸å…¥å§“åæˆ–å“¡ç·¨å¿«é€Ÿç¯©é¸â€¦" />
      <button id="g360ReloadRoster" type="button">é‡æ–°è¼‰å…¥åå†Š</button>
    </div>
    <select id="g360RateeSelect" style="margin-top:8px">
      <option value="">è«‹é¸æ“‡è¦è©•ä¼°çš„å°è±¡</option>
    </select>
    <div class="muted" style="margin-top:4px">
      å°æé†’ï¼šè‹¥ã€Œè§’è‰²ã€é¸è‡ªè©•ï¼Œç³»çµ±æœƒå¿½ç•¥é€™å€‹é¸æ“‡ä¸¦ä»¥ä½ çš„å“¡ç·¨ç‚ºå°è±¡ã€‚
    </div>
  `;
  host.prepend(box);

  // åå†Šè¼‰å…¥èˆ‡æ¸²æŸ“ï¼ˆâœ… åªå®£å‘Šä¸€æ¬¡ï¼‰
  let roster = await fetchRoster();
  const sel     = box.querySelector('#g360RateeSelect');
  const filter  = box.querySelector('#g360RateeFilter');
  const reload  = box.querySelector('#g360ReloadRoster');

  function renderOptions(keyword=''){
    const kw = String(keyword||'').trim();
    const kwLower = kw.toLowerCase();

    const items = (roster||[]).filter(p =>
      !kwLower ||
      (p.employeeId||'').toLowerCase().includes(kwLower) ||
      (p.fullName||'').toLowerCase().includes(kwLower)
    );

    const opts = [`<option value="">è«‹é¸æ“‡è¦è©•ä¼°çš„å°è±¡</option>`]
      .concat(items.map(p =>
        `<option value="${p.employeeId}">${p.employeeId}ï½œ${p.fullName}${p.dept?`ï¼ˆ${p.dept}ï¼‰`:''}</option>`));

    // æ²’å‘½ä¸­ä»»ä½•äºº â†’ æä¾›ã€Œç›´æ¥ä½¿ç”¨ä½ çš„è¼¸å…¥ã€çš„è‡¨æ™‚é¸é …
    if (kw && items.length === 0){
      opts.push(`<option value="${kw}">ä½¿ç”¨ã€Œ${kw}ã€ï¼ˆæœªåœ¨åå†Šï¼‰</option>`);
    }

    sel.innerHTML = opts.join('');

    // ç²¾æº–å“¡ç·¨å‘½ä¸­å°±è‡ªå‹•é¸
    const exact = (roster||[]).find(p => (p.employeeId||'').toUpperCase() === kw.toUpperCase());
    if (exact) sel.value = exact.employeeId;
  }

  renderOptions('');

  // å³æ™‚ç¯©é¸ï¼‹Enter å¼·åˆ¶å¥—ç”¨
  filter.addEventListener('input', ()=> renderOptions(filter.value));
  filter.addEventListener('keyup', (e)=>{
    if (e.key === 'Enter'){
      renderOptions(filter.value);
      if (!sel.value && filter.value.trim()){
        sel.value = filter.value.trim();
      }
    }
  });

  // é‡æ–°è¼‰å…¥åå†Š
  reload.addEventListener('click', async ()=>{
    reload.disabled = true;
    reload.textContent = 'è¼‰å…¥ä¸­â€¦';
    const before = Array.isArray(roster) ? roster.length : 0;
    roster = await fetchRoster();
    renderOptions(filter.value);
    const after = Array.isArray(roster) ? roster.length : 0;
    toast(`åå†Šå·²æ›´æ–°ï¼ˆ${before} â†’ ${after}ï¼‰`);
    reload.textContent = 'é‡æ–°è¼‰å…¥åå†Š';
    reload.disabled = false;
  });

  // UXï¼šå¦‚æœç›®å‰è§’è‰²æ˜¯ selfï¼Œä½†ä½¿ç”¨è€…å»é»é¸è©•ä¼°å°è±¡è¼¸å…¥/ä¸‹æ‹‰ï¼Œå°±æŠŠè§’è‰²åˆ‡åˆ° peer æ–¹ä¾¿å¡«å¤–è©•
  const roleSel = document.getElementById(`${tab.id}-extra-role`);
  function ensureNonSelfWhenTyping(){
    if (!roleSel) return;
    if (roleSel.value === 'self') roleSel.value = 'peer';
  }
  filter.addEventListener('focus', ensureNonSelfWhenTyping);
  sel.addEventListener('focus', ensureNonSelfWhenTyping);

  // åˆå§‹æ™‚è‹¥æœ‰è‡ªå·±çš„å“¡ç·¨ï¼Œå¹«å¿™é æ¸²æŸ“ä¸€æ¬¡ï¼ˆåªæ˜¯è®“åˆ—è¡¨é è¿‘è©²å“¡ï¼‰
  if (profile?.employeeId) renderOptions(profile.employeeId);
}

/* ===== [09] åŒ¿ååœ–è¡¨ ===== */
async function fetchAnalytics(names){
  const endpoint = getEndpoint();
  const url = `${endpoint}?action=analytics&names=${encodeURIComponent(names.join(','))}&key=${encodeURIComponent(ADMIN_SECRET)}&t=${Date.now()}`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data?.ok) throw new Error('analytics API å¤±æ•—');
  return data.items || {};
}
function drawLine(canvasId, labels, values, label){
  const el = document.getElementById(canvasId); if (!el) return;
  if (el._chart) el._chart.destroy();
  el._chart = new Chart(el, {
    type:'line',
    data:{ labels, datasets:[{ label, data: values }] },
    options:{ responsive:true, scales:{ y:{ suggestedMin:1, suggestedMax:5 } } }
  });
}
function drawBar(canvasId, labels, values, label){
  const el = document.getElementById(canvasId); if (!el) return;
  if (el._chart) el._chart.destroy();
  el._chart = new Chart(el, {
    type:'bar',
    data:{ labels, datasets:[{ label, data: values }] },
    options:{ responsive:true, scales:{ y:{ suggestedMin:1, suggestedMax:5 } } }
  });
}
async function renderAdminCharts(){
  const panel = document.getElementById('adminPanel');
  if (!panel) return;
  try{
    const names = ['weekly_compare','stats_skill','stats_course','stats_locate'];
    const items = await fetchAnalytics(names);

    // â‘  å„èª²ç¨‹æ•´é«”æ»¿æ„åº¦ï¼ˆQ1~Q3 å¹³å‡ï¼‰
    const csAll = items.stats_course || [];
    const byCourse = {};
    csAll.forEach(r=>{
      const q = String(r.question || r['question'] || '').toUpperCase();
      if (!/^Q[1-3]$/.test(q)) return;
      const cid = String(r.courseId||'').trim();
      const title = String(r.courseTitle||'').trim();
      const avg = Number(r.avg || r['avg'] || r['å¹³å‡ avg'] || 0);
      if (!cid) return;
      if (!byCourse[cid]) byCourse[cid] = { title, sum:0, n:0 };
      byCourse[cid].sum += avg; byCourse[cid].n += 1;
    });
    const courseRows = Object.entries(byCourse).map(([cid, v])=>({ id:cid, title:v.title, avg:+(v.sum/(v.n||1)).toFixed(2) }))
      .sort((a,b)=> b.avg - a.avg);
    drawBar('chartCourseOverall',
      courseRows.map(x=> `${x.id} ${x.title}`.trim()),
      courseRows.map(x=> x.avg),
      'å„èª²ç¨‹æ•´é«”æ»¿æ„åº¦ï¼ˆQ1~Q3 å¹³å‡ï¼‰'
    );

    // â‘¡ æ¯å‘¨å•å·æ•´é«”å¹³å‡ï¼ˆæŠŠ Q*_avg å¹³å‡ï¼‰
    const wk = items.weekly_compare || [];
    const qCols = wk.length ? Object.keys(wk[0]).filter(k=>/^Q\d+_avg$/.test(k)).sort((a,b)=>+a.slice(1)-+b.slice(1)) : [];
    const wkLabels = wk.map(r=> String(r.date||r['date']||''));
    const wkSeries = wk.map(r=>{
      if (!qCols.length) return 0;
      const sum = qCols.reduce((s,k)=> s + Number(r[k]||0), 0);
      return +(sum / qCols.length).toFixed(2);
    });
    drawLine('chartWeeklyTrend', wkLabels, wkSeries, 'æ¯å‘¨å•å·æ•´é«”å¹³å‡ï¼ˆæ¯æ—¥ï¼‰');

    // â‘¢ åˆæœŸ locate å„é¡Œå¹³å‡
    const loc = (items.stats_locate || []).filter(r=> r['é¡Œè™Ÿ question']);
    drawBar('chartLocateAvg',
      loc.map(r=> String(r['é¡Œè™Ÿ question'])),
      loc.map(r=> +Number(r['å¹³å‡ avg']||0).toFixed(2)),
      'åˆæœŸï¼ˆlocateï¼‰å„é¡Œå¹³å‡'
    );

    // â‘£ ä¸­æœŸ skill å„é¡Œå¹³å‡
    const sk = (items.stats_skill || []).filter(r=> r['é¡Œè™Ÿ question']);
    drawBar('chartSkillAvg',
      sk.map(r=> String(r['é¡Œè™Ÿ question'])),
      sk.map(r=> +Number(r['å¹³å‡ avg']||0).toFixed(2)),
      'ä¸­æœŸï¼ˆskillï¼‰å„é¡Œå¹³å‡'
    );

    panel.style.display = 'block';
  }catch(e){
    console.warn('renderAdminCharts() å¤±æ•—ï¼š', e);
    panel.style.display = 'block';
    document.getElementById('adminCharts')?.insertAdjacentHTML('afterbegin', `<div class="muted">ï¼ˆè¼‰å…¥åœ–è¡¨å¤±æ•—ï¼š${(e.message||e)}ï¼‰</div>`);
  }
}

/* ===== [10] Admin è§£é– ===== */
function bindAdminUnlock(){
  const unlockBtn  = document.getElementById('adminUnlock');
  const keyInput   = document.getElementById('adminKey');
  const adminPanel = document.getElementById('adminPanel');
  if (!unlockBtn || !keyInput || !adminPanel) return;

  adminPanel.style.display = 'none';

  const wasUnlocked = sessionStorage.getItem('admin_unlocked') === '1';
  if (wasUnlocked) { adminPanel.style.display = 'block'; renderAdminCharts(); }

  unlockBtn.addEventListener('click', ()=>{
    const key = (keyInput.value || '').trim();
    if (key !== ADMIN_SECRET){ alert('é‡‘é‘°éŒ¯èª¤'); return; }
    sessionStorage.setItem('admin_unlocked','1');
    adminPanel.style.display = 'block';
    alert('å·²è§£é–ç®¡ç†åŠŸèƒ½');
    renderAdminCharts();
    // é‡æ–°æ¸²æŸ“ tabsï¼Œæ’å› Admin
    renderTabs(); applyHash();
  });
}

/* ===== [11] èª²å ‚ï¼šURL é é¸ ===== */
function applyCourseFromQuery(){
  const q = getQuery();
  if ((q.module||'').toLowerCase() !== 'course') return;
  window.__COURSE__ = { id: (q.courseId || q.id || ''), title: (q.title || '') };

  const hdr = document.getElementById('courseHeader');
  if (hdr){
    const txt = [window.__COURSE__?.id, window.__COURSE__?.title].filter(Boolean).join('ï½œ');
    hdr.textContent = txt ? `ï¼ˆ${txt}ï¼‰` : 'ï¼ˆæœªæŒ‡å®šèª²ç¨‹ï¼‰';
  }
  const picker = document.getElementById('coursePicker');
  if (picker && (window.__COURSE__?.id || window.__COURSE__?.title)) picker.style.display = 'none';

  const idx = (FORM_CONFIG.tabs || []).findIndex(t=> t.kind==='course');
  if (idx >= 0) switchTab(idx);
}

/* ===== [12] èª²ç¨‹æ¸…å–®è£œå¡« ===== */
async function loadCourseListForMakeup(){
  const q = getQuery();
  const hasPreset = (q.module||'').toLowerCase()==='course' && (q.id || q.courseId || q.title);
  if (hasPreset) return;

  const picker   = document.getElementById('coursePicker');
  const selectEl = document.getElementById('courseSelect');
  if (!picker || !selectEl) return;

  picker.style.display = 'grid';

  try{
    const url = `${getEndpoint()}?action=courselist&t=${Date.now()}`;
    const res = await fetch(url);
    const data = await res.json();

    if (!data?.ok || !Array.isArray(data.items) || data.items.length === 0){
      selectEl.innerHTML = '<option value="">ï¼ˆç›®å‰æ²’æœ‰å¯é¸èª²ç¨‹ï¼Œè«‹åœ¨è©¦ç®—è¡¨ courselist æ–°å¢ï¼‰</option>';
      return;
    }

    const frag = document.createDocumentFragment();
    const ph = document.createElement('option'); ph.value=''; ph.textContent='è«‹é¸æ“‡èª²ç¨‹'; frag.appendChild(ph);

    data.items.forEach(({id, title, instructor})=>{
      const opt = document.createElement('option');
      opt.value = id;
      opt.dataset.title = title || '';
      opt.textContent = instructor ? `${id}ï½œ${title}ï¼ˆ${instructor}ï¼‰` : `${id}ï½œ${title}`;
      frag.appendChild(opt);
    });

    selectEl.innerHTML = '';
    selectEl.appendChild(frag);

    selectEl.onchange = ()=>{
      const opt = selectEl.options[selectEl.selectedIndex];
      const id = selectEl.value || '';
      const title = opt?.dataset?.title || '';
      window.__COURSE__ = { id, title };
      const hdr = document.getElementById('courseHeader');
      if (hdr) hdr.textContent = id ? `ï¼ˆ${id}ï½œ${title}ï¼‰` : '';
    };
  }catch(e){
    console.warn('è¼‰å…¥èª²ç¨‹æ¸…å–®å¤±æ•—ï¼š', e);
    selectEl.innerHTML = '<option value="">ï¼ˆæ¸…å–®è¼‰å…¥å¤±æ•—ï¼Œç¨å¾Œå†è©¦ï¼‰</option>';
  }
}

/* ========== [13] åˆå§‹åŒ– ========== */
function init(){
  renderTabs();
  (FORM_CONFIG.tabs||[]).forEach((t,i)=>{
    const el = document.getElementById(t.id);
    if (el) el.style.display = (i===0 ? 'block' : 'none');
  });
  renderAllForms();
  applyHash();
  window.addEventListener('hashchange', applyHash);

  // æœ¬åœ°æ™‚å€å®‰å…¨çš„ã€Œå¡«å…¥ä»Šå¤©ã€
function fillTodayLocalISO(){
  const now = new Date();
  const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
  return local.toISOString().slice(0,10); // yyyy-mm-dd
}

document.getElementById('fillToday')?.addEventListener('click', ()=>{
  const el = document.getElementById('date');
  if (el) el.value = fillTodayLocalISO();
  if (typeof readBasic === 'function') readBasic();
});

document.getElementById('clearIdentityBtn')?.addEventListener('click', clearIdentity);  

}
  
  async function checkGASEndpoint(){
  try{
    const url = `${getEndpoint()}?action=ping&t=${Date.now()}`;
    const res = await fetch(url, { cache:'no-store', mode:'cors' });
    const data = await res.json();
    if (!data?.ok) throw new Error('ping not ok');
    return true;
  }catch(e){
    console.warn('GAS ç«¯é» ping å¤±æ•—ï¼š', e);
    // åœç”¨å³æ™‚æŸ¥è©¢ï¼Œé¿å…ä½¿ç”¨è€…æ¯æ‰“å­—å°±å‡ºéŒ¯
    resolveEmployeeInstant._cooldownUntil = Date.now() + 60_000; // 1 åˆ†é˜
    toast('å¾Œç«¯æš«æ™‚ç„¡æ³•é€£ç·šï¼Œå“¡ç·¨/å§“åè‡ªå‹•å°ç…§å·²æš«åœã€‚');
    return false;
  }
}

// è®“ã€Œç«‹å³å‰å¾€ã€æŒ‰éˆ•èƒ½åˆ‡æ›åˆ°å°æ‡‰åˆ†é 
function bindGuideJumpers(){
  document.querySelectorAll('[data-goto]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const targetId = btn.getAttribute('data-goto');
      // åœ¨ __TAB_SPECS æ‰¾å°æ‡‰ indexï¼ˆä»¥ tab.id æ¯”å°ï¼‰
      const specs = window.__TAB_SPECS || [];
      const idx = specs.findIndex(t => t.id === targetId);
      if (idx >= 0) {
        switchTab(idx);
        // æ²å‹•åˆ°é é¢é ‚éƒ¨ï¼Œè®“è¡¨å–®å¾é¡Œé¦–é–‹å§‹
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });
  });
}
  
document.addEventListener('DOMContentLoaded', async ()=>{
  init();
  bindGuideJumpers();           // â† æ–°å¢
  bindAdminUnlock();
  await checkGASEndpoint();       // â† å…ˆåšå¥åº·æª¢æŸ¥
  bindInstantResolve();           // å†ç¶è‡ªå‹•æŸ¥è©¢
  applyCourseFromQuery();
  loadCourseListForMakeup();
  await ensureGrow360RateePicker();   // â† æ–°å¢
});
  
</script>
</body>
</html>
