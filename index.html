<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>新進員工訓練回饋系統 | MONA Onboarding Feedback</title>
  <style>
    :root{--bg:#f8fafc;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--brand:#0ea5e9;--active:#dbeafe;--danger:#fecaca}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans CJK TC",sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.5px}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{border:1px solid #e5e7eb;background:#fff;color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
    .tab.active{border-color:var(--brand);box-shadow:0 0 0 1px inset var(--brand)}
    main{padding:24px}
    section.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:20px;margin:18px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input[type=text],input[type=date],input[type=email],select,textarea{width:100%;background:#fff;color:var(--text);border:1px solid #e5e7eb;border-radius:10px;padding:10px}
    textarea{min-height:88px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    button{border:1px solid #e5e7eb;background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button.primary{border-color:var(--brand);box-shadow:0 0 0 1px inset var(--brand)}
    .muted{color:var(--muted);font-size:12px}
    .toast{position:fixed;right:16px;bottom:16px;padding:10px 14px;background:#fff;border:1px solid #e5e7eb;border-radius:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{text-align:left;border-bottom:1px solid #e5e7eb;padding:6px}
    /* 單選選到高亮 */
    td:has(input[type=radio]:checked){background:var(--active)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h1>MONA Onboarding Feedback｜新進員工訓練回饋系統</h1>
        <span class="muted">使用者ID：<strong id="userIdBadge">未設定</strong></span>
      </div>
      <nav id="tabs" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"></nav>
    </div>
  </header>

  <main class="wrap">
    <!-- Tab 0: 基本資訊 -->
    <section id="tab-0" class="card">
      <h2>🔑 基本資訊</h2>
      <div class="row">
        <div>
          <label>使用者代號（employeeId）</label>
          <input id="employeeId" type="text" placeholder="例如：VHC-2025-001" />
        </div>
        <div>
          <label>姓名</label>
          <input id="fullName" type="text" placeholder="例如：王小明" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>單位 / 部門</label>
          <input id="dept" type="text" placeholder="例如：車輛課／軌土課／通號課" />
        </div>
        <div>
          <label>今天日期</label>
          <input id="date" type="date" />
          <div class="btns"><button id="fillToday" type="button">填入今天</button></div>
        </div>
      </div>
    </section>

    <!-- Tab 1: 初期訓練問卷 -->
    <section id="tab-1" class="card">
      <h2>🩵 初期訓練問卷</h2>
      <p>請針對以下五項指標進行評分（1分＝非常不同意，5分＝非常同意）：</p>
      <table>
        <tr><th>題目</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>
        <tr><td>1. 我清楚了解單位的運作方式與人員分工。</td><td><input type="radio" name="loc1" value="1"></td><td><input type="radio" name="loc1" value="2"></td><td><input type="radio" name="loc1" value="3"></td><td><input type="radio" name="loc1" value="4"></td><td><input type="radio" name="loc1" value="5"></td></tr>
        <tr><td>2. 我能掌握自身工作內容的重點與流程。</td><td><input type="radio" name="loc2" value="1"></td><td><input type="radio" name="loc2" value="2"></td><td><input type="radio" name="loc2" value="3"></td><td><input type="radio" name="loc2" value="4"></td><td><input type="radio" name="loc2" value="5"></td></tr>
        <tr><td>3. 我對目前的工作環境感到適應良好。</td><td><input type="radio" name="loc3" value="1"></td><td><input type="radio" name="loc3" value="2"></td><td><input type="radio" name="loc3" value="3"></td><td><input type="radio" name="loc3" value="4"></td><td><input type="radio" name="loc3" value="5"></td></tr>
        <tr><td>4. 我與同事之間的互動合作順利。</td><td><input type="radio" name="loc4" value="1"></td><td><input type="radio" name="loc4" value="2"></td><td><input type="radio" name="loc4" value="3"></td><td><input type="radio" name="loc4" value="4"></td><td><input type="radio" name="loc4" value="5"></td></tr>
        <tr><td>5. 我認為初期訓練的內容能幫助我順利進入工作狀態。</td><td><input type="radio" name="loc5" value="1"></td><td><input type="radio" name="loc5" value="2"></td><td><input type="radio" name="loc5" value="3"></td><td><input type="radio" name="loc5" value="4"></td><td><input type="radio" name="loc5" value="5"></td></tr>
      </table>
      <label>開放意見</label>
      <textarea id="locate-open" placeholder="請提供其他意見或建議"></textarea>
      <div class="btns"><button class="primary" id="submitLocate" type="button">送出定位問卷</button></div>
    </section>

    <!-- Tab 2: 中期技能課程回饋 -->
    <section id="tab-2" class="card">
      <h2>💡 中期技能課程回饋</h2>
      <p>請評估以下學習成效（1分＝非常不同意，5分＝非常同意）：</p>
      <table>
        <tr><th>題目</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>
        <tr><td>1. 技能課程的內容能應用於實際工作。</td><td><input type="radio" name="sk1" value="1"></td><td><input type="radio" name="sk1" value="2"></td><td><input type="radio" name="sk1" value="3"></td><td><input type="radio" name="sk1" value="4"></td><td><input type="radio" name="sk1" value="5"></td></tr>
        <tr><td>2. 教學方式能有效幫助我理解內容。</td><td><input type="radio" name="sk2" value="1"></td><td><input type="radio" name="sk2" value="2"></td><td><input type="radio" name="sk2" value="3"></td><td><input type="radio" name="sk2" value="4"></td><td><input type="radio" name="sk2" value="5"></td></tr>
        <tr><td>3. 我能熟練操作課程中學到的技能。</td><td><input type="radio" name="sk3" value="1"></td><td><input type="radio" name="sk3" value="2"></td><td><input type="radio" name="sk3" value="3"></td><td><input type="radio" name="sk3" value="4"></td><td><input type="radio" name="sk3" value="5"></td></tr>
        <tr><td>4. 課程時間與進度安排合理。</td><td><input type="radio" name="sk4" value="1"></td><td><input type="radio" name="sk4" value="2"></td><td><input type="radio" name="sk4" value="3"></td><td><input type="radio" name="sk4" value="4"></td><td><input type="radio" name="sk4" value="5"></td></tr>
        <tr><td>5. 我願意推薦此課程給其他同仁。</td><td><input type="radio" name="sk5" value="1"></td><td><input type="radio" name="sk5" value="2"></td><td><input type="radio" name="sk5" value="3"></td><td><input type="radio" name="sk5" value="4"></td><td><input type="radio" name="sk5" value="5"></td></tr>
      </table>
      <label>開放意見</label>
      <textarea id="skill-open" placeholder="請提供其他意見或建議"></textarea>
      <div class="btns"><button class="primary" id="submitSkill" type="button">送出技能問卷</button></div>
    </section>

    <!-- Tab 3: 後期360度評估 -->
    <section id="tab-3" class="card">
      <h2>🔶 後期360度評估</h2>
      <div class="row" style="margin-bottom:8px">
        <div>
          <label>360 角色</label>
          <select id="raterRole">
            <option value="self">自評</option>
            <option value="manager">直屬主管</option>
            <option value="peer">同儕</option>
            <option value="mentor">導師/教練</option>
          </select>
        </div>
        <div>
          <label>評估對象（employeeId）</label>
          <input id="rateeId" type="text" placeholder="若自評可留本人 ID" />
        </div>
      </div>
      <p>請針對受評者進行綜合評估（1分＝非常不同意，5分＝非常同意）：</p>
      <table>
        <tr><th>題目</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>
        <tr><td>1. 能與同事保持良好溝通與協作。</td><td><input type="radio" name="gr1" value="1"></td><td><input type="radio" name="gr1" value="2"></td><td><input type="radio" name="gr1" value="3"></td><td><input type="radio" name="gr1" value="4"></td><td><input type="radio" name="gr1" value="5"></td></tr>
        <tr><td>2. 工作態度積極且具責任感。</td><td><input type="radio" name="gr2" value="1"></td><td><input type="radio" name="gr2" value="2"></td><td><input type="radio" name="gr2" value="3"></td><td><input type="radio" name="gr2" value="4"></td><td><input type="radio" name="gr2" value="5"></td></tr>
        <tr><td>3. 能主動提出改善建議或解決問題。</td><td><input type="radio" name="gr3" value="1"></td><td><input type="radio" name="gr3" value="2"></td><td><input type="radio" name="gr3" value="3"></td><td><input type="radio" name="gr3" value="4"></td><td><input type="radio" name="gr3" value="5"></td></tr>
        <tr><td>4. 在壓力下仍能維持穩定表現。</td><td><input type="radio" name="gr4" value="1"></td><td><input type="radio" name="gr4" value="2"></td><td><input type="radio" name="gr4" value="3"></td><td><input type="radio" name="gr4" value="4"></td><td><input type="radio" name="gr4" value="5"></td></tr>
        <tr><td>5. 整體表現符合單位期望。</td><td><input type="radio" name="gr5" value="1"></td><td><input type="radio" name="gr5" value="2"></td><td><input type="radio" name="gr5" value="3"></td><td><input type="radio" name="gr5" value="4"></td><td><input type="radio" name="gr5" value="5"></td></tr>
      </table>
      <label>補充說明（質性意見）</label>
      <textarea id="grow-open" placeholder="請具體描述受評者的優勢表現、待改進之處或其他觀察"></textarea>
      <div class="btns"><button class="primary" id="submitGrow" type="button">送出 360 問卷</button></div>
    </section>
  </main>

    <!-- Tab 4: 意見反映 -->
    <section id="tab-4" class="card">
      <h2>💬 意見反映</h2>
      <div class="row">
        <div>
          <label>留言內容</label>
          <textarea id="msgBody" placeholder="遇到的困難或建議"></textarea>
        </div>
        <div>
          <label>是否匿名</label>
          <select id="msgAnon"><option value="yes">匿名</option><option value="no">署名</option></select>
          <div class="btns"><button class="primary" id="submitMsg" type="button">送出留言</button></div>
        </div>
      </div>
    </section>

    <!-- Tab 5: 管理設定（Admin） -->
    <section id="tab-5" class="card">
      <h2>🛠️ 管理設定（Admin）</h2>
      <p class="muted">輸入金鑰後可編輯 GAS URL；預設已設定為你的 /exec。</p>
      <div class="row">
        <div>
          <label>管理金鑰</label>
          <input id="adminKey" type="password" placeholder="輸入：MONAADMIN2025" />
          <div class="btns"><button id="adminUnlock" type="button">啟用編輯</button></div>
        </div>
        <div>
          <label>GAS Web App URL（/exec）</label>
          <input id="gas_url" type="text" value="https://script.google.com/macros/s/AKfycbylnQs-FaohoCe0wdEw_xQyhLNX0jq_Hcou3Ndxgfq1YdPcs4114PNTp64b619qUpGa/exec" readonly />
          <div class="btns"><button id="gasTestBtn" type="button">測試連線（PING）</button></div>
        </div>
      </div>
    </section>
  </main>

  <script>
  const ADMIN_KEY = 'MONAADMIN2025';
  let profile = {
    employeeId:'', fullName:'', dept:'', date:'',
    api:{ gasUrl:'https://script.google.com/macros/s/AKfycbylnQs-FaohoCe0wdEw_xQyhLNX0jq_Hcou3Ndxgfq1YdPcs4114PNTp64b619qUpGa/exec' }
  };

  function toast(msg){const el=document.createElement('div');el.className='toast';el.textContent=msg;document.body.appendChild(el);setTimeout(()=>el.remove(),2200);}  

  /* ===== Tabs ===== */
  function renderTabs(){
    const tabsHost = document.getElementById('tabs');
    const specs = [
      {id:'tab-0', name:'基本資訊'},
      {id:'tab-1', name:'初期訓練'},
      {id:'tab-2', name:'中期技能'},
      {id:'tab-3', name:'後期360'},
      {id:'tab-4', name:'意見反映'},
      {id:'tab-5', name:'管理設定'}
    ];
    window.__TAB_SPECS = specs;
    tabsHost.innerHTML = '';
    specs.forEach((t, i)=>{
      const btn = document.createElement('button');
      btn.className = 'tab'+(i===0?' active':'');
      btn.textContent = t.name;
      btn.addEventListener('click',()=>switchTab(i));
      tabsHost.appendChild(btn);
    });
  }
  function switchTab(index){
    const specs = window.__TAB_SPECS || [];
    const tabs = document.getElementById('tabs').children;
    for(let i=0;i<tabs.length;i++) tabs[i].classList.toggle('active', i===index);
    specs.forEach((t, i)=>{
      const sec = document.getElementById(t.id);
      if(!sec) return;
      if(i===index) sec.style.display='block'; else sec.style.display='none';
    });
    const names = ['basic','locate','skill','grow360','messages','admin'];
    const h = names[index] || 'basic';
    if(location.hash !== '#'+h) history.replaceState(null,'','#'+h);
  }
  function applyHash(){
    const map = { basic:0, locate:1, skill:2, grow360:3, messages:4, admin:5 };
    const key = (location.hash||'').replace('#','');
    switchTab(map[key] ?? 0);
  }

  /* ===== Basic ===== */
  function readBasic(){
    profile.employeeId = document.getElementById('employeeId').value.trim();
    profile.fullName = document.getElementById('fullName').value.trim();
    profile.dept = document.getElementById('dept').value.trim();
    const d = document.getElementById('date').value;
    profile.date = d || new Date().toISOString().slice(0,10);
    document.getElementById('userIdBadge').textContent = profile.employeeId || '未設定';
  }

  /* ===== Gather scores (table radios) ===== */
  function readGroup(prefix){
    const out = [];
    for(let i=1;i<=5;i++){
      const r = document.querySelector(`input[name='${prefix}${i}']:checked`);
      out.push(r? Number(r.value): null);
    }
    return out;
  }

  function validate(kind){
    readBasic();
    if(!profile.employeeId){ toast('請先於「基本資訊」填寫使用者代號'); switchTab(0); return false; }
    const groups = { locate:'loc', skill:'sk', grow360:'gr' };
    const g = groups[kind];
    const vals = readGroup(g);
    const miss = vals.map((v,i)=> v?null:i+1).filter(Boolean);
    if(miss.length){ toast(`請完成第 ${miss.join(', ')} 題`); return false; }
    if(kind==='grow360'){
  const payload = {
    ...base,
    module:'grow360',
    role: document.getElementById('raterRole').value,
    rateeId: (document.getElementById('rateeId').value.trim() || profile.employeeId),
    scores: gatherScale('grow', Q_GROW),
    open: document.getElementById('grow-open').value.trim()  // ★ 新增
  };
  const btn = document.getElementById('submitGrow');
  const old = btn.textContent;
  btn.disabled = true;
  btn.textContent = '傳送中…';
  try{
    const cfg = ensureAdmin('grow360');
    await submitToGoogle(cfg.url, cfg.entry, payload, cfg.name, cfg.unit);
    btn.textContent = '✔ 已送出';
    toast('啟發＋360 評估已寫入 Google 試算表');
    switchTab(0);
  }catch(err){
    console.error(err);
    btn.disabled = false;
    btn.textContent = old;
    toast('送出失敗，請檢查 Admin 設定或 GAS');
  }
  return;
  }

  /* ===== GAS（含容錯） ===== */
  function isLikelyGas(url){ return /^https:\/\/script\.google\.com\/macros\/s\//.test(url) && /\/exec(\?|$)/.test(url); }
  async function submitToGAS(payload){
    const gas = (document.getElementById('gas_url')?.value || profile.api.gasUrl || '').trim();
    if(!isLikelyGas(gas)) throw new Error('GAS URL 格式錯誤');

    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 20000); // 20s timeout，避免長掛

    try{
      const res = await fetch(gas + '?origin=' + encodeURIComponent(location.origin), {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'}, // 避免 CORS preflight
        body: JSON.stringify(payload),
        signal: controller.signal
      });
      clearTimeout(t);
      if(res.ok) return true;
      throw new Error('GAS 回應非 200');
    }catch(err){
      clearTimeout(t);
      console.warn('fetch 失敗，嘗試 fallback：', err);
      // Fallback 1: sendBeacon（最不易被擋，無回傳）
      try{
        if(navigator.sendBeacon){
          const ok = navigator.sendBeacon(
            gas + '?origin=' + encodeURIComponent(location.origin) + '&beacon=1',
            new Blob([JSON.stringify(payload)], {type:'text/plain;charset=utf-8'})
          );
          if(ok) return true;
        }
      }catch(_){/* ignore */}
      // Fallback 2: GET 帶 payload（僅適合小量資料）
      try{
        const url2 = gas + '?origin=' + encodeURIComponent(location.origin) + '&get=1&payload=' + encodeURIComponent(JSON.stringify(payload));
        const res2 = await fetch(url2, { method:'GET' });
        if(res2.ok) return true;
      }catch(_){/* ignore */}
      throw err;
    }
  }

  /* ===== Submit handlers ===== */
  async function submitLocate(){
    if(!validate('locate')) return;
    const payload = { module:'locate', employeeId:profile.employeeId, fullName:profile.fullName, dept:profile.dept, date:profile.date, ts:Date.now(), scores: readGroup('loc'), open: document.getElementById('locate-open').value.trim() };
    const btn = document.getElementById('submitLocate'); const old=btn.textContent; btn.disabled=true; btn.textContent='傳送中…';
    try{ await submitToGAS(payload); btn.textContent='✔ 已送出'; toast('定位問卷已送出'); switchTab(0); }catch(e){ console.error(e); btn.disabled=false; btn.textContent=old; toast('送出失敗，請檢查 GAS 部署或網路'); }
  }
  async function submitSkill(){
    if(!validate('skill')) return;
    const payload = { module:'skill', employeeId:profile.employeeId, fullName:profile.fullName, dept:profile.dept, date:profile.date, ts:Date.now(), scores: readGroup('sk'), open: document.getElementById('skill-open').value.trim(), quizScore:0, quizTotal:0 };
    const btn = document.getElementById('submitSkill'); const old=btn.textContent; btn.disabled=true; btn.textContent='傳送中…';
    try{ await submitToGAS(payload); btn.textContent='✔ 已送出'; toast('技能問卷已送出'); switchTab(0); }catch(e){ console.error(e); btn.disabled=false; btn.textContent=old; toast('送出失敗，請檢查 GAS 部署或網路'); }
  }
  async function submitGrow(){
    if(!validate('grow360')) return;
    const payload = { module:'grow360', employeeId:profile.employeeId, fullName:profile.fullName, dept:profile.dept, date:profile.date, ts:Date.now(), scores: readGroup('gr'), role: document.getElementById('raterRole').value, rateeId: (document.getElementById('rateeId').value.trim() || profile.employeeId), open: document.getElementById('grow-open').value.trim() };
    const btn = document.getElementById('submitGrow'); const old=btn.textContent; btn.disabled=true; btn.textContent='傳送中…';
    try{ await submitToGAS(payload); btn.textContent='✔ 已送出'; toast('360 問卷已送出'); switchTab(0); }catch(e){ console.error(e); btn.disabled=false; btn.textContent=old; toast('送出失敗，請檢查 GAS 部署或網路'); }
  }
  async function submitMsg(){
    readBasic(); if(!profile.employeeId){ toast('請先於「基本資訊」填寫使用者代號'); switchTab(0); return; }
    const body = document.getElementById('msgBody').value.trim(); if(!body){ toast('請輸入留言內容'); return; }
    const payload = { module:'messages', employeeId:(document.getElementById('msgAnon').value==='yes'?'匿名':profile.employeeId), fullName:profile.fullName, dept:profile.dept, date:profile.date, ts:Date.now(), body };
    const btn = document.getElementById('submitMsg'); const old=btn.textContent; btn.disabled=true; btn.textContent='傳送中…';
    try{ await submitToGAS(payload); btn.textContent='✔ 已送出'; document.getElementById('msgBody').value=''; toast('留言已送出'); switchTab(0); }catch(e){ console.error(e); btn.disabled=false; btn.textContent=old; toast('送出失敗，請檢查 GAS 部署或網路'); }
  }

  /* ===== Admin unlock & test ===== */
  function unlockAdmin(){
    const key = document.getElementById('adminKey').value.trim();
    if(key!=='MONAADMIN2025') return toast('金鑰錯誤');
    const input = document.getElementById('gas_url');
    input.removeAttribute('readonly');
    toast('已解鎖 GAS URL 可編輯');
  }
  async function testGas(){
    const url = document.getElementById('gas_url').value.trim();
    if(!isLikelyGas(url)) return toast('GAS URL 格式錯誤');
    try{ const r = await fetch(url,{method:'GET'}); toast(r.ok?'PING OK':'PING 失敗'); }catch(_){ toast('PING 失敗'); }
  }

  /* ===== Self tests（僅在 #test 啟動） ===== */
  function runSelfTests(){
    try{
      console.group('自動化檢查');
      console.assert(typeof submitToGAS === 'function','submitToGAS 存在');
      console.assert(document.getElementById('submitGrow'),'submitGrow 按鈕存在');
      console.assert(document.getElementById('grow-open'),'grow-open 欄位存在');
      console.assert(/exec$/.test(document.getElementById('gas_url').value),'GAS URL 看似正確');
      console.groupEnd();
    }catch(e){ console.warn('自動化檢查例外', e); }
  }

  /* ===== init ===== */
  function init(){
    renderTabs();
    ['tab-1','tab-2','tab-3','tab-4','tab-5'].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='none'; });
    applyHash();
    window.addEventListener('hashchange', applyHash);

    const today = new Date().toISOString().slice(0,10);
    document.getElementById('date').value = today;
    document.getElementById('fillToday').addEventListener('click', ()=>{ document.getElementById('date').value = new Date().toISOString().slice(0,10); readBasic(); });
    ['employeeId','fullName','dept','date'].forEach(id=> document.getElementById(id).addEventListener('input', readBasic));
    readBasic();

    document.getElementById('submitLocate').addEventListener('click', submitLocate);
    document.getElementById('submitSkill').addEventListener('click', submitSkill);
    document.getElementById('submitGrow').addEventListener('click', submitGrow);
    document.getElementById('submitMsg').addEventListener('click', submitMsg);
    document.getElementById('adminUnlock').addEventListener('click', unlockAdmin);
    document.getElementById('gasTestBtn').addEventListener('click', testGas);

    if(location.hash==="#test") runSelfTests();
  }
  init();
  </script>
</body>
</html>
