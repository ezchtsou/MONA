<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ–°é€²å“¡å·¥è¨“ç·´å›é¥‹ç³»çµ±</title>
  <style>
    :root{--bg:#f8fafc;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--brand:#0ea5e9;--active:#dbeafe;--danger:#fecaca}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans CJK TC",sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.5px}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{border:1px solid #e5e7eb;background:#fff;color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
    .tab.active{border-color:var(--brand);box-shadow:0 0 0 1px inset var(--brand)}
    main{padding:24px}
    section.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:20px;margin:18px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input[type=text],input[type=date],input[type=email],select,textarea{width:100%;background:#fff;color:var(--text);border:1px solid #e5e7eb;border-radius:10px;padding:10px}
    textarea{min-height:88px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    button{border:1px solid #e5e7eb;background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button.primary{border-color:var(--brand);box-shadow:0 0 0 1px inset var(--brand)}
    .muted{color:var(--muted);font-size:12px}
    .toast{position:fixed;right:16px;bottom:16px;padding:10px 14px;background:#fff;border:1px solid #e5e7eb;border-radius:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{text-align:left;border-bottom:1px solid #e5e7eb;padding:6px}
    /* é«˜äº®å·²é¸çš„å–®é¸æ¡†æ‰€åœ¨å„²å­˜æ ¼ï¼ˆç¾ä»£ç€è¦½å™¨æ”¯æ´ :hasï¼‰ */
    td:has(input[type=radio]:checked){background:var(--active)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h1>æ–°é€²å“¡å·¥è¨“ç·´å›é¥‹ç³»çµ±</h1>
        <span class="muted">ä½¿ç”¨è€…IDï¼š<strong id="userIdBadge">æœªè¨­å®š</strong></span>
      </div>
      <nav id="tabs" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"></nav>
    </div>
  </header>
  <main class="wrap">
    <section id="tab-0" class="card">
      <h2>ğŸ”‘ åŸºæœ¬è³‡è¨Š</h2>
      <div class="row">
        <div>
          <label>ä½¿ç”¨è€…ä»£è™Ÿï¼ˆemployeeIdï¼‰</label>
          <input id="employeeId" type="text" placeholder="ä¾‹å¦‚ï¼š9999M0000" />
        </div>
        <div>
          <label>å§“å</label>
          <input id="fullName" type="text" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>å–®ä½ / éƒ¨é–€</label>
          <input id="dept" type="text" placeholder="ä¾‹å¦‚ï¼šè»Šè¼›èª²ï¼è»ŒåœŸèª²ï¼é€šè™Ÿèª²" />
        </div>
        <div>
          <label>ä»Šå¤©æ—¥æœŸ</label>
          <input id="date" type="date" />
          <div class="btns"><button id="fillToday" type="button">å¡«å…¥ä»Šå¤©</button></div>
        </div>
      </div>
    </section>

 <section id="tab-7" class="card">
  <h2>ğŸ“˜ èª²å ‚å•å· <span id="courseHeader" class="muted"></span></h2>
  <div id="coursePicker" class="row" style="margin-bottom:12px; display:none">
    <div>
      <label>é¸æ“‡èª²ç¨‹ï¼ˆè£œå¡«ï¼‰</label>
      <select id="courseSelect"><option value="">è«‹é¸æ“‡èª²ç¨‹</option></select>
    </div>
  </div>
  <p class="muted">è«‹ä»¥äº”é»é‡è¡¨ä½œç­”ï¼ˆ1ï¼éå¸¸ä¸åŒæ„ï¼Œ5ï¼éå¸¸åŒæ„ï¼‰ã€‚</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">é€å‡ºèª²å ‚å•å·</button></div>
</section>
    
<!-- ğŸ—“ æ¯å‘¨å•å· -->
   <section id="tab-6" class="card">
  <h2>ğŸ—“ æ¯å‘¨å•å·</h2>
  <p>è«‹ä»¥äº”é»é‡è¡¨ä½œç­”ï¼ˆ1ï¼éå¸¸ä¸åŒæ„ï¼Œ5ï¼éå¸¸åŒæ„ï¼‰ï¼Œä¸¦å®Œæˆé–‹æ”¾é¡Œï¼š</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">é€å‡ºæ¯å‘¨å•å·</button></div>
</section>
    
   <section id="tab-1" class="card">
  <h2>ğŸ©µ åˆæœŸå•å·</h2>
  <p>è«‹é‡å°ä»¥ä¸‹æŒ‡æ¨™é€²è¡Œè©•åˆ†ï¼ˆ1ï¼éå¸¸ä¸åŒæ„ï¼Œ5ï¼éå¸¸åŒæ„ï¼‰ï¼š</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">é€å‡ºåˆæœŸå•å·</button></div>
</section>
    
    <section id="tab-2" class="card">
  <h2>ğŸ’¡ ä¸­æœŸèª²ç¨‹å›é¥‹</h2>
  <p>è«‹è©•ä¼°ä»¥ä¸‹å­¸ç¿’æˆæ•ˆï¼ˆ1ï¼éå¸¸ä¸åŒæ„ï¼Œ5ï¼éå¸¸åŒæ„ï¼‰ï¼š</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">é€å‡ºä¸­æœŸå•å·</button></div>
</section>

    <section id="tab-3" class="card">
  <h2>ğŸ”¶ å¾ŒæœŸäº”å€‹å‘åº¦è©•ä¼°</h2>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">é€å‡ºå¾ŒæœŸè©•ä¼°</button></div>
</section>

    <section id="tab-4" class="card">
  <h2>ğŸ’¬ æ„è¦‹åæ˜ </h2>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">é€å‡ºç•™è¨€</button></div>
</section>
    
    <section id="tab-5" class="card">
  <h2>ğŸ› ï¸ ç®¡ç†è¨­å®šï¼ˆAdminï¼‰</h2>
  <p class="muted">è¼¸å…¥ç®¡ç†é‡‘é‘°å¾Œå³å¯ç·¨è¼¯èˆ‡æ¸¬è©¦ GAS Web App URLã€‚</p>

  <div class="row">
    <div>
      <label>ç®¡ç†é‡‘é‘°</label>
      <input id="adminKey" type="password" placeholder="è«‹è¼¸å…¥é‡‘é‘°" />
      <div class="btns">
        <button id="adminUnlock" type="button">å•Ÿç”¨ç·¨è¼¯</button>
      </div>
    </div>

    <div>
      <label>GAS Web App URLï¼ˆ/execï¼‰</label>
      <input id="gas_url" type="text" readonly />
      <div class="btns">
        <button id="gasTestBtn" type="button">æ¸¬è©¦é€£ç·šï¼ˆPINGï¼‰</button>
      </div>
    </div>
  </div>
</section>
    
  </main>
  
<script>

function getQuery(){ try { return Object.fromEntries(new URL(location.href).searchParams.entries()); } catch { return {}; } }

function applyCourseFromQuery(){
  const q = getQuery();
  // æ”¯æ´ ?module=course&id=E102&title=åˆ—è»Šåˆ¶å‹•
  if ((q.module||'').toLowerCase() !== 'course') return;

  // å­˜åˆ°å…¨åŸŸï¼Œçµ¦é€å‡ºæ‰“åŒ…
  window.__COURSE__ = {
    id: q.courseId || q.id || '',
    title: q.title || ''
  };

  // é¡¯ç¤ºåœ¨é é¢æ¨™é¡Œä¸Š
  if (hdr){
    const txt = [window.__COURSE__?.id, window.__COURSE__?.title].filter(Boolean).join('ï½œ');
    hdr.textContent = txt ? `ï¼ˆ${txt}ï¼‰` : 'ï¼ˆæœªæŒ‡å®šèª²ç¨‹ï¼‰';
  }

  // â˜… è‹¥ URL å·²æœ‰é é¸èª²ç¨‹ â†’ éš±è—è£œç™»é¸å–®
  const picker = document.getElementById('coursePicker');
  if (picker && (window.__COURSE__?.id || window.__COURSE__?.title)) {
    picker.style.display = 'none';
  }
  const hdr = document.getElementById('courseHeader');
  if (hdr){
    const txt = [window.__COURSE__?.id, window.__COURSE__?.title].filter(Boolean).join('ï½œ');
    hdr.textContent = txt ? `ï¼ˆ${txt}ï¼‰` : 'ï¼ˆæœªæŒ‡å®šèª²ç¨‹ï¼‰';
  }

  // è‡ªå‹•åˆ‡åˆ°èª²å ‚å•å·åˆ†é ï¼ˆæ‰¾å‡º course tab çš„ç´¢å¼•ï¼‰
  const idx = (FORM_CONFIG.tabs || []).findIndex(t=> t.kind==='course');
  if (idx >= 0) switchTab(idx);
}

/***** 0) å…¬ç”¨ä¿åº•ï¼šprofile / toast / submitToGAS *****/
window.profile = window.profile || { employeeId:'', fullName:'', dept:'', date:(new Date()).toISOString().slice(0,10) };
window.toast = window.toast || (msg => alert(msg));

// ç”¨ POST æäº¤ï¼Œä¸è¨­ Content-Typeï¼ˆé¿å… CORS é æª¢ï¼‰ï¼Œä¸¦æä¾›æ›´æ¸…æ¥šçš„éŒ¯èª¤
async function submitToGAS(payload){
  const inputEl = document.getElementById('gas_url');
  const fromQS  = (location.search.match(/[?&]gas=([^&]+)/)||[])[1];
  const endpoint = window.GAS_ENDPOINT || fromQS || (inputEl && inputEl.value);
  if(!endpoint) throw new Error('æœªè¨­å®š GAS Web App URLï¼ˆå¯åœ¨ç¶²å€ ?gas=... æˆ– #ç®¡ç†è¨­å®š å¡«å…¥ï¼‰');

  let res;
  try {
    // ä¸è¨­ headersï¼Œç€è¦½å™¨æœƒç”¨ text/plain é€å‡º â†’ ä¸æœƒè§¸ç™¼é æª¢
    res = await fetch(endpoint, {
      method: 'POST',
      body: JSON.stringify(payload),
    });
  } catch (e) {
    throw new Error('ç„¡æ³•é€£ç·šåˆ° GASï¼ˆç¶²è·¯/CORSï¼‰ï¼š' + (e.message || 'é€£ç·šå¤±æ•—'));
  }

  // å…ˆæ‹¿æ–‡å­—ä¾†è§€å¯Ÿï¼Œå†å˜—è©¦è§£æ JSONï¼ˆé¿å…å›  CORS/opaque ç›´æ¥ä¸Ÿå¤±ç´°ç¯€ï¼‰
  let text;
  try {
    text = await res.text();
  } catch (e) {
    throw new Error('ç„¡æ³•è§£æ GAS å›æ‡‰ï¼ˆread body å¤±æ•—ï¼‰');
  }
  try {
    const data = JSON.parse(text);
    if(!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
    return data;
  } catch (e) {
    throw new Error('GAS é JSON å›æ‡‰ï¼ˆå¯èƒ½æ˜¯èˆŠéƒ¨ç½²/æ¬Šé™/ç™½åå–®ï¼‰ï¼š' + String(text).slice(0,200));
  }
}

/***** 1) è¨­å®šï¼šæ‰€æœ‰å•å·é›†ä¸­åœ¨é€™è£¡ *****/
const FORM_CONFIG = {
  tabs: [
    { id:'tab-0', name:'åŸºæœ¬è³‡è¨Š', kind:'basic' },

    { id:'tab-6', name:'æ¯å‘¨å•å·', kind:'weekly', prefix:'wk',
      likertTexts:[
        'æœ¬é€±æˆ‘èƒ½é †åˆ©å®Œæˆåˆ†é…çš„ä»»å‹™èˆ‡ä½œæ¥­ã€‚',
        'æˆ‘è¦ºå¾—è‡ªå·±æ¯”ä¸Šé€±æ›´ç†Ÿæ‚‰å·¥ä½œæµç¨‹ã€‚',
        'ç•¶å·¥ä½œä¸­å‡ºç¾å•é¡Œæ™‚ï¼Œæˆ‘èƒ½æ¸…æ¥šçŸ¥é“è§£æ±ºæ–¹å‘ã€‚',
        'æœ¬é€±èˆ‡å‰è¼©æˆ–åŒäº‹çš„åˆä½œäº’å‹•é †åˆ©ã€‚',
        'æˆ‘åœ¨ç¾å ´è§€å¯Ÿåˆ°æ–°çš„çŸ¥è­˜æˆ–æŠ€å·§ï¼Œä¸¦é¡˜æ„ä¸»å‹•å­¸ç¿’ã€‚',
        'æˆ‘è¦ºå¾—è‡ªå·±çš„å°ˆæ³¨åŠ›èˆ‡é«”åŠ›èƒ½æ‡‰ä»˜ç›®å‰çš„è¨“ç·´éœ€æ±‚ã€‚',
        'æˆ‘è¦ºå¾—ç›®å‰çš„èª²ç¨‹å®‰æ’èˆ‡å¯¦ä½œæ¯”ä¾‹é©åˆæˆ‘çš„å­¸ç¿’æ­¥èª¿ã€‚',
        'åŸ¹è¨“è³‡è¨Šï¼ˆå¦‚æ™‚é–“ã€åœ°é»ã€å…§å®¹ï¼‰æ˜¯å¦æ¸…æ¥šä¸”å®¹æ˜“å–å¾—ï¼Ÿ'
      ],
      opens:[
        'è¨“ç·´å…§å®¹å›é¥‹èˆ‡å¿ƒå¾—ï¼ˆè«‹é‡å°èª²ç¨‹å…§å®¹åˆ†äº«å­¸ç¿’æ‘˜è¦èˆ‡æ”¶ç©«ï¼Œè‡³å°‘100å­—ï¼‰ã€‚',
        'è¨“ç·´èª²ç¨‹æå•ï¼ˆè«‹æå‡ºæ‚¨å°æœ¬å‘¨è¨“ç·´å…§å®¹çš„ç–‘å•ã€æ”¹é€²å»ºè­°æˆ–å¸Œæœ›åŠ å¼·çš„éƒ¨åˆ†ï¼Œä¹Ÿæ­¡è¿å‰µæ„æå•ï¼Œè‡³å°‘å¡«å¯«ä¸€é …ï¼‰'
      ]
    },
    
    { id:'tab-1', name:'åˆæœŸè¨“ç·´', kind:'locate', prefix:'loc',
      likertTexts:[
        'æˆ‘æ¸…æ¥šçŸ¥é“è’¸é£¯ç®±ã€å¾®æ³¢çˆã€æ´—ç¢—æ§½ç­‰è¨­æ–½çš„ä½ç½®èˆ‡ä½¿ç”¨è¦ç¯„ã€‚',
        'æˆ‘èƒ½é †åˆ©æ‰¾åˆ°ä¼‘æ¯å€èˆ‡æ·‹æµ´é–“ç­‰ç©ºé–“ã€‚',
        'æˆ‘çŸ¥é“å» å€å…§å„é …è¨­æ–½çš„ä½ç½®ã€‚',
        'æˆ‘äº†è§£å…¬å¸çš„æ•´é«”çµ„ç¹”æ¶æ§‹èˆ‡å„éƒ¨é–€ä½ç½®ã€‚',
        'æˆ‘çŸ¥é“è‡ªå·±éš¸å±¬çš„å–®ä½åŠå·¥ä½œä»»å‹™ã€‚',
        'æˆ‘çŸ¥é“è©²èˆ‡å“ªäº›å–®ä½æˆ–åŒäº‹é…åˆå®Œæˆå·¥ä½œã€‚',
        'æˆ‘çŸ¥é“ç›´æ¥ä¸»ç®¡æ˜¯èª°ï¼Œäº†è§£ä¸»ç®¡çš„è·è²¬èˆ‡æœŸæœ›ã€‚',
        'æˆ‘çŸ¥é“é‡åˆ°å•é¡Œæ™‚å¯ä»¥å‘å“ªäº›åŒäº‹æˆ–ä¸»ç®¡æ±‚åŠ©ã€‚',
        'æˆ‘å·²äº†è§£è–ªè³‡çµæ§‹ã€å·®å‹¤èˆ‡è«‹å‡åˆ¶åº¦ã€‚',
        'æˆ‘å·²äº†è§£å…¬å¸å„ç¶²ç«™çš„æ“ä½œï¼Œä¸¦å¯ä»¥é †åˆ©ç™»å…¥ã€‚'
      ],
      opens:['è«‹åˆ†äº«å‰ä¸‰å¤©ä¸­æœ€å¹«åŠ©ä½ èå…¥ç’°å¢ƒçš„ä¸€é …å®‰æ’ï¼Œæˆ–ä½ è¦ºå¾—å¯æ”¹é€²çš„åœ°æ–¹ã€‚']
    },

    { id:'tab-2', name:'ä¸­æœŸæŠ€èƒ½', kind:'skill', prefix:'sk',
      likertTexts:[
        'æŠ€èƒ½èª²ç¨‹çš„å…§å®¹èƒ½æ‡‰ç”¨æ–¼å¯¦éš›å·¥ä½œã€‚',
        'æˆ‘æ¸…æ¥šå…¬å¸çš„å®‰å…¨è¦ç¯„èˆ‡å“è³ªè¦æ±‚ã€‚',
        'æˆ‘èƒ½ç†Ÿç·´æ“ä½œèª²ç¨‹ä¸­å­¸åˆ°çš„æŠ€èƒ½ã€‚',
        'èª²ç¨‹æ™‚é–“èˆ‡é€²åº¦å®‰æ’åˆç†ã€‚',
        'æˆ‘èƒ½åˆ†è¾¨å“ªäº›è¡Œç‚ºæœƒå½±éŸ¿å®‰å…¨æˆ–å“è³ªã€‚' ,       
        'æˆ‘èƒ½æ¸…æ¥šèªªæ˜ç†è«–èª²ç¨‹ä¸­æ‰€å­¸åˆ°çš„åŸºæœ¬æ¦‚å¿µèˆ‡åŸç†ã€‚',
        'ç†è«–èª²ç¨‹å…§å®¹èˆ‡æˆ‘ç›®å‰åœ¨ç¾å ´çœ‹åˆ°çš„è¨­å‚™èˆ‡æµç¨‹ç›¸ç¬¦ã€‚',
        'ç†è«–èª²ç¨‹ä¸­çš„ç¯„ä¾‹æˆ–èªªæ˜ï¼Œæœ‰åŠ©æ–¼æˆ‘ç†è§£å¯¦éš›çš„å·¥ä½œæµç¨‹ã€‚',
        'ç†è«–èª²ç¨‹è®“æˆ‘åœ¨ç¾å ´èƒ½æ›´å¿«ç†è§£ç¶­ä¿®å·¥ä½œçš„é‚è¼¯æˆ–åŸç†ã€‚',
        'æˆ‘å·²èƒ½ç†è§£å¯¦ä½œèª²ç¨‹ä¸­å„æ­¥é©Ÿçš„ç›®çš„èˆ‡æ³¨æ„äº‹é …ã€‚',
        'æˆ‘èƒ½åœ¨å‰è¼©æŒ‡å°ä¸‹å®Œæˆéƒ¨åˆ†ç°¡å–®ä»»å‹™ï¼ˆå¦‚å”åŠ©æª¢æŸ¥ã€æ¸…æ½”ã€å·¥å…·æº–å‚™ç­‰ï¼‰ã€‚',
        'åœ¨ç¾å ´ç¶­ä¿®éç¨‹ä¸­ï¼Œæˆ‘èƒ½çœ‹ï¼è½æ‡‚æŒ‡å°äººå“¡ä½¿ç”¨çš„è¡“èªèˆ‡æµç¨‹ã€‚',
        'ç•¶çœ‹åˆ°å¯¦éš›è¨­å‚™æ™‚ï¼Œæˆ‘èƒ½è¯æƒ³åˆ°ç†è«–èª²ç¨‹ä¸­å­¸éçš„å…§å®¹ã€‚',
        'ç•¶é‡åˆ°å•é¡Œæ™‚ï¼Œæˆ‘æœƒä¸»å‹•ç¿»é–±SOPæˆ–åŸ¹è¨“æ•™æå°‹æ‰¾è§£æ±ºæ–¹å¼ã€‚',
        'æˆ‘èƒ½åˆ¤æ–·å“ªäº›å•é¡Œå¯ä»¥è‡ªå·±è™•ç†ï¼Œå“ªäº›éœ€è¦è«‹æ•™å‰è¼©ã€‚',
        'æˆ‘èƒ½å¾å‰è¼©çš„ç¤ºç¯„ä¸­å­¸ç¿’ä¸¦é€æ­¥æ”¹å–„è‡ªå·±çš„æ“ä½œæ–¹å¼ã€‚',
        'å‰è¼©æˆ–åŒäº‹é¡˜æ„çµ¦äºˆæˆ‘å…·é«”çš„æŒ‡å°èˆ‡å›é¥‹ã€‚',
        'åœ¨ç¾å ´å­¸ç¿’æ™‚ï¼Œæˆ‘èƒ½ä¸»å‹•ç™¼å•ä¸¦å¾—åˆ°æ­£å‘å›æ‡‰ã€‚'
      ],
      opens:['æˆ‘è¦ºå¾—ç†è«–èª²ç¨‹èˆ‡å¯¦ä½œèª²ç¨‹çš„éŠœæ¥ç¨‹åº¦è‰¯å¥½ï¼Œèƒ½å¹«åŠ©æˆ‘ç©©å®šæˆé•·ã€‚','è«‹å¯«ä¸‹ä½ èªç‚ºã€Œç†è«–èª²ç¨‹æœ€æœ‰å¹«åŠ©çš„éƒ¨åˆ†ã€èˆ‡ã€Œå¯¦ä½œè¨“ç·´æœ€éœ€è¦æ”¹é€²çš„åœ°æ–¹ã€ã€‚'],
    },

    { id:'tab-3', name:'å¾ŒæœŸäº”å€‹å‘åº¦è©•ä¼°', kind:'grow360', prefix:'gr',
  likertTexts:[
    'è©²å“¡å·¥èƒ½åœ¨æœŸé™å…§å®Œæˆäº¤è¾¦ä»»å‹™ã€‚',
    'è©²å“¡å·¥çš„å·¥ä½œå“è³ªç©©å®šä¸”å¯é ã€‚',
    'è©²å“¡å·¥åœ¨å·¥ä½œä¸Šæ³¨é‡ç´°ç¯€ä¸¦è¿½æ±‚æ”¹é€²ã€‚',
    'è©²å“¡å·¥èƒ½ä¾æŒ‡ç¤ºè™•ç†çªç™¼ç‹€æ³ã€‚',
    'è©²å“¡å·¥èƒ½å°è‡ªå·±çš„éå¤±è² è²¬ã€‚',
    'è©²å“¡å·¥èƒ½èˆ‡åŒäº‹è‰¯å¥½åˆä½œã€æºé€šé †æš¢ã€‚',
    'è©²å“¡å·¥èƒ½ä¸»å‹•å”åŠ©ä»–äººæˆ–æ”¯æ´åœ˜éšŠä»»å‹™ã€‚',
    'è©²å“¡å·¥åœ¨å·¥ä½œä¸­è¡¨ç¾ç©æ¥µï¼Œæ¨‚æ–¼å­¸ç¿’ã€‚',
    'ç•¶ä»»å‹™å„ªå…ˆé †åºæ”¹è®Šæ™‚ï¼Œè©²å“¡å·¥èƒ½å¿«é€Ÿèª¿æ•´ã€‚',
    'è©²å“¡å·¥åœ¨å£“åŠ›æˆ–æ‰¹è©•ä¸‹ä»èƒ½ä¿æŒå°ˆæ¥­è¡¨ç¾ã€‚',
    'è©²å“¡å·¥å…·å‚™è‰¯å¥½çš„å•é¡Œè§£æ±ºèˆ‡åˆ¤æ–·èƒ½åŠ›ã€‚',
    'æˆ‘å°è©²å“¡å·¥åšå‡ºæ­£ç¢ºæ±ºç­–çš„èƒ½åŠ›æœ‰ä¿¡å¿ƒã€‚',
    'è©²å“¡å·¥å°å·¥ä½œç’°å¢ƒçš„å½±éŸ¿æ˜¯æ­£é¢çš„ã€‚',
    'æ‚¨å‘å…¶ä»–åŒäº‹æ¨è–¦è©²å“¡å·¥çš„å¯èƒ½æ€§æœ‰å¤šå¤§ï¼Ÿï¼ˆ1ï¼çµ•ä¸æ¨è–¦ï¼Œ5ï¼éå¸¸æ¨è–¦ã€‚ï¼‰',
  ],
  opens:['è«‹åˆ—å‡ºè©²å“¡å·¥è¡¨ç¾æœ€å„ªç§€çš„ä¸‰å€‹é¢å‘ã€‚','è«‹åˆ—å‡ºè©²å“¡å·¥æœ€éœ€è¦æ”¹é€²çš„ä¸‰å€‹éƒ¨åˆ†æˆ–å»ºè­°å…¶æˆé•·æ–¹å‘ã€‚'],
  extras:[
    { key:'role',   label:'è§’è‰²', type:'select', required:true,
      options:[
        {value:'self',    label:'è‡ªè©•ï¼ˆé è¨­ï¼‰'},
        {value:'manager', label:'ç›´å±¬ä¸»ç®¡'},
        {value:'peer',    label:'åŒäº‹'},
        {value:'mentor',  label:'å°å¸«'}
      ],
      default:'self'
    },
    { key:'rateeId',label:'è©•ä¼°å°è±¡ï¼ˆemployeeIdï¼‰', required:true }
  ]
},

    { id:'tab-4', name:'æ„è¦‹åæ˜ ', kind:'messages',
      opens:['ç•™è¨€å…§å®¹']
    },

    { id:'tab-5', name:'ç®¡ç†è¨­å®š', kind:'admin' },

    { id:'tab-7', name:'èª²å ‚å•å·', kind:'course', prefix:'cq',
  likertTexts:[
    'æˆ‘åœ¨é€™å ‚è¨“ç·´èª²ç¨‹å­¸ç¿’åˆ°æ–°çš„è§€å¿µèˆ‡æŠ€å·§ã€‚',
    'è¨“ç·´è¬›å¸«å…·å‚™å°ˆæ¥­çŸ¥èƒ½èˆ‡æŠ€è¡“ï¼Œä¸”è¡¨é”è‰¯å¥½ã€‚',
    'æˆ‘å°æ–¼èª²ç¨‹éå¸¸æ»¿æ„ã€‚'
  ],
     opens:[
    'è«‹å¯«ä¸‹æœ¬å ‚èª²è®“ä½ æœ€æœ‰æ”¶ç©«çš„ä¸€é»ï¼ˆæˆ–å»ºè­°æ”¹é€²ä¹‹è™•ï¼‰ã€‚']
},
  ]
};

/***** 2) åˆ†é  UI *****/
function renderTabs(){
  const tabsHost = document.getElementById('tabs');
  const specs = FORM_CONFIG.tabs.map(t=>({id:t.id, name:t.name}));
  window.__TAB_SPECS = specs;
  tabsHost.innerHTML = '';
  specs.forEach((t,i)=>{
    const btn = document.createElement('button');
    btn.className = 'tab'+(i===0?' active':'');
    btn.textContent = t.name;
    btn.addEventListener('click', ()=> switchTab(i));
    tabsHost.appendChild(btn);
  });
}
function switchTab(index){
  const specs = window.__TAB_SPECS || [];
  const tabs = document.getElementById('tabs').children;
  for(let i=0;i<tabs.length;i++) tabs[i].classList.toggle('active', i===index);
  specs.forEach((t,i)=>{
    const sec = document.getElementById(t.id);
    if(!sec) return;
    sec.style.display = (i===index) ? 'block' : 'none';
  });
  const names = FORM_CONFIG.tabs.map(t=>t.kind);
  const h = names[index] || FORM_CONFIG.tabs[0].kind;
  if(location.hash !== '#'+h) history.replaceState(null,'','#'+h);
}
function applyHash(){
  const names = FORM_CONFIG.tabs.map(t=>t.kind);
  const map = Object.fromEntries(names.map((n,i)=>[n,i]));
  const key = (location.hash||'').replace('#','');
  switchTab(map[key] ?? 0);
}

/***** 3) è‡ªå‹•æ¸²æŸ“æ‰€æœ‰å•å· *****/
function renderAllForms(){
  FORM_CONFIG.tabs.forEach(tab=>{
    if(['basic','admin'].includes(tab.kind)) return; // éå•å·é ç•¥é
    const sec = document.getElementById(tab.id);
    if(!sec) return;

    let html = '';
    if (tab.kind === 'messages') {
      const label = (tab.opens && tab.opens[0]) || 'è«‹è¼¸å…¥æ„è¦‹';
      html = `
        <label>${label}</label>
        <textarea id="${tab.id}-open-0" placeholder="è«‹å¡«å¯«"></textarea>
      `;
    } else {
      if (Array.isArray(tab.likertTexts)) {
        const rows = tab.likertTexts.map((text,i)=>{
          const n=i+1, name=`${tab.prefix}${n}`;
          const radios=[1,2,3,4,5].map(v=>`<td><input type="radio" name="${name}" value="${v}"></td>`).join('');
          return `<tr><td>${n}. ${text}</td>${radios}</tr>`;
        }).join('');
        html += `
          <table>
            <tr><th>é¡Œç›®</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>
            ${rows}
          </table>`;
      }
      if (Array.isArray(tab.opens)) {
        html += tab.opens.map((t,i)=>`
          <label>${t}</label>
          <textarea id="${tab.id}-open-${i}" placeholder="è«‹å¡«å¯«"></textarea>
        `).join('');
      }
      // é¡å¤–æ¬„ä½ï¼ˆextrasï¼‰
if (Array.isArray(tab.extras)) {
  html += tab.extras.map(ex=>{
    if (ex.type === 'select') {
      const opts = (ex.options||[]).map(o=>{
        const sel = (o.value === ex.default) ? ' selected' : '';
        return `<option value="${o.value}"${sel}>${o.label}</option>`;
      }).join('');
      return `
        <label>${ex.label}${ex.required?'ï¼ˆå¿…å¡«ï¼‰':''}</label>
        <select id="${tab.id}-extra-${ex.key}">${opts}</select>
      `;
    } else {
      // text è¼¸å…¥
      const ph = ex.label + (ex.required?'ï¼ˆå¿…å¡«ï¼‰':'');
      const val = ex.default ? ` value="${ex.default}"` : '';
      return `
        <label>${ex.label}${ex.required?'ï¼ˆå¿…å¡«ï¼‰':''}</label>
        <input id="${tab.id}-extra-${ex.key}" type="text" placeholder="${ph}"${val}>
      `;
    }
  }).join('');
}
    }
    let host = sec.querySelector('.form-host');
    if(!host){ host = document.createElement('div'); host.className='form-host'; const btns=sec.querySelector('.btns'); sec.insertBefore(host, btns||null); }
    host.innerHTML = html;

    // ç¶å®šé€å‡ºæŒ‰éˆ•
    const btn = sec.querySelector('.btns .primary');
    if(btn){ btn.onclick = ()=> submitByKind(tab.kind); }
  });
}

/***** 4) è®€å€¼/é©—è­‰/æ‰“åŒ… *****/
function readLikert(prefix, count){
  const out = [];
  for(let i=1;i<=count;i++){
    const r = document.querySelector(`input[name='${prefix}${i}']:checked`);
    out.push(r ? Number(r.value) : null);
  }
  return out;
}
function buildPayload(tab){
  const base = {
    module: tab.kind,
    employeeId: profile.employeeId,
    fullName:   profile.fullName,
    dept:       profile.dept,
    date:       profile.date,
    ts:         Date.now()
  };

  // messagesï¼šåªé€ body
  if (tab.kind === 'messages') {
    const body = (document.getElementById(`${tab.id}-open-0`)?.value || '').trim();
    return { ...base, body };
  }

  // å…¶å®ƒå•å·ï¼šscores / opens / extras
  const scores = Array.isArray(tab.likertTexts) ? readLikert(tab.prefix, tab.likertTexts.length) : [];
  const opens  = Array.isArray(tab.opens) ? tab.opens.map((_,i)=> (document.getElementById(`${tab.id}-open-${i}`)?.value||'').trim()) : [];
  const extras = {};
  if (Array.isArray(tab.extras)) {
    tab.extras.forEach(ex=>{
      const v = document.getElementById(`${tab.id}-extra-${ex.key}`)?.value || '';
      extras[ex.key] = v.trim();
    });
  }

  // â˜… grow360 ä¿åº•ï¼šrole é è¨­ selfï¼›rateeId ç©ºç™½æ™‚å¸¶æœ¬äºº ID
  if (tab.kind === 'grow360') {
    if (!extras.role) extras.role = 'self';
    if (!extras.rateeId && profile?.employeeId) extras.rateeId = profile.employeeId;
  }

if (tab.kind === 'course') {
  const c = window.__COURSE__ || {};
  extras.courseId    = extras.courseId    || c.id || '';
  extras.courseTitle = extras.courseTitle || c.title || '';
}
  
  return { ...base, scores, opens, extras };
}

function validateTab(tab){
  if (typeof readBasic === 'function') readBasic();
  if(!profile?.employeeId){ toast('è«‹å…ˆæ–¼ã€ŒåŸºæœ¬è³‡è¨Šã€å¡«å¯«ä½¿ç”¨è€…ä»£è™Ÿ'); switchTab(0); return false; }

  if (tab.kind === 'messages') {
    const body = (document.getElementById(`${tab.id}-open-0`)?.value || '').trim();
    if(!body){ toast('è«‹è¼¸å…¥æ„è¦‹å…§å®¹'); return false; }
    return true;
  }

  // Likert å¿…å¡«æª¢æŸ¥
  if (Array.isArray(tab.likertTexts)) {
    const vals = readLikert(tab.prefix, tab.likertTexts.length);
    const miss = vals.map((v,i)=> v==null ? (i+1) : null).filter(Boolean);
    if(miss.length){ toast(`è«‹å®Œæˆç¬¬ ${miss.join(', ')} é¡Œ`); return false; }
  }

  // â˜… extras å¿…å¡«æª¢æŸ¥ï¼ˆä¾‹å¦‚ grow360 çš„ role / rateeIdï¼‰
  if (Array.isArray(tab.extras)) {
    for (const ex of tab.extras) {
      if (!ex.required) continue;
      let v = document.getElementById(`${tab.id}-extra-${ex.key}`)?.value?.trim() || '';
      // grow360ï¼šrateeId å¯ç”¨æœ¬äºº ID ä½œç‚ºé è¨­
      if (tab.kind === 'grow360' && ex.key === 'rateeId' && !v && profile?.employeeId) {
        v = profile.employeeId;
        const el = document.getElementById(`${tab.id}-extra-${ex.key}`); if (el) el.value = v;
      }
      if (!v) { toast(`${ex.label} ç‚ºå¿…å¡«`); return false; }
    }
  }
  return true;
}

async function submitByKind(kind){
  const tab = FORM_CONFIG.tabs.find(t=> t.kind===kind);
  if(!tab) return;
  if(!validateTab(tab)) return;
  const payload = buildPayload(tab);
  const btn = document.querySelector(`#${tab.id} .btns .primary`);
  const old = btn?.textContent;
  if(btn){ btn.disabled=true; btn.textContent='å‚³é€ä¸­â€¦'; }
  try{
    await submitToGAS(payload);
    if(btn){ btn.textContent='âœ” å·²é€å‡º'; }
    toast(`${tab.name} å·²é€å‡º`);
    switchTab(0);
  }catch(e){
    console.error(e);
    if(btn){ btn.disabled=false; btn.textContent=old; }
    toast('é€å‡ºå¤±æ•—ï¼š'+e.message);
    if (Array.isArray(tab.extras)) {
  for (const ex of tab.extras) {
    if (ex.required) {
      const v = document.getElementById(`${tab.id}-extra-${ex.key}`)?.value?.trim() || '';
      if (!v && !(tab.kind==='grow360' && ex.key==='rateeId' && profile?.employeeId)) {
        toast(`${ex.label} ç‚ºå¿…å¡«`);
        return false;
      }
    }
  }
}
   
  }
}

/***** 5) åŸºæœ¬è³‡è¨Šè¼”åŠ©ï¼ˆå¯ç”¨ä½ çš„åŸç‰ˆè¦†è“‹ï¼‰ *****/
function readBasic(){
  profile.employeeId = document.getElementById('employeeId')?.value?.trim() || profile.employeeId;
  profile.fullName   = document.getElementById('fullName')?.value?.trim()   || profile.fullName;
  profile.dept       = document.getElementById('dept')?.value?.trim()       || profile.dept;
  profile.date       = document.getElementById('date')?.value               || profile.date;
  const badge = document.getElementById('userIdBadge'); if(badge) badge.textContent = profile.employeeId || 'æœªè¨­å®š';
}
document.getElementById('fillToday')?.addEventListener('click', ()=>{
  const el = document.getElementById('date');
  if(el){ el.value = new Date().toISOString().slice(0,10); readBasic(); }
});

/***** 6) åˆå§‹åŒ– *****/
function init(){
  // 1) ç”Ÿæˆåˆ†é æŒ‰éˆ•
  renderTabs();

  // 2) å…ˆéš±è—é™¤ç¬¬ 1 é ä»¥å¤–çš„åˆ†é 
  FORM_CONFIG.tabs.slice(1).forEach(t=>{
    const el = document.getElementById(t.id);
    if (el) el.style.display = 'none';
  });

  // 3) æ ¹æ“š FORM_CONFIG è‡ªå‹•æ¸²æŸ“æ‰€æœ‰å•å·
  renderAllForms();

  // 4) hash å°èˆª
  applyHash();
  window.addEventListener('hashchange', applyHash);

  // 5) â˜… èª²å ‚å•å·ï¼šè®€å– URL åƒæ•¸ï¼ˆmodule=course&id=...&title=...ï¼‰ï¼Œè‡ªå‹•åˆ‡åˆ°èª²å ‚å•å·ä¸¦é¡¯ç¤ºèª²å
  applyCourseFromQuery();

  // 6) â˜… åœ¨ DOM æº–å‚™å¥½å¾Œï¼Œå†ç¶å®šã€Œæ¸¬è©¦é€£ç·šã€æŒ‰éˆ•
  const pingBtn = document.getElementById('gasTestBtn');
  if (pingBtn) {
    pingBtn.addEventListener('click', async ()=>{
      const endpoint = window.GAS_ENDPOINT || document.getElementById('gas_url')?.value;
      if(!endpoint){ alert('è«‹å…ˆè¨­å®š GAS /exec'); return; }
      try{
        const r = await fetch(endpoint + '?get=1');
        const t = await r.text();
        alert('PING å›æ‡‰ï¼š\n' + t.slice(0,500));
      }catch(e){
        alert('PING å¤±æ•—ï¼š' + (e.message || e));
      }
    });
  }
}

// â˜… æ–°å¢ï¼šç®¡ç†é‡‘é‘°é©—è­‰èˆ‡è§£é–
// === ç®¡ç†é‡‘é‘° & é è¨­ URLï¼ˆä½ å¯ä»¥æ”¹é€™å…©è¡Œï¼‰ ===
const ADMIN_SECRET     = 'MONAADMIN'; // â† æ›å¯†ç¢¼å°±æ”¹é€™è¡Œ
const DEFAULT_GAS_URL  = 'https://script.google.com/macros/s/AKfycbylnQs-FaohoCe0wdEw_xQyhLNX0jq_Hcou3Ndxgfq1YdPcs4114PNTp64b619qUpGa/exec'; // â† ä½ çš„ /exec

// === ç¶å®šã€Œå•Ÿç”¨ç·¨è¼¯ã€é‚è¼¯ï¼šè§£é–å¾Œæ‰é¡¯ç¤º/å¯ç·¨è¼¯ GAS URL ===
function bindAdminUnlock() {
  const unlockBtn = document.getElementById('adminUnlock');
  const keyInput  = document.getElementById('adminKey');
  const gasInput  = document.getElementById('gas_url');
  if (!unlockBtn || !keyInput || !gasInput) return;

  // é è¨­å…ˆéš±è—å…§å®¹ï¼ˆä¸å½±éŸ¿ placeholderï¼‰
  gasInput.value = '';               // æ¸…ç©ºé¡¯ç¤º
  gasInput.setAttribute('readonly', ''); // ä¿æŒå”¯è®€

  // è‹¥æœ¬æ¬¡ç€è¦½å·²è§£é–éï¼ˆsessionStorageï¼‰ï¼Œè‡ªå‹•é¡¯ç¤ºèˆ‡è§£é–
  if (sessionStorage.getItem('admin_unlocked') === '1') {
    gasInput.removeAttribute('readonly');
    gasInput.value = DEFAULT_GAS_URL;
  }

  unlockBtn.addEventListener('click', () => {
    const key = (keyInput.value || '').trim();
    if (key !== ADMIN_SECRET) {
      alert('é‡‘é‘°éŒ¯èª¤');
      return;
    }
    gasInput.removeAttribute('readonly');
    if (!gasInput.value) gasInput.value = DEFAULT_GAS_URL; // è§£é–å¾Œæ‰å¡«å…¥
    sessionStorage.setItem('admin_unlocked', '1');
    alert('å·²è§£é–ï¼Œå¯ç·¨è¼¯ GAS URL');
  });
}


// åœ¨ init() åŸ·è¡Œå¾Œå‘¼å«
document.addEventListener('DOMContentLoaded', () => {
  init();
  loadCourseListForMakeup();
  bindAdminUnlock(); // â˜… åŠ ä¸Šé€™è¡Œ
});

  
async function loadCourseListForMakeup(){
  // è‹¥ URL å·²å¸¶ id/title å°±ä¸ç”¨é¡¯ç¤ºè£œç™»é¸å–®ï¼ˆæƒ QR ç›´æ¥é€²ï¼‰
  const q = getQuery();
  const hasPreset = (q.module||'').toLowerCase() === 'course' && (q.id || q.courseId || q.title);
  if (hasPreset) return;

  const picker = document.getElementById('coursePicker');
  const selectEl = document.getElementById('courseSelect');
  if (!picker || !selectEl) return;

  // é¡¯ç¤ºè£œç™»é¸å–®ï¼ˆé è¨­éš±è—ï¼‰
  picker.style.display = 'grid';

  // å–å¾— GAS Web App URL
  const endpoint = (window.GAS_ENDPOINT || document.getElementById('gas_url')?.value || '').trim();
  if (!endpoint){
    // æ²’è¨­å®šå°±åƒ…é¡¯ç¤º placeholder
    selectEl.innerHTML = '<option value="">ï¼ˆå°šæœªè¨­å®š GAS /execï¼Œç„¡æ³•è¼‰å…¥èª²ç¨‹æ¸…å–®ï¼‰</option>';
    return;
  }

  try{
    // â˜… å¸¶ä¸Š originï¼Œå¾Œç«¯æœ‰ç™½åå–®æª¢æŸ¥ï¼ˆå…è¨±ç©º origin ä½†å¸¶ä¸Šæ›´ç©©å¦¥ï¼‰
    const url = `${endpoint}?action=courselist&origin=${encodeURIComponent(location.origin)}`;
    const res = await fetch(url);
    const data = await res.json();

    if (!data?.ok || !Array.isArray(data.items) || data.items.length === 0){
      selectEl.innerHTML = '<option value="">ï¼ˆç›®å‰æ²’æœ‰å¯é¸èª²ç¨‹ï¼Œè«‹åˆ°è©¦ç®—è¡¨ courselist æ–°å¢ï¼‰</option>';
      return;
    }

    // å¡é¸é …ï¼švalue å­˜ idï¼›ç”¨ data-title å­˜ title
    const frag = document.createDocumentFragment();
    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = 'è«‹é¸æ“‡èª²ç¨‹';
    frag.appendChild(ph);

    data.items.forEach(({id, title, instructor})=>{
      const opt = document.createElement('option');
      opt.value = id;
      opt.dataset.title = title || '';
      opt.textContent = instructor ? `${id}ï½œ${title}ï¼ˆ${instructor}ï¼‰` : `${id}ï½œ${title}`;
      frag.appendChild(opt);
    });

    selectEl.innerHTML = '';
    selectEl.appendChild(frag);

    // ç•¶ä½¿ç”¨è€…é¸å–èª²ç¨‹ â†’ è¨­å®šå…¨åŸŸ __COURSE__ + æ¨™é¡Œé¡¯ç¤º
    selectEl.onchange = ()=>{
      const opt = selectEl.options[selectEl.selectedIndex];
      const id = selectEl.value || '';
      const title = opt?.dataset?.title || '';
      window.__COURSE__ = { id, title };
      const hdr = document.getElementById('courseHeader');
      if (hdr) hdr.textContent = id ? `ï¼ˆ${id}ï½œ${title}ï¼‰` : '';
    };
  }catch(e){
    console.warn('è¼‰å…¥èª²ç¨‹æ¸…å–®å¤±æ•—ï¼š', e);
    selectEl.innerHTML = '<option value="">ï¼ˆæ¸…å–®è¼‰å…¥å¤±æ•—ï¼Œç¨å¾Œå†è©¦æˆ–æ”¹ç”¨ QR/URL é é¸ï¼‰</option>';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  init();                 // â† å¿…é ˆå…ˆè·‘ï¼Œæœƒ renderTabs()ã€éš±è—å…¶ä»–åˆ†é ã€ç¶äº‹ä»¶ç­‰
  loadCourseListForMakeup(); // è£œç™»èª²ç¨‹é¸å–®å†è¼‰
  bindAdminUnlock();
});

</script>
  
</body>
</html>

