<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>新進員工訓練回饋系統</title>
  <style>
    :root{--bg:#f8fafc;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--brand:#0ea5e9;--active:#dbeafe;--danger:#fecaca}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans CJK TC",sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.5px}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{border:1px solid #e5e7eb;background:#fff;color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
    .tab.active{border-color:var(--brand);box-shadow:0 0 0 1px inset var(--brand)}
    main{padding:24px}
    section.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:20px;margin:18px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input[type=text],input[type=date],input[type=email],select,textarea{width:100%;background:#fff;color:var(--text);border:1px solid #e5e7eb;border-radius:10px;padding:10px}
    textarea{min-height:88px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    button{border:1px solid #e5e7eb;background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button.primary{border-color:var(--brand);box-shadow:0 0 0 1px inset var(--brand)}
    .muted{color:var(--muted);font-size:12px}
    .toast{position:fixed;right:16px;bottom:16px;padding:10px 14px;background:#fff;border:1px solid #e5e7eb;border-radius:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{text-align:left;border-bottom:1px solid #e5e7eb;padding:6px}
    /* 高亮已選的單選框所在儲存格（現代瀏覽器支援 :has） */
    td:has(input[type=radio]:checked){background:var(--active)}

</style>
  
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
</head>
<body>
  <header>
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h1>新進員工訓練回饋系統</h1>
        <span class="muted">使用者ID：<strong id="userIdBadge">未設定</strong></span>
      </div>
      <nav id="tabs" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"></nav>
    </div>
  </header>
  <main class="wrap">
    <!-- ✅ 第一張卡片：基本資訊 -->
<section id="tab-0" class="card">
  <h2>🔑 基本資訊</h2>
  <div class="row">
    <div>
      <label>員工編號（employeeId）</label>
      <input id="employeeId" type="text" placeholder="例如：9999M0000" />
    </div>
    <div>
      <label>姓名</label>
      <input id="fullName" type="text" placeholder="例如：王小明" />
    </div>
  </div>
  <div class="row">
    <div>
      <label>單位 / 部門</label>
      <input id="dept" type="text" placeholder="例如：車輛課／軌土課／通號課" />
    </div>
    <div>
      <label>今天日期</label>
      <input id="date" type="date" />
      <div class="btns">
        <button id="fillToday" type="button">填入今天</button>
        <button id="clearIdentityBtn" type="button">🧹清除資料</button>
      </div>
    </div>
  </div>
</section>

<!-- ✅ 第二張卡片：填寫說明與時程（放在 tab-0 之後） -->
<section id="tab-0-guide" class="card">
  <h2>🗒 填寫說明與時程</h2>
  <p class="muted">
    以下為各問卷的目的、建議填寫時點與平均所需時間。點右側按鈕可直接切換到該問卷。
  </p>
  <table>
    <thead>
      <tr>
        <th>問卷</th>
        <th>目的 / 內容重點</th>
        <th>建議填寫對象</th>
        <th>頻率</th>
        <th>建議時間</th>
        <th>截止/時點</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>📘 課堂問卷</td>
        <td>單堂課滿意度與重點回饋。</td>
        <td>參與該堂課的學員</td>
        <td>每堂課一次</td>
        <td> 1 分鐘以內</td>
        <td>下課後立刻填寫</td>
        <td><button data-goto="tab-7">立即前往</button></td>
      </tr>
      <tr>
        <td>🧭 每周問卷</td>
        <td>追蹤本週任務進展、學習困難與建議。</td>
        <td>新進員工本人</td>
        <td>每周一次</td>
        <td>約 4-6 分鐘</td>
        <td>每週五 23:59</td>
        <td><button data-goto="tab-6">立即前往</button></td>
      </tr>
      <tr>
        <td>👌 初期問卷</td>
        <td>了解新人對環境/制度/系統等熟悉度。</td>
        <td>新進員工本人</td>
        <td>一次</td>
        <td>約 3–5 分鐘</td>
        <td>入職 3 天內</td>
        <td><button data-goto="tab-1">立即前往</button></td>
      </tr>
      <tr>
        <td>💡 中期問卷</td>
        <td>評估理論/實作的課程掌握度與工作適應。</td>
        <td>新進員工本人</td>
        <td>一次</td>
        <td>約 5–7 分鐘</td>
        <td>入職第 2 個月</td>
        <td><button data-goto="tab-2">立即前往</button></td>
      </tr>
      <tr>
        <td>🔶 後期五向度評估</td>
        <td>從工作表現、團隊、態度、問題解決、整體貢獻做五向度評估。</td>
        <td>自評／主管或導師／同事</td>
        <td>一次</td>
        <td>約 5-7 分鐘</td>
        <td>入職第 4 個月</td>
        <td><button data-goto="tab-3">立即前往</button></td>
      </tr>
      <tr>
        <td>💬 意見反映</td>
        <td>任何時間的問題回報、建議或需求。</td>
        <td>所有學員</td>
        <td>—</td>
        <td><button data-goto="tab-4">立即前往</button></td>
      </tr>
    </tbody>
  </table>
</section>

 <section id="tab-7" class="card">
  <h2>📘 課堂問卷 <span id="courseHeader" class="muted"></span></h2>
  <div id="coursePicker" class="row" style="margin-bottom:12px; display:none">
    <div>
      <label>選擇課程（補填）</label>
      <select id="courseSelect"><option value="">請選擇課程</option></select>
    </div>
  </div>
  <p class="muted">請以五點量表作答（1＝非常不同意，5＝非常同意）。</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">送出課堂問卷</button></div>
</section>
    
<!-- 🗓 每周問卷 -->
   <section id="tab-6" class="card">
  <h2>🧭 每周問卷</h2>
  <p>請以五點量表作答（1＝非常不同意，5＝非常同意），並完成開放題：</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">送出每周問卷</button></div>
</section>
    
   <section id="tab-1" class="card">
  <h2>👌 初期問卷</h2>
  <p>請針對以下指標進行評分（1＝非常不同意，5＝非常同意）：</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">送出初期問卷</button></div>
</section>
    
    <section id="tab-2" class="card">
  <h2>💡 中期課程回饋</h2>
  <p>請評估以下學習成效（1＝非常不同意，5＝非常同意）：</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">送出中期問卷</button></div>
</section>

    <section id="tab-3" class="card">
  <h2>🔶 後期五個向度評估</h2>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">送出後期評估</button></div>
</section>

    <section id="tab-4" class="card">
  <h2>💬 意見反映</h2>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">送出留言</button></div>
</section>
    
  <section id="tab-5" class="card">
  <h2>🛠️ 管理設定（Admin）</h2>
  <p class="muted">輸入管理金鑰後才會顯示並啟用 GAS Web App 設定。</p>

  <div class="row">
    <div>
      <label>管理金鑰</label>
      <input id="adminKey" type="password" placeholder="請輸入金鑰" />
      <div class="btns">
        <button id="adminUnlock" type="button">啟用管理</button>
      </div>
    </div>
  </div>

  <!-- ★ 必須有 adminPanel，解鎖後才顯示 -->
    <div id="adminPanel" style="display:none; margin-top:16px">
      <section id="adminCharts" class="card" style="margin-top:0">
        <h3>📈 匿名彙整預覽</h3>
        <div class="muted" style="margin-bottom:8px">資料來源：stats_course / weekly_compare / stats_locate / stats_skill</div>
        <div style="display:grid;grid-template-columns:1fr;gap:18px">
          <canvas id="chartCourseOverall"></canvas> <!-- ① 各課程整體滿意度 -->
          <canvas id="chartWeeklyTrend"></canvas>   <!-- ② 每周問卷折線 -->
          <canvas id="chartLocateAvg"></canvas>     <!-- ③ 初期各題 -->
          <canvas id="chartSkillAvg"></canvas>      <!-- ④ 中期各題 -->
        </div>
      </section>
    </div>
  </section>
</main>
  
<script>
/* =========================================================
 * [01] 全域設定（Admin 金鑰 / GAS 端點）
 * =======================================================*/
const ADMIN_SECRET     = 'ADMINKEY'; // 要和後端的 ADMIN_KEY 相同
const DEFAULT_GAS_URL  = 'https://script.google.com/macros/s/AKfycbylnQs-FaohoCe0wdEw_xQyhLNX0jq_Hcou3Ndxgfq1YdPcs4114PNTp64b619qUpGa/exec';      // ← 直接放正式 /exec

// ★ 修正後：固定端點（不要殘留舊程式碼在全域）
function getEndpoint(){ return DEFAULT_GAS_URL.trim(); }
function setEndpoint(){ /* no-op */ }

/* =========================================================
 * [02] 小工具（Query 解析 / 提示 / 使用者基本資料）
 * =======================================================*/
function getQuery(){ try { return Object.fromEntries(new URL(location.href).searchParams.entries()); } catch { return {}; } }
window.profile = window.profile || { employeeId:'', fullName:'', dept:'', date:(new Date()).toISOString().slice(0,10) };
window.toast = (msg)=>{
  let t = document.querySelector('.toast');
  if (!t) {
    t = document.createElement('div');
    t.className = 'toast';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> t.style.display='none', 2000);
};

/* =========================================================
 * [03] 與 GAS 溝通（送單一 payload；匿名圖表另見 [09]）
 * =======================================================*/
async function submitToGAS(payload){
  const endpoint = getEndpoint();
  let res;
  try { res = await fetch(endpoint, { method:'POST', body: JSON.stringify(payload) }); }
  catch (e) { throw new Error('無法連線到 GAS：' + (e.message || '連線失敗')); }

  const text = await res.text().catch(()=> '');
  try {
    const data = JSON.parse(text || '{}');
    if (!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
    return data;
  } catch {
    throw new Error('GAS 非 JSON 回應：' + String(text).slice(0,200));
  }
}

/* =========================================================
 * [04] 問卷配置（FORM_CONFIG：標籤順序、題目、開放題、extras）
 * =======================================================*/
const FORM_CONFIG = {
  tabs: [
    { id:'tab-0', name:'基本資訊', kind:'basic' },

 { id:'tab-7', name:'課堂問卷', kind:'course', prefix:'cq',
  likertTexts:[
    '我在這堂訓練課程學習到新的觀念與技巧。',
    '課程內容與主題非常契合。',
    '我對於課程非常滿意。'
  ],
     opens:[
    '請寫下本堂課讓你最有收穫的一點（或建議改進之處）。']
},
    
    { id:'tab-6', name:'每周問卷', kind:'weekly', prefix:'wk',
      likertTexts:[
        '本週我能順利完成分配的任務與作業。',
        '我覺得自己比上週更熟悉工作流程。',
        '當工作中出現問題時，我能清楚知道解決方向。',
        '本週與前輩或同事的合作互動順利。',
        '我在現場觀察到新的知識或技巧，並願意主動學習。',
        '我覺得自己的專注力與體力能應付目前的訓練需求。',
        '我覺得目前的課程安排與實作比例適合我的學習步調。',
        '培訓資訊（如時間、地點、內容）是否清楚且容易取得？'
      ],
      opens:[
        '訓練內容回饋與心得（請針對課程內容分享學習摘要與收穫，至少100字）。',
        '訓練課程提問（請提出您對本周訓練內容的疑問、改進建議或希望加強的部分，也歡迎創意提問，至少填寫一項）'
      ]
    },
    
    { id:'tab-1', name:'初期問卷', kind:'locate', prefix:'loc',
      likertTexts:[
        '我清楚知道蒸飯箱、微波爐、洗碗槽等設施的位置與使用規範。',
        '我能順利找到休息區與淋浴間等空間。',
        '我知道廠區內各項設施的位置。',
        '我了解公司的整體組織架構與各部門位置。',
        '我知道自己隸屬的單位及工作任務。',
        '我知道該與哪些單位或同事配合完成工作。',
        '我知道直接主管是誰，了解主管的職責與期望。',
        '我知道遇到問題時可以向哪些同事或主管求助。',
        '我已了解薪資結構、差勤與請假制度。',
        '我已了解公司各網站的操作，並可以順利登入。'
      ],
      opens:['請分享前三天中最幫助你融入環境的一項安排，或你覺得可改進的地方。']
    },

    { id:'tab-2', name:'中期問卷', kind:'skill', prefix:'sk',
      likertTexts:[
        '技能課程的內容能應用於實際工作。',
        '我清楚公司的安全規範與品質要求。',
        '我能熟練操作課程中學到的技能。',
        '課程時間與進度安排合理。',
        '我能分辨哪些行為會影響安全或品質。' ,       
        '我能清楚說明理論課程中所學到的基本概念與原理。',
        '理論課程內容與我目前在現場看到的設備與流程相符。',
        '理論課程中的範例或說明，有助於我理解實際的工作流程。',
        '理論課程讓我在現場能更快理解維修工作的邏輯或原理。',
        '我已能理解實作課程中各步驟的目的與注意事項。',
        '我能在前輩指導下完成部分簡單任務（如協助檢查、清潔、工具準備等）。',
        '在現場維修過程中，我能看／聽懂指導人員使用的術語與流程。',
        '當看到實際設備時，我能聯想到理論課程中學過的內容。',
        '當遇到問題時，我會主動翻閱SOP或培訓教材尋找解決方式。',
        '我能判斷哪些問題可以自己處理，哪些需要請教前輩。',
        '我能從前輩的示範中學習並逐步改善自己的操作方式。',
        '前輩或同事願意給予我具體的指導與回饋。',
        '在現場學習時，我能主動發問並得到正向回應。'
      ],
      opens:['我覺得理論課程與實作課程的銜接程度良好，能幫助我穩定成長。','請寫下你認為「理論課程最有幫助的部分」與「實作訓練最需要改進的地方」。'],
    },

    { id:'tab-3', name:'後期五個向度評估問卷', kind:'grow360', prefix:'gr',
  likertTexts:[
    '該員工能在期限內完成交辦任務。',
    '該員工的工作品質穩定且可靠。',
    '該員工在工作上注重細節並追求改進。',
    '該員工能依指示處理突發狀況。',
    '該員工能對自己的過失負責。',
    '該員工能與同事良好合作、溝通順暢。',
    '該員工能主動協助他人或支援團隊任務。',
    '該員工在工作中表現積極，樂於學習。',
    '當任務優先順序改變時，該員工能快速調整。',
    '該員工在壓力或批評下仍能保持專業表現。',
    '該員工具備良好的問題解決與判斷能力。',
    '我對該員工做出正確決策的能力有信心。',
    '該員工對工作環境的影響是正面的。',
    '您向其他同事推薦該員工的可能性有多大？（1＝絕不推薦，5＝非常推薦。）',
  ],
  opens:['請列出該員工表現最優秀的三個面向。','請列出該員工最需要改進的三個部分或建議其成長方向。'],
  extras:[
  { key:'role', label:'角色', type:'select', required:true,
    options:[
      {value:'self',    label:'自評（預設）'},
      {value:'manager', label:'直屬主管/導師'},
      {value:'peer',    label:'同事'},
    ],
    default:'self'
  }
]
},

    { id:'tab-4', name:'意見反映', kind:'messages',
      opens:['留言內容']
    },

    { id:'tab-5', name:'管理設定', kind:'admin' },
  ]
};

/* ===== [05] 分頁 UI ===== */
function renderTabs(){
  const unlocked = sessionStorage.getItem('admin_unlocked') === '1';
  const host = document.getElementById('tabs');
  host.innerHTML = '';

  // 不過濾，全部列出
  window.__TAB_SPECS = (FORM_CONFIG.tabs||[]).map(t => ({ id:t.id, name:t.name, kind:t.kind }));

  window.__TAB_SPECS.forEach((t,i)=>{
    const btn = document.createElement('button');
    btn.className = 'tab' + (i===0 ? ' active' : '');
    // 未解鎖時在標籤上提示（可選）
    btn.textContent = t.name + (t.kind==='admin' && !unlocked ? '（需金鑰）' : '');
    btn.addEventListener('click', ()=> switchTab(i));
    host.appendChild(btn);
  });
}
  
function switchTab(index){
  const specs = window.__TAB_SPECS || [];
  const tabs = document.getElementById('tabs').children;
  for(let i=0;i<tabs.length;i++) tabs[i].classList.toggle('active', i===index);
  specs.forEach((t,i)=>{
    const sec = document.getElementById(t.id);
    if(!sec) return;
    sec.style.display = (i===index) ? 'block' : 'none';
  });
  const names = specs.map(t=>t.kind);
  const h = names[index] || 'basic';
  if (location.hash !== '#'+h) history.replaceState(null,'','#'+h);
}
function applyHash(){
  const unlocked = sessionStorage.getItem('admin_unlocked') === '1';
  const specs = window.__TAB_SPECS || [];
  const names = specs.map(t=>t.kind);
  const map = Object.fromEntries(names.map((n,i)=>[n,i]));
  let key = (location.hash||'').replace('#','');
  switchTab(map[key] ?? 0);
}

/* ===== [06] 問卷渲染 ===== */
function renderAllForms(){
  FORM_CONFIG.tabs.forEach(tab=>{
    if(['basic','admin'].includes(tab.kind)) return;
    const sec = document.getElementById(tab.id);
    if(!sec) return;

    let html = '';
    if (tab.kind === 'messages') {
      const label = (tab.opens && tab.opens[0]) || '請輸入意見';
      html = `<label>${label}</label><textarea id="${tab.id}-open-0" placeholder="請填寫"></textarea>`;
    } else {
      if (Array.isArray(tab.likertTexts)) {
        const rows = tab.likertTexts.map((text,i)=>{
          const n=i+1, name=`${tab.prefix}${n}`;
          const radios=[1,2,3,4,5].map(v=>`<td><input type="radio" name="${name}" value="${v}"></td>`).join('');
          return `<tr><td>${n}. ${text}</td>${radios}</tr>`;
        }).join('');
        html += `<table><tr><th>題目</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>${rows}</table>`;
      }
      if (Array.isArray(tab.opens)) {
        html += tab.opens.map((t,i)=>`<label>${t}</label><textarea id="${tab.id}-open-${i}" placeholder="請填寫"></textarea>`).join('');
      }
      if (Array.isArray(tab.extras)) {
        html += tab.extras.map(ex=>{
          if (ex.type === 'select') {
            const opts = (ex.options||[]).map(o=>{
              const sel = (o.value === ex.default) ? ' selected' : '';
              return `<option value="${o.value}"${sel}>${o.label}</option>`;
            }).join('');
            return `<label>${ex.label}${ex.required?'（必填）':''}</label><select id="${tab.id}-extra-${ex.key}">${opts}</select>`;
          } else {
            const ph = ex.label + (ex.required?'（必填）':'');
            const val = ex.default ? ` value="${ex.default}"` : '';
            return `<label>${ex.label}${ex.required?'（必填）':''}</label><input id="${tab.id}-extra-${ex.key}" type="text" placeholder="${ph}"${val}>`;
          }
        }).join('');
      }
    }

    let host = sec.querySelector('.form-host');
    if(!host){
      host = document.createElement('div');
      host.className='form-host';
      const btns=sec.querySelector('.btns');
      sec.insertBefore(host, btns||null);
    }
    host.innerHTML = html;

    // 綁定主要送出
    const btn = sec.querySelector('.btns .primary');
    if(btn){ btn.onclick = ()=> submitByKind(tab.kind); }    
  });
}
  
/* ===== [07] 讀值/驗證/送出 ===== */
function readLikert(prefix, count){
  const out = [];
  for(let i=1;i<=count;i++){
    const r = document.querySelector(`input[name='${prefix}${i}']:checked`);
    out.push(r ? Number(r.value) : null);
  }
  return out;
}
function buildPayload(tab){
  const base = { module:tab.kind, employeeId:profile.employeeId, fullName:profile.fullName, dept:profile.dept, date:profile.date, ts:Date.now() };
  if (tab.kind === 'messages') {
    const body = (document.getElementById(`${tab.id}-open-0`)?.value || '').trim();
    return { ...base, body };
  }
  const scores = Array.isArray(tab.likertTexts) ? readLikert(tab.prefix, tab.likertTexts.length) : [];
  const opens  = Array.isArray(tab.opens) ? tab.opens.map((_,i)=> (document.getElementById(`${tab.id}-open-${i}`)?.value||'').trim()) : [];
  const extras = {};
  if (Array.isArray(tab.extras)) {
    tab.extras.forEach(ex=>{
      const v = document.getElementById(`${tab.id}-extra-${ex.key}`)?.value || '';
      extras[ex.key] = v.trim();
    });
  }
  if (tab.kind === 'grow360') {
    if (!extras.role) extras.role = 'self';
    if (!extras.rateeId && profile?.employeeId) extras.rateeId = profile.employeeId;
  }
  if (tab.kind === 'course') {
    const c = window.__COURSE__ || {};
    extras.courseId    = extras.courseId    || c.id    || '';
    extras.courseTitle = extras.courseTitle || c.title || '';
  }
if (tab.kind === 'grow360') {
  if (!extras.role) extras.role = 'self';

  const pick = document.getElementById('g360RateeSelect');
  const pickVal = pick ? String(pick.value||'').trim().toUpperCase() : '';

  const filter = document.getElementById('g360RateeFilter');
  const typed  = filter ? String(filter.value||'').trim().toUpperCase() : '';

  if (extras.role === 'self') {
    extras.rateeId = profile.employeeId || pickVal || typed || extras.rateeId || '';
  } else {
    extras.rateeId = pickVal || typed || extras.rateeId || '';
  }
}
   return { ...base, scores, opens, extras };
}
function validateTab(tab){
  if (typeof readBasic === 'function') readBasic();
  if(!profile?.employeeId){ toast('請先於「基本資訊」填寫員工編號'); switchTab(0); return false; }
  if (tab.kind === 'messages') {
    const body = (document.getElementById(`${tab.id}-open-0`)?.value || '').trim();
    if(!body){ toast('請輸入意見內容'); return false; }
    return true;
  }
  if (Array.isArray(tab.likertTexts)) {
    const vals = readLikert(tab.prefix, tab.likertTexts.length);
    const miss = vals.map((v,i)=> v==null ? (i+1) : null).filter(Boolean);
    if(miss.length){ toast(`請完成第 ${miss.join(', ')} 題`); return false; }
  }
  if (Array.isArray(tab.extras)) {
    for (const ex of tab.extras) {
      if (!ex.required) continue;
      let v = document.getElementById(`${tab.id}-extra-${ex.key}`)?.value?.trim() || '';
      if (tab.kind === 'grow360' && ex.key === 'rateeId' && !v && profile?.employeeId) {
        v = profile.employeeId;
        const el = document.getElementById(`${tab.id}-extra-${ex.key}`); if (el) el.value = v;
      }
      if (!v) { toast(`${ex.label} 為必填`); return false; }
    }
  }
if (tab.kind === 'grow360') {
  const role = document.getElementById(`${tab.id}-extra-role`)?.value || 'self';
  const pickVal = document.getElementById('g360RateeSelect')?.value || '';
  if (role !== 'self' && !pickVal) {
    toast('請先從下拉選單選擇「評估對象」');
    return false;
  }
}
  return true;
}
async function submitByKind(kind, opts={}) {
  const tab = FORM_CONFIG.tabs.find(t=> t.kind===kind);
  if(!tab) return;
  if(!validateTab(tab)) return;

  const payload = buildPayload(tab);
  const btn = document.querySelector(`#${tab.id} .btns .primary`);
  const old = btn?.textContent;

  if (btn) { btn.disabled = true; btn.textContent = '傳送中…'; }

  try {
    await submitToGAS(payload);
    toast(`${tab.name} 已送出`);

    if (tab.kind === 'grow360') {
      // ✅ 停留在本頁；清空題目與開放題；保留角色
      // 角色≠self 時，同步清空評估對象（下拉與輸入框），讓你能直接選下一位
      resetGrow360FormFields({ clearRatee: true });

      if (btn) { btn.disabled = false; btn.textContent = old || '送出此評估'; }
      return; // 不跳頁
    }

    // 其他模組維持送出後回基本資訊
    if (btn) { btn.textContent = '✔ 已送出'; }
    switchTab(0);

  } catch (e) {
    console.error(e);
    if (btn) { btn.disabled = false; btn.textContent = old || '送出此評估'; }
    toast('送出失敗：' + e.message);
  }
}

// 清空 grow360 的 1) 單選題 2) 開放題（保留基本資料與角色、評估對象）
function resetGrow360FormFields(opts = {}) {
  const { clearRatee = false } = opts;
  const tab = FORM_CONFIG.tabs.find(t=> t.kind==='grow360');
  if (!tab) return;
  const sec = document.getElementById(tab.id);
  if (!sec) return;

  // 1) 清空 5 點量表
  if (Array.isArray(tab.likertTexts)) {
    for (let i=1; i<=tab.likertTexts.length; i++){
      const n = `${tab.prefix}${i}`;
      sec.querySelectorAll(`input[name='${n}']`).forEach(x=> x.checked = false);
    }
  }

  // 2) 清空開放題
  if (Array.isArray(tab.opens)) {
    tab.opens.forEach((_,i)=>{
      const ta = sec.querySelector(`#${tab.id}-open-${i}`);
      if (ta) ta.value = '';
    });
  }

  // 3) 角色保留；必要時清空評估對象（僅當角色≠self）
  if (clearRatee) {
    const roleSel = document.getElementById(`${tab.id}-extra-role`);
    const isSelf  = (roleSel?.value || 'self') === 'self';
    if (!isSelf) {
      const sel = sec.querySelector('#g360RateeSelect');
      const filter = sec.querySelector('#g360RateeFilter');
      if (sel) sel.value = '';
      if (filter) filter.value = '';
    }
  }
}

// ========== [08] 基本資訊／即時對照名單（加強版） ==========
function readBasic(){
  profile.employeeId = document.getElementById('employeeId')?.value?.trim() || profile.employeeId;
  profile.fullName   = document.getElementById('fullName')?.value?.trim()   || profile.fullName;
  profile.dept       = document.getElementById('dept')?.value?.trim()       || profile.dept;
  profile.date       = document.getElementById('date')?.value               || profile.date;
  const badge = document.getElementById('userIdBadge');
  if (badge) badge.textContent = profile.employeeId || '未設定';
}

// 小工具：簡單 debounce
function debounce(fn, wait){
  let t;
  return (...args)=>{ clearTimeout(t); t = setTimeout(()=> fn.apply(null,args), wait); };
}

// 只在「剛好一個欄位有值」時查；加入去重 / 冷卻，並避免 CORS 預檢
async function resolveEmployeeInstant(source){
  const idEl = document.getElementById('employeeId');
  const nmEl = document.getElementById('fullName');
  if (!idEl || !nmEl) return;

  // 回填中就不觸發
  if (resolveEmployeeInstant._filling) return;

  // 冷卻期（之前失敗過，先暫停自動查）
  if (resolveEmployeeInstant._cooldownUntil && Date.now() < resolveEmployeeInstant._cooldownUntil) return;

  const employeeId = (idEl.value || '').trim();
  const fullName   = (nmEl.value || '').trim();

  // XOR：剛好一個有值才查
  const hasId   = !!employeeId;
  const hasName = !!fullName;
  if (hasId === hasName) return;

  // 同樣輸入重複就不再送
  const sig = employeeId + '|' + fullName;
  if (resolveEmployeeInstant._lastSig === sig) return;
  resolveEmployeeInstant._lastSig = sig;

  const endpoint = getEndpoint && getEndpoint();
  if (!endpoint){
    console.warn('[resolveEmployeeInstant] endpoint 未設定');
    return;
  }

  try{
    // 重要：不要設 Content-Type，避免瀏覽器送 OPTIONS 預檢
    const res = await fetch(endpoint, {
      method:'POST',
      body: JSON.stringify({ action:'resolveEmployee', employeeId, fullName }),
      mode:'cors',
      cache:'no-store',
      redirect:'follow'
    });

    const data = await res.json().catch(()=> ({}));

    if (data?.ok && data.match){
      resolveEmployeeInstant._filling = true;
      idEl.value = data.match.employeeId || '';
      nmEl.value = data.match.fullName   || '';
      const d = document.getElementById('dept');
      if (d) d.value = data.match.dept || '';
      readBasic();
      setTimeout(()=>{ resolveEmployeeInstant._filling = false; }, 0);
    } else if (data?.error === 'AMBIGUOUS_NAME'){
      throttleToast('姓名重複，請改填「員工編號」。');
    } else if (data?.error === 'EMP_NOT_FOUND'){
      throttleToast('找不到這位員工，請確認員工編號或姓名。');
    } else {
      throttleToast('查詢失敗（伺服器回傳異常）。');
    }
  } catch(e){
    console.error(e);
    // 失敗進入 10 秒冷卻期，避免狂打 & 狂跳
    resolveEmployeeInstant._cooldownUntil = Date.now() + 10000;
    throttleToast('查詢失敗：' + (e.message || e));
  }
}

// 10 秒內相同型態的提示只顯示一次
function throttleToast(msg){
  const now = Date.now();
  if (!throttleToast._muteUntil || now > throttleToast._muteUntil){
    toast(msg);
    throttleToast._muteUntil = now + 10000;
  }
}

function bindInstantResolve(){
  const idEl = document.getElementById('employeeId');
  const nmEl = document.getElementById('fullName');
  if (!idEl || !nmEl) return;

  const fireId   = ()=> resolveEmployeeInstant('id');
  const fireName = ()=> resolveEmployeeInstant('name');
  const debId    = debounce(fireId, 600);
  const debName  = debounce(fireName, 600);

  // 觸發條件：blur、change、按 Enter、停筆 600ms
  idEl.addEventListener('blur', fireId);
  nmEl.addEventListener('blur', fireName);

  idEl.addEventListener('change', fireId);
  nmEl.addEventListener('change', fireName);

  idEl.addEventListener('keyup', (e)=> { if (e.key === 'Enter') fireId(); else debId(); });
  nmEl.addEventListener('keyup', (e)=> { if (e.key === 'Enter') fireName(); else debName(); });

  // 初始載入時也同步一次 badge
  readBasic();
}

// 一鍵清除（可選）
function clearIdentity(){
  const idEl = document.getElementById('employeeId');
  const nmEl = document.getElementById('fullName');
  const dEl  = document.getElementById('dept');
  resolveEmployeeInstant._filling = true;
  if (idEl) idEl.value = '';
  if (nmEl) nmEl.value = '';
  if (dEl)  dEl.value  = '';
  resolveEmployeeInstant._filling = false;
  readBasic();
}

// === 讀名冊，回傳 [{employeeId, fullName, dept}, ...] ===
async function fetchRoster(){
  const url = `${getEndpoint()}?action=roster&key=${encodeURIComponent(ADMIN_SECRET)}&t=${Date.now()}`;
  try {
    const res  = await fetch(url, { cache:'no-store', mode:'cors' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    if (!data?.ok || !Array.isArray(data.items)) throw new Error('invalid payload');

    // 後端欄位可能是 employee_id / name / department，這裡做一次映射
    const mapped = data.items.map(r => ({
      employeeId: r.employeeId || r.employee_id || r.id || '',
      fullName:   r.fullName   || r.name       || r.full_name || '',
      dept:       r.dept       || r.department || r.unit      || ''
    })).filter(p => p.employeeId || p.fullName);

    window.__ROSTER__ = mapped;     // 快取
    return mapped;
  } catch (e) {
    console.warn('fetchRoster() 失敗：', e);
    toast('名冊讀取失敗，暫用快取或手動輸入');
    return Array.isArray(window.__ROSTER__) ? window.__ROSTER__ : [];
  }
}

// === 在 grow360 表單頂端插入「評估對象」下拉 + 搜尋（不鎖控制項） ===
async function ensureGrow360RateePicker(){
  const tab = FORM_CONFIG.tabs.find(t=> t.kind==='grow360');
  if (!tab) return;
  const sec = document.getElementById(tab.id);
  if (!sec) return;

  // 已建立就不重複
  if (sec.querySelector('.g360-ratee-picker')) return;

  const host = sec.querySelector('.form-host');
  if (!host) return;

  const box = document.createElement('div');
  box.className = 'g360-ratee-picker';
  box.style.marginBottom = '12px';
  box.innerHTML = `
    <label>評估對象（從名冊選）</label>
    <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center">
      <input id="g360RateeFilter" type="text" placeholder="輸入姓名或員編快速篩選…" />
      <button id="g360ReloadRoster" type="button">重新載入名冊</button>
    </div>
    <select id="g360RateeSelect" style="margin-top:8px">
      <option value="">請選擇要評估的對象</option>
    </select>
    <div class="muted" style="margin-top:4px">
      小提醒：若「角色」選自評，系統會忽略這個選擇並以你的員編為對象。
    </div>
  `;
  host.prepend(box);

  // 名冊載入與渲染（✅ 只宣告一次）
  let roster = await fetchRoster();
  const sel     = box.querySelector('#g360RateeSelect');
  const filter  = box.querySelector('#g360RateeFilter');
  const reload  = box.querySelector('#g360ReloadRoster');

  function renderOptions(keyword=''){
    const kw = String(keyword||'').trim();
    const kwLower = kw.toLowerCase();

    const items = (roster||[]).filter(p =>
      !kwLower ||
      (p.employeeId||'').toLowerCase().includes(kwLower) ||
      (p.fullName||'').toLowerCase().includes(kwLower)
    );

    const opts = [`<option value="">請選擇要評估的對象</option>`]
      .concat(items.map(p =>
        `<option value="${p.employeeId}">${p.employeeId}｜${p.fullName}${p.dept?`（${p.dept}）`:''}</option>`));

    // 沒命中任何人 → 提供「直接使用你的輸入」的臨時選項
    if (kw && items.length === 0){
      opts.push(`<option value="${kw}">使用「${kw}」（未在名冊）</option>`);
    }

    sel.innerHTML = opts.join('');

    // 精準員編命中就自動選
    const exact = (roster||[]).find(p => (p.employeeId||'').toUpperCase() === kw.toUpperCase());
    if (exact) sel.value = exact.employeeId;
  }

  renderOptions('');

  // 即時篩選＋Enter 強制套用
  filter.addEventListener('input', ()=> renderOptions(filter.value));
  filter.addEventListener('keyup', (e)=>{
    if (e.key === 'Enter'){
      renderOptions(filter.value);
      if (!sel.value && filter.value.trim()){
        sel.value = filter.value.trim();
      }
    }
  });

  // 重新載入名冊
  reload.addEventListener('click', async ()=>{
    reload.disabled = true;
    reload.textContent = '載入中…';
    const before = Array.isArray(roster) ? roster.length : 0;
    roster = await fetchRoster();
    renderOptions(filter.value);
    const after = Array.isArray(roster) ? roster.length : 0;
    toast(`名冊已更新（${before} → ${after}）`);
    reload.textContent = '重新載入名冊';
    reload.disabled = false;
  });

  // UX：如果目前角色是 self，但使用者去點選評估對象輸入/下拉，就把角色切到 peer 方便填外評
  const roleSel = document.getElementById(`${tab.id}-extra-role`);
  function ensureNonSelfWhenTyping(){
    if (!roleSel) return;
    if (roleSel.value === 'self') roleSel.value = 'peer';
  }
  filter.addEventListener('focus', ensureNonSelfWhenTyping);
  sel.addEventListener('focus', ensureNonSelfWhenTyping);

  // 初始時若有自己的員編，幫忙預渲染一次（只是讓列表靠近該員）
  if (profile?.employeeId) renderOptions(profile.employeeId);
}

/* ===== [09] 匿名圖表 ===== */
async function fetchAnalytics(names){
  const endpoint = getEndpoint();
  const url = `${endpoint}?action=analytics&names=${encodeURIComponent(names.join(','))}&key=${encodeURIComponent(ADMIN_SECRET)}&t=${Date.now()}`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data?.ok) throw new Error('analytics API 失敗');
  return data.items || {};
}
function drawLine(canvasId, labels, values, label){
  const el = document.getElementById(canvasId); if (!el) return;
  if (el._chart) el._chart.destroy();
  el._chart = new Chart(el, {
    type:'line',
    data:{ labels, datasets:[{ label, data: values }] },
    options:{ responsive:true, scales:{ y:{ suggestedMin:1, suggestedMax:5 } } }
  });
}
function drawBar(canvasId, labels, values, label){
  const el = document.getElementById(canvasId); if (!el) return;
  if (el._chart) el._chart.destroy();
  el._chart = new Chart(el, {
    type:'bar',
    data:{ labels, datasets:[{ label, data: values }] },
    options:{ responsive:true, scales:{ y:{ suggestedMin:1, suggestedMax:5 } } }
  });
}
async function renderAdminCharts(){
  const panel = document.getElementById('adminPanel');
  if (!panel) return;
  try{
    const names = ['weekly_compare','stats_skill','stats_course','stats_locate'];
    const items = await fetchAnalytics(names);

    // ① 各課程整體滿意度（Q1~Q3 平均）
    const csAll = items.stats_course || [];
    const byCourse = {};
    csAll.forEach(r=>{
      const q = String(r.question || r['question'] || '').toUpperCase();
      if (!/^Q[1-3]$/.test(q)) return;
      const cid = String(r.courseId||'').trim();
      const title = String(r.courseTitle||'').trim();
      const avg = Number(r.avg || r['avg'] || r['平均 avg'] || 0);
      if (!cid) return;
      if (!byCourse[cid]) byCourse[cid] = { title, sum:0, n:0 };
      byCourse[cid].sum += avg; byCourse[cid].n += 1;
    });
    const courseRows = Object.entries(byCourse).map(([cid, v])=>({ id:cid, title:v.title, avg:+(v.sum/(v.n||1)).toFixed(2) }))
      .sort((a,b)=> b.avg - a.avg);
    drawBar('chartCourseOverall',
      courseRows.map(x=> `${x.id} ${x.title}`.trim()),
      courseRows.map(x=> x.avg),
      '各課程整體滿意度（Q1~Q3 平均）'
    );

    // ② 每周問卷整體平均（把 Q*_avg 平均）
    const wk = items.weekly_compare || [];
    const qCols = wk.length ? Object.keys(wk[0]).filter(k=>/^Q\d+_avg$/.test(k)).sort((a,b)=>+a.slice(1)-+b.slice(1)) : [];
    const wkLabels = wk.map(r=> String(r.date||r['date']||''));
    const wkSeries = wk.map(r=>{
      if (!qCols.length) return 0;
      const sum = qCols.reduce((s,k)=> s + Number(r[k]||0), 0);
      return +(sum / qCols.length).toFixed(2);
    });
    drawLine('chartWeeklyTrend', wkLabels, wkSeries, '每周問卷整體平均（每日）');

    // ③ 初期 locate 各題平均
    const loc = (items.stats_locate || []).filter(r=> r['題號 question']);
    drawBar('chartLocateAvg',
      loc.map(r=> String(r['題號 question'])),
      loc.map(r=> +Number(r['平均 avg']||0).toFixed(2)),
      '初期（locate）各題平均'
    );

    // ④ 中期 skill 各題平均
    const sk = (items.stats_skill || []).filter(r=> r['題號 question']);
    drawBar('chartSkillAvg',
      sk.map(r=> String(r['題號 question'])),
      sk.map(r=> +Number(r['平均 avg']||0).toFixed(2)),
      '中期（skill）各題平均'
    );

    panel.style.display = 'block';
  }catch(e){
    console.warn('renderAdminCharts() 失敗：', e);
    panel.style.display = 'block';
    document.getElementById('adminCharts')?.insertAdjacentHTML('afterbegin', `<div class="muted">（載入圖表失敗：${(e.message||e)}）</div>`);
  }
}

/* ===== [10] Admin 解鎖 ===== */
function bindAdminUnlock(){
  const unlockBtn  = document.getElementById('adminUnlock');
  const keyInput   = document.getElementById('adminKey');
  const adminPanel = document.getElementById('adminPanel');
  if (!unlockBtn || !keyInput || !adminPanel) return;

  adminPanel.style.display = 'none';

  const wasUnlocked = sessionStorage.getItem('admin_unlocked') === '1';
  if (wasUnlocked) { adminPanel.style.display = 'block'; renderAdminCharts(); }

  unlockBtn.addEventListener('click', ()=>{
    const key = (keyInput.value || '').trim();
    if (key !== ADMIN_SECRET){ alert('金鑰錯誤'); return; }
    sessionStorage.setItem('admin_unlocked','1');
    adminPanel.style.display = 'block';
    alert('已解鎖管理功能');
    renderAdminCharts();
    // 重新渲染 tabs，插回 Admin
    renderTabs(); applyHash();
  });
}

/* ===== [11] 課堂：URL 預選 ===== */
function applyCourseFromQuery(){
  const q = getQuery();
  if ((q.module||'').toLowerCase() !== 'course') return;
  window.__COURSE__ = { id: (q.courseId || q.id || ''), title: (q.title || '') };

  const hdr = document.getElementById('courseHeader');
  if (hdr){
    const txt = [window.__COURSE__?.id, window.__COURSE__?.title].filter(Boolean).join('｜');
    hdr.textContent = txt ? `（${txt}）` : '（未指定課程）';
  }
  const picker = document.getElementById('coursePicker');
  if (picker && (window.__COURSE__?.id || window.__COURSE__?.title)) picker.style.display = 'none';

  const idx = (FORM_CONFIG.tabs || []).findIndex(t=> t.kind==='course');
  if (idx >= 0) switchTab(idx);
}

/* ===== [12] 課程清單補填 ===== */
async function loadCourseListForMakeup(){
  const q = getQuery();
  const hasPreset = (q.module||'').toLowerCase()==='course' && (q.id || q.courseId || q.title);
  if (hasPreset) return;

  const picker   = document.getElementById('coursePicker');
  const selectEl = document.getElementById('courseSelect');
  if (!picker || !selectEl) return;

  picker.style.display = 'grid';

  try{
    const url = `${getEndpoint()}?action=courselist&t=${Date.now()}`;
    const res = await fetch(url);
    const data = await res.json();

    if (!data?.ok || !Array.isArray(data.items) || data.items.length === 0){
      selectEl.innerHTML = '<option value="">（目前沒有可選課程，請在試算表 courselist 新增）</option>';
      return;
    }

    const frag = document.createDocumentFragment();
    const ph = document.createElement('option'); ph.value=''; ph.textContent='請選擇課程'; frag.appendChild(ph);

    data.items.forEach(({id, title, instructor})=>{
      const opt = document.createElement('option');
      opt.value = id;
      opt.dataset.title = title || '';
      opt.textContent = instructor ? `${id}｜${title}（${instructor}）` : `${id}｜${title}`;
      frag.appendChild(opt);
    });

    selectEl.innerHTML = '';
    selectEl.appendChild(frag);

    selectEl.onchange = ()=>{
      const opt = selectEl.options[selectEl.selectedIndex];
      const id = selectEl.value || '';
      const title = opt?.dataset?.title || '';
      window.__COURSE__ = { id, title };
      const hdr = document.getElementById('courseHeader');
      if (hdr) hdr.textContent = id ? `（${id}｜${title}）` : '';
    };
  }catch(e){
    console.warn('載入課程清單失敗：', e);
    selectEl.innerHTML = '<option value="">（清單載入失敗，稍後再試）</option>';
  }
}

/* ========== [13] 初始化 ========== */
function init(){
  renderTabs();
  (FORM_CONFIG.tabs||[]).forEach((t,i)=>{
    const el = document.getElementById(t.id);
    if (el) el.style.display = (i===0 ? 'block' : 'none');
  });
  renderAllForms();
  applyHash();
  window.addEventListener('hashchange', applyHash);

  // 本地時區安全的「填入今天」
function fillTodayLocalISO(){
  const now = new Date();
  const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
  return local.toISOString().slice(0,10); // yyyy-mm-dd
}

document.getElementById('fillToday')?.addEventListener('click', ()=>{
  const el = document.getElementById('date');
  if (el) el.value = fillTodayLocalISO();
  if (typeof readBasic === 'function') readBasic();
});

document.getElementById('clearIdentityBtn')?.addEventListener('click', clearIdentity);  

}
  
  async function checkGASEndpoint(){
  try{
    const url = `${getEndpoint()}?action=ping&t=${Date.now()}`;
    const res = await fetch(url, { cache:'no-store', mode:'cors' });
    const data = await res.json();
    if (!data?.ok) throw new Error('ping not ok');
    return true;
  }catch(e){
    console.warn('GAS 端點 ping 失敗：', e);
    // 停用即時查詢，避免使用者每打字就出錯
    resolveEmployeeInstant._cooldownUntil = Date.now() + 60_000; // 1 分鐘
    toast('後端暫時無法連線，員編/姓名自動對照已暫停。');
    return false;
  }
}

// 讓「立即前往」按鈕能切換到對應分頁
function bindGuideJumpers(){
  document.querySelectorAll('[data-goto]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const targetId = btn.getAttribute('data-goto');
      // 在 __TAB_SPECS 找對應 index（以 tab.id 比對）
      const specs = window.__TAB_SPECS || [];
      const idx = specs.findIndex(t => t.id === targetId);
      if (idx >= 0) {
        switchTab(idx);
        // 捲動到頁面頂部，讓表單從題首開始
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });
  });
}
  
document.addEventListener('DOMContentLoaded', async ()=>{
  init();
  bindGuideJumpers();           // ← 新增
  bindAdminUnlock();
  await checkGASEndpoint();       // ← 先做健康檢查
  bindInstantResolve();           // 再綁自動查詢
  applyCourseFromQuery();
  loadCourseListForMakeup();
  await ensureGrow360RateePicker();   // ← 新增
});
  
</script>
</body>
</html>
