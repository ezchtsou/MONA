<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>新進員工訓練回饋系統</title>
  <style>
    :root{--bg:#f8fafc;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--brand:#0ea5e9;--active:#dbeafe;--danger:#fecaca}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans CJK TC",sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.5px}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{border:1px solid #e5e7eb;background:#fff;color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
    .tab.active{border-color:var(--brand);box-shadow:0 0 0 1px inset var(--brand)}
    main{padding:24px}
    section.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:20px;margin:18px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input[type=text],input[type=date],input[type=email],select,textarea{width:100%;background:#fff;color:var(--text);border:1px solid #e5e7eb;border-radius:10px;padding:10px}
    textarea{min-height:88px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    button{border:1px solid #e5e7eb;background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button.primary{border-color:var(--brand);box-shadow:0 0 0 1px inset var(--brand)}
    .muted{color:var(--muted);font-size:12px}
    .toast{position:fixed;right:16px;bottom:16px;padding:10px 14px;background:#fff;border:1px solid #e5e7eb;border-radius:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{text-align:left;border-bottom:1px solid #e5e7eb;padding:6px}
    /* 高亮已選的單選框所在儲存格（現代瀏覽器支援 :has） */
    td:has(input[type=radio]:checked){background:var(--active)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h1>新進員工訓練回饋系統</h1>
        <span class="muted">使用者ID：<strong id="userIdBadge">未設定</strong></span>
      </div>
      <nav id="tabs" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"></nav>
    </div>
  </header>
  <main class="wrap">
    <section id="tab-0" class="card">
      <h2>🔑 基本資訊</h2>
      <div class="row">
        <div>
          <label>使用者代號（employeeId）</label>
          <input id="employeeId" type="text" placeholder="例如：9999M0000" />
        </div>
        <div>
          <label>姓名</label>
          <input id="fullName" type="text" placeholder="例如：王小明" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>單位 / 部門</label>
          <input id="dept" type="text" placeholder="例如：車輛課／軌土課／通號課" />
        </div>
        <div>
          <label>今天日期</label>
          <input id="date" type="date" />
          <div class="btns"><button id="fillToday" type="button">填入今天</button></div>
        </div>
      </div>
    </section>

 <section id="tab-7" class="card">
  <h2>📘 課堂問卷 <span id="courseHeader" class="muted"></span></h2>
  <div id="coursePicker" class="row" style="margin-bottom:12px; display:none">
    <div>
      <label>選擇課程（補填）</label>
      <select id="courseSelect"><option value="">請選擇課程</option></select>
    </div>
  </div>
  <p class="muted">請以五點量表作答（1＝非常不同意，5＝非常同意）。</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">送出課堂問卷</button></div>
</section>
    
<!-- 🗓 每周問卷 -->
   <section id="tab-6" class="card">
  <h2>🗓 每周問卷</h2>
  <p>請以五點量表作答（1＝非常不同意，5＝非常同意），並完成開放題：</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">送出每周問卷</button></div>
</section>
    
   <section id="tab-1" class="card">
  <h2>🩵 初期問卷</h2>
  <p>請針對以下指標進行評分（1＝非常不同意，5＝非常同意）：</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">送出初期問卷</button></div>
</section>
    
    <section id="tab-2" class="card">
  <h2>💡 中期課程回饋</h2>
  <p>請評估以下學習成效（1＝非常不同意，5＝非常同意）：</p>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">送出中期問卷</button></div>
</section>

    <section id="tab-3" class="card">
  <h2>🔶 後期五個向度評估</h2>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">送出後期評估</button></div>
</section>

    <section id="tab-4" class="card">
  <h2>💬 意見反映</h2>
  <div class="form-host"></div>
  <div class="btns"><button class="primary" type="button">送出留言</button></div>
</section>
    
    <section id="tab-5" class="card">
  <h2>🛠️ 管理設定（Admin）</h2>
  <p class="muted">輸入管理金鑰後即可編輯與測試 GAS Web App URL。</p>

  <div class="row">
    <div>
      <label>管理金鑰</label>
      <input id="adminKey" type="password" placeholder="請輸入金鑰" />
      <div class="btns">
        <button id="adminUnlock" type="button">啟用編輯</button>
      </div>
    </div>

    <div>
      <label>GAS Web App URL（/exec）</label>
      <input id="gas_url" type="text" readonly />
      <div class="btns">
        <button id="gasTestBtn" type="button">測試連線（PING）</button>
      </div>
    </div>
  </div>
</section>
    
  </main>
  
<script>

function getQuery(){ try { return Object.fromEntries(new URL(location.href).searchParams.entries()); } catch { return {}; } }

function applyCourseFromQuery(){
  const q = getQuery();
  // 支援 ?module=course&id=E102&title=列車制動
  if ((q.module||'').toLowerCase() !== 'course') return;

  // 存到全域，給送出打包
  window.__COURSE__ = {
    id: q.courseId || q.id || '',
    title: q.title || ''
  };

  // 顯示在頁面標題上
  if (hdr){
    const txt = [window.__COURSE__?.id, window.__COURSE__?.title].filter(Boolean).join('｜');
    hdr.textContent = txt ? `（${txt}）` : '（未指定課程）';
  }

  // ★ 若 URL 已有預選課程 → 隱藏補登選單
  const picker = document.getElementById('coursePicker');
  if (picker && (window.__COURSE__?.id || window.__COURSE__?.title)) {
    picker.style.display = 'none';
  }
  const hdr = document.getElementById('courseHeader');
  if (hdr){
    const txt = [window.__COURSE__?.id, window.__COURSE__?.title].filter(Boolean).join('｜');
    hdr.textContent = txt ? `（${txt}）` : '（未指定課程）';
  }

  // 自動切到課堂問卷分頁（找出 course tab 的索引）
  const idx = (FORM_CONFIG.tabs || []).findIndex(t=> t.kind==='course');
  if (idx >= 0) switchTab(idx);
}

/***** 0) 公用保底：profile / toast / submitToGAS *****/
window.profile = window.profile || { employeeId:'', fullName:'', dept:'', date:(new Date()).toISOString().slice(0,10) };
window.toast = window.toast || (msg => alert(msg));

// 用 POST 提交，不設 Content-Type（避免 CORS 預檢），並提供更清楚的錯誤
async function submitToGAS(payload){
  const inputEl = document.getElementById('gas_url');
  const fromQS  = (location.search.match(/[?&]gas=([^&]+)/)||[])[1];
  const endpoint = window.GAS_ENDPOINT || fromQS || (inputEl && inputEl.value);
  if(!endpoint) throw new Error('未設定 GAS Web App URL（可在網址 ?gas=... 或 #管理設定 填入）');

  let res;
  try {
    // 不設 headers，瀏覽器會用 text/plain 送出 → 不會觸發預檢
    res = await fetch(endpoint, {
      method: 'POST',
      body: JSON.stringify(payload),
    });
  } catch (e) {
    throw new Error('無法連線到 GAS（網路/CORS）：' + (e.message || '連線失敗'));
  }

  // 先拿文字來觀察，再嘗試解析 JSON（避免因 CORS/opaque 直接丟失細節）
  let text;
  try {
    text = await res.text();
  } catch (e) {
    throw new Error('無法解析 GAS 回應（read body 失敗）');
  }
  try {
    const data = JSON.parse(text);
    if(!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
    return data;
  } catch (e) {
    throw new Error('GAS 非 JSON 回應（可能是舊部署/權限/白名單）：' + String(text).slice(0,200));
  }
}

/***** 1) 設定：所有問卷集中在這裡 *****/
const FORM_CONFIG = {
  tabs: [
    { id:'tab-0', name:'基本資訊', kind:'basic' },

    { id:'tab-6', name:'每周問卷', kind:'weekly', prefix:'wk',
      likertTexts:[
        '本週我能順利完成分配的任務與作業。',
        '我覺得自己比上週更熟悉工作流程。',
        '當工作中出現問題時，我能清楚知道解決方向。',
        '本週與前輩或同事的合作互動順利。',
        '我在現場觀察到新的知識或技巧，並願意主動學習。',
        '我覺得自己的專注力與體力能應付目前的訓練需求。',
        '我覺得目前的課程安排與實作比例適合我的學習步調。',
        '培訓資訊（如時間、地點、內容）是否清楚且容易取得？'
      ],
      opens:[
        '訓練內容回饋與心得（請針對課程內容分享學習摘要與收穫，至少100字）。',
        '訓練課程提問（請提出您對本周訓練內容的疑問、改進建議或希望加強的部分，也歡迎創意提問，至少填寫一項）'
      ]
    },
    
    { id:'tab-1', name:'初期訓練', kind:'locate', prefix:'loc',
      likertTexts:[
        '我清楚知道蒸飯箱、微波爐、洗碗槽等設施的位置與使用規範。',
        '我能順利找到休息區與淋浴間等空間。',
        '我知道廠區內各項設施的位置。',
        '我了解公司的整體組織架構與各部門位置。',
        '我知道自己隸屬的單位及工作任務。',
        '我知道該與哪些單位或同事配合完成工作。',
        '我知道直接主管是誰，了解主管的職責與期望。',
        '我知道遇到問題時可以向哪些同事或主管求助。',
        '我已了解薪資結構、差勤與請假制度。',
        '我已了解公司各網站的操作，並可以順利登入。'
      ],
      opens:['請分享前三天中最幫助你融入環境的一項安排，或你覺得可改進的地方。']
    },

    { id:'tab-2', name:'中期技能', kind:'skill', prefix:'sk',
      likertTexts:[
        '技能課程的內容能應用於實際工作。',
        '我清楚公司的安全規範與品質要求。',
        '我能熟練操作課程中學到的技能。',
        '課程時間與進度安排合理。',
        '我能分辨哪些行為會影響安全或品質。' ,       
        '我能清楚說明理論課程中所學到的基本概念與原理。',
        '理論課程內容與我目前在現場看到的設備與流程相符。',
        '理論課程中的範例或說明，有助於我理解實際的工作流程。',
        '理論課程讓我在現場能更快理解維修工作的邏輯或原理。',
        '我已能理解實作課程中各步驟的目的與注意事項。',
        '我能在前輩指導下完成部分簡單任務（如協助檢查、清潔、工具準備等）。',
        '在現場維修過程中，我能看／聽懂指導人員使用的術語與流程。',
        '當看到實際設備時，我能聯想到理論課程中學過的內容。',
        '當遇到問題時，我會主動翻閱SOP或培訓教材尋找解決方式。',
        '我能判斷哪些問題可以自己處理，哪些需要請教前輩。',
        '我能從前輩的示範中學習並逐步改善自己的操作方式。',
        '前輩或同事願意給予我具體的指導與回饋。',
        '在現場學習時，我能主動發問並得到正向回應。'
      ],
      opens:['我覺得理論課程與實作課程的銜接程度良好，能幫助我穩定成長。','請寫下你認為「理論課程最有幫助的部分」與「實作訓練最需要改進的地方」。'],
    },

    { id:'tab-3', name:'後期五個向度評估', kind:'grow360', prefix:'gr',
  likertTexts:[
    '該員工能在期限內完成交辦任務。',
    '該員工的工作品質穩定且可靠。',
    '該員工在工作上注重細節並追求改進。',
    '該員工能依指示處理突發狀況。',
    '該員工能對自己的過失負責。',
    '該員工能與同事良好合作、溝通順暢。',
    '該員工能主動協助他人或支援團隊任務。',
    '該員工在工作中表現積極，樂於學習。',
    '當任務優先順序改變時，該員工能快速調整。',
    '該員工在壓力或批評下仍能保持專業表現。',
    '該員工具備良好的問題解決與判斷能力。',
    '我對該員工做出正確決策的能力有信心。',
    '該員工對工作環境的影響是正面的。',
    '您向其他同事推薦該員工的可能性有多大？（1＝絕不推薦，5＝非常推薦。）',
  ],
  opens:['請列出該員工表現最優秀的三個面向。','請列出該員工最需要改進的三個部分或建議其成長方向。'],
  extras:[
    { key:'role',   label:'角色', type:'select', required:true,
      options:[
        {value:'self',    label:'自評（預設）'},
        {value:'manager', label:'直屬主管'},
        {value:'peer',    label:'同事'},
        {value:'mentor',  label:'導師'}
      ],
      default:'self'
    },
    { key:'rateeId',label:'評估對象（employeeId）', required:true }
  ]
},

    { id:'tab-4', name:'意見反映', kind:'messages',
      opens:['留言內容']
    },

    { id:'tab-5', name:'管理設定', kind:'admin' },

    { id:'tab-7', name:'課堂問卷', kind:'course', prefix:'cq',
  likertTexts:[
    '我在這堂訓練課程學習到新的觀念與技巧。',
    '訓練講師具備專業知能與技術，且表達良好。',
    '我對於課程非常滿意。'
  ],
     opens:[
    '請寫下本堂課讓你最有收穫的一點（或建議改進之處）。']
},
  ]
};

/***** 2) 分頁 UI *****/
function renderTabs(){
  const tabsHost = document.getElementById('tabs');
  const specs = FORM_CONFIG.tabs.map(t=>({id:t.id, name:t.name}));
  window.__TAB_SPECS = specs;
  tabsHost.innerHTML = '';
  specs.forEach((t,i)=>{
    const btn = document.createElement('button');
    btn.className = 'tab'+(i===0?' active':'');
    btn.textContent = t.name;
    btn.addEventListener('click', ()=> switchTab(i));
    tabsHost.appendChild(btn);
  });
}
function switchTab(index){
  const specs = window.__TAB_SPECS || [];
  const tabs = document.getElementById('tabs').children;
  for(let i=0;i<tabs.length;i++) tabs[i].classList.toggle('active', i===index);
  specs.forEach((t,i)=>{
    const sec = document.getElementById(t.id);
    if(!sec) return;
    sec.style.display = (i===index) ? 'block' : 'none';
  });
  const names = FORM_CONFIG.tabs.map(t=>t.kind);
  const h = names[index] || FORM_CONFIG.tabs[0].kind;
  if(location.hash !== '#'+h) history.replaceState(null,'','#'+h);
}
function applyHash(){
  const names = FORM_CONFIG.tabs.map(t=>t.kind);
  const map = Object.fromEntries(names.map((n,i)=>[n,i]));
  const key = (location.hash||'').replace('#','');
  switchTab(map[key] ?? 0);
}

/***** 3) 自動渲染所有問卷 *****/
function renderAllForms(){
  FORM_CONFIG.tabs.forEach(tab=>{
    if(['basic','admin'].includes(tab.kind)) return; // 非問卷頁略過
    const sec = document.getElementById(tab.id);
    if(!sec) return;

    let html = '';
    if (tab.kind === 'messages') {
      const label = (tab.opens && tab.opens[0]) || '請輸入意見';
      html = `
        <label>${label}</label>
        <textarea id="${tab.id}-open-0" placeholder="請填寫"></textarea>
      `;
    } else {
      if (Array.isArray(tab.likertTexts)) {
        const rows = tab.likertTexts.map((text,i)=>{
          const n=i+1, name=`${tab.prefix}${n}`;
          const radios=[1,2,3,4,5].map(v=>`<td><input type="radio" name="${name}" value="${v}"></td>`).join('');
          return `<tr><td>${n}. ${text}</td>${radios}</tr>`;
        }).join('');
        html += `
          <table>
            <tr><th>題目</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>
            ${rows}
          </table>`;
      }
      if (Array.isArray(tab.opens)) {
        html += tab.opens.map((t,i)=>`
          <label>${t}</label>
          <textarea id="${tab.id}-open-${i}" placeholder="請填寫"></textarea>
        `).join('');
      }
      // 額外欄位（extras）
if (Array.isArray(tab.extras)) {
  html += tab.extras.map(ex=>{
    if (ex.type === 'select') {
      const opts = (ex.options||[]).map(o=>{
        const sel = (o.value === ex.default) ? ' selected' : '';
        return `<option value="${o.value}"${sel}>${o.label}</option>`;
      }).join('');
      return `
        <label>${ex.label}${ex.required?'（必填）':''}</label>
        <select id="${tab.id}-extra-${ex.key}">${opts}</select>
      `;
    } else {
      // text 輸入
      const ph = ex.label + (ex.required?'（必填）':'');
      const val = ex.default ? ` value="${ex.default}"` : '';
      return `
        <label>${ex.label}${ex.required?'（必填）':''}</label>
        <input id="${tab.id}-extra-${ex.key}" type="text" placeholder="${ph}"${val}>
      `;
    }
  }).join('');
}
    }
    let host = sec.querySelector('.form-host');
    if(!host){ host = document.createElement('div'); host.className='form-host'; const btns=sec.querySelector('.btns'); sec.insertBefore(host, btns||null); }
    host.innerHTML = html;

    // 綁定送出按鈕
    const btn = sec.querySelector('.btns .primary');
    if(btn){ btn.onclick = ()=> submitByKind(tab.kind); }
  });
}

/***** 4) 讀值/驗證/打包 *****/
function readLikert(prefix, count){
  const out = [];
  for(let i=1;i<=count;i++){
    const r = document.querySelector(`input[name='${prefix}${i}']:checked`);
    out.push(r ? Number(r.value) : null);
  }
  return out;
}
function buildPayload(tab){
  const base = {
    module: tab.kind,
    employeeId: profile.employeeId,
    fullName:   profile.fullName,
    dept:       profile.dept,
    date:       profile.date,
    ts:         Date.now()
  };

  // messages：只送 body
  if (tab.kind === 'messages') {
    const body = (document.getElementById(`${tab.id}-open-0`)?.value || '').trim();
    return { ...base, body };
  }

  // 其它問卷：scores / opens / extras
  const scores = Array.isArray(tab.likertTexts) ? readLikert(tab.prefix, tab.likertTexts.length) : [];
  const opens  = Array.isArray(tab.opens) ? tab.opens.map((_,i)=> (document.getElementById(`${tab.id}-open-${i}`)?.value||'').trim()) : [];
  const extras = {};
  if (Array.isArray(tab.extras)) {
    tab.extras.forEach(ex=>{
      const v = document.getElementById(`${tab.id}-extra-${ex.key}`)?.value || '';
      extras[ex.key] = v.trim();
    });
  }

  // ★ grow360 保底：role 預設 self；rateeId 空白時帶本人 ID
  if (tab.kind === 'grow360') {
    if (!extras.role) extras.role = 'self';
    if (!extras.rateeId && profile?.employeeId) extras.rateeId = profile.employeeId;
  }

if (tab.kind === 'course') {
  const c = window.__COURSE__ || {};
  extras.courseId    = extras.courseId    || c.id || '';
  extras.courseTitle = extras.courseTitle || c.title || '';
}
  
  return { ...base, scores, opens, extras };
}

function validateTab(tab){
  if (typeof readBasic === 'function') readBasic();
  if(!profile?.employeeId){ toast('請先於「基本資訊」填寫使用者代號'); switchTab(0); return false; }

  if (tab.kind === 'messages') {
    const body = (document.getElementById(`${tab.id}-open-0`)?.value || '').trim();
    if(!body){ toast('請輸入意見內容'); return false; }
    return true;
  }

  // Likert 必填檢查
  if (Array.isArray(tab.likertTexts)) {
    const vals = readLikert(tab.prefix, tab.likertTexts.length);
    const miss = vals.map((v,i)=> v==null ? (i+1) : null).filter(Boolean);
    if(miss.length){ toast(`請完成第 ${miss.join(', ')} 題`); return false; }
  }

  // ★ extras 必填檢查（例如 grow360 的 role / rateeId）
  if (Array.isArray(tab.extras)) {
    for (const ex of tab.extras) {
      if (!ex.required) continue;
      let v = document.getElementById(`${tab.id}-extra-${ex.key}`)?.value?.trim() || '';
      // grow360：rateeId 可用本人 ID 作為預設
      if (tab.kind === 'grow360' && ex.key === 'rateeId' && !v && profile?.employeeId) {
        v = profile.employeeId;
        const el = document.getElementById(`${tab.id}-extra-${ex.key}`); if (el) el.value = v;
      }
      if (!v) { toast(`${ex.label} 為必填`); return false; }
    }
  }
  return true;
}

async function submitByKind(kind){
  const tab = FORM_CONFIG.tabs.find(t=> t.kind===kind);
  if(!tab) return;
  if(!validateTab(tab)) return;
  const payload = buildPayload(tab);
  const btn = document.querySelector(`#${tab.id} .btns .primary`);
  const old = btn?.textContent;
  if(btn){ btn.disabled=true; btn.textContent='傳送中…'; }
  try{
    await submitToGAS(payload);
    if(btn){ btn.textContent='✔ 已送出'; }
    toast(`${tab.name} 已送出`);
    switchTab(0);
  }catch(e){
    console.error(e);
    if(btn){ btn.disabled=false; btn.textContent=old; }
    toast('送出失敗：'+e.message);
    if (Array.isArray(tab.extras)) {
  for (const ex of tab.extras) {
    if (ex.required) {
      const v = document.getElementById(`${tab.id}-extra-${ex.key}`)?.value?.trim() || '';
      if (!v && !(tab.kind==='grow360' && ex.key==='rateeId' && profile?.employeeId)) {
        toast(`${ex.label} 為必填`);
        return false;
      }
    }
  }
}
   
  }
}

/***** 5) 基本資訊輔助（可用你的原版覆蓋） *****/
function readBasic(){
  profile.employeeId = document.getElementById('employeeId')?.value?.trim() || profile.employeeId;
  profile.fullName   = document.getElementById('fullName')?.value?.trim()   || profile.fullName;
  profile.dept       = document.getElementById('dept')?.value?.trim()       || profile.dept;
  profile.date       = document.getElementById('date')?.value               || profile.date;
  const badge = document.getElementById('userIdBadge'); if(badge) badge.textContent = profile.employeeId || '未設定';
}
document.getElementById('fillToday')?.addEventListener('click', ()=>{
  const el = document.getElementById('date');
  if(el){ el.value = new Date().toISOString().slice(0,10); readBasic(); }
});

/***** 6) 初始化 *****/
function init(){
  // 1) 生成分頁按鈕
  renderTabs();

  // 2) 先隱藏除第 1 頁以外的分頁
  FORM_CONFIG.tabs.slice(1).forEach(t=>{
    const el = document.getElementById(t.id);
    if (el) el.style.display = 'none';
  });

  // 3) 根據 FORM_CONFIG 自動渲染所有問卷
  renderAllForms();

  // 4) hash 導航
  applyHash();
  window.addEventListener('hashchange', applyHash);

  // 5) ★ 課堂問卷：讀取 URL 參數（module=course&id=...&title=...），自動切到課堂問卷並顯示課名
  applyCourseFromQuery();

  // 6) ★ 在 DOM 準備好後，再綁定「測試連線」按鈕
  const pingBtn = document.getElementById('gasTestBtn');
  if (pingBtn) {
    pingBtn.addEventListener('click', async ()=>{
      const endpoint = window.GAS_ENDPOINT || document.getElementById('gas_url')?.value;
      if(!endpoint){ alert('請先設定 GAS /exec'); return; }
      try{
        const r = await fetch(endpoint + '?get=1');
        const t = await r.text();
        alert('PING 回應：\n' + t.slice(0,500));
      }catch(e){
        alert('PING 失敗：' + (e.message || e));
      }
    });
  }
}

// ★ 新增：管理金鑰驗證與解鎖
// === 管理金鑰 & 預設 URL（你可以改這兩行） ===
const ADMIN_SECRET     = 'MONAADMIN'; // ← 換密碼就改這行
const DEFAULT_GAS_URL  = 'https://script.google.com/macros/s/AKfycbylnQs-FaohoCe0wdEw_xQyhLNX0jq_Hcou3Ndxgfq1YdPcs4114PNTp64b619qUpGa/exec'; // ← 你的 /exec

// === 綁定「啟用編輯」邏輯：解鎖後才顯示/可編輯 GAS URL ===
function bindAdminUnlock() {
  const unlockBtn = document.getElementById('adminUnlock');
  const keyInput  = document.getElementById('adminKey');
  const gasInput  = document.getElementById('gas_url');
  if (!unlockBtn || !keyInput || !gasInput) return;

  // 預設先隱藏內容（不影響 placeholder）
  gasInput.value = '';               // 清空顯示
  gasInput.setAttribute('readonly', ''); // 保持唯讀

  // 若本次瀏覽已解鎖過（sessionStorage），自動顯示與解鎖
  if (sessionStorage.getItem('admin_unlocked') === '1') {
    gasInput.removeAttribute('readonly');
    gasInput.value = DEFAULT_GAS_URL;
  }

  unlockBtn.addEventListener('click', () => {
    const key = (keyInput.value || '').trim();
    if (key !== ADMIN_SECRET) {
      alert('金鑰錯誤');
      return;
    }
    gasInput.removeAttribute('readonly');
    if (!gasInput.value) gasInput.value = DEFAULT_GAS_URL; // 解鎖後才填入
    sessionStorage.setItem('admin_unlocked', '1');
    alert('已解鎖，可編輯 GAS URL');
  });
}


// 在 init() 執行後呼叫
document.addEventListener('DOMContentLoaded', () => {
  init();
  loadCourseListForMakeup();
  bindAdminUnlock(); // ★ 加上這行
});

  
async function loadCourseListForMakeup(){
  // 若 URL 已帶 id/title 就不用顯示補登選單（掃 QR 直接進）
  const q = getQuery();
  const hasPreset = (q.module||'').toLowerCase() === 'course' && (q.id || q.courseId || q.title);
  if (hasPreset) return;

  const picker = document.getElementById('coursePicker');
  const selectEl = document.getElementById('courseSelect');
  if (!picker || !selectEl) return;

  // 顯示補登選單（預設隱藏）
  picker.style.display = 'grid';

  // 取得 GAS Web App URL
  const endpoint = (window.GAS_ENDPOINT || document.getElementById('gas_url')?.value || '').trim();
  if (!endpoint){
    // 沒設定就僅顯示 placeholder
    selectEl.innerHTML = '<option value="">（尚未設定 GAS /exec，無法載入課程清單）</option>';
    return;
  }

  try{
    // ★ 帶上 origin，後端有白名單檢查（允許空 origin 但帶上更穩妥）
    const url = `${endpoint}?action=courselist&origin=${encodeURIComponent(location.origin)}`;
    const res = await fetch(url);
    const data = await res.json();

    if (!data?.ok || !Array.isArray(data.items) || data.items.length === 0){
      selectEl.innerHTML = '<option value="">（目前沒有可選課程，請到試算表 courselist 新增）</option>';
      return;
    }

    // 塞選項：value 存 id；用 data-title 存 title
    const frag = document.createDocumentFragment();
    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = '請選擇課程';
    frag.appendChild(ph);

    data.items.forEach(({id, title, instructor})=>{
      const opt = document.createElement('option');
      opt.value = id;
      opt.dataset.title = title || '';
      opt.textContent = instructor ? `${id}｜${title}（${instructor}）` : `${id}｜${title}`;
      frag.appendChild(opt);
    });

    selectEl.innerHTML = '';
    selectEl.appendChild(frag);

    // 當使用者選取課程 → 設定全域 __COURSE__ + 標題顯示
    selectEl.onchange = ()=>{
      const opt = selectEl.options[selectEl.selectedIndex];
      const id = selectEl.value || '';
      const title = opt?.dataset?.title || '';
      window.__COURSE__ = { id, title };
      const hdr = document.getElementById('courseHeader');
      if (hdr) hdr.textContent = id ? `（${id}｜${title}）` : '';
    };
  }catch(e){
    console.warn('載入課程清單失敗：', e);
    selectEl.innerHTML = '<option value="">（清單載入失敗，稍後再試或改用 QR/URL 預選）</option>';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  init();                 // ← 必須先跑，會 renderTabs()、隱藏其他分頁、綁事件等
  loadCourseListForMakeup(); // 補登課程選單再載
  bindAdminUnlock();
});

</script>
  
</body>
</html>

