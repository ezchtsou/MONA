<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ–°é€²å“¡å·¥è¨“ç·´å›é¥‹ç³»çµ± | MONA Onboarding Feedback</title>
  <style>
    :root{--bg:#f8fafc;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--brand:#0ea5e9;--active:#dbeafe;--danger:#fecaca}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans CJK TC",sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px;letter-spacing:.5px}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{border:1px solid #e5e7eb;background:#fff;color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
    .tab.active{border-color:var(--brand);box-shadow:0 0 0 1px inset var(--brand)}
    main{padding:24px}
    section.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:20px;margin:18px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input[type=text],input[type=date],input[type=email],select,textarea{width:100%;background:#fff;color:var(--text);border:1px solid #e5e7eb;border-radius:10px;padding:10px}
    textarea{min-height:88px}
    .scale{display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;cursor:pointer;transition:all .2s}
    .pill input{display:none}
    .pill:hover{background:#e0f2fe}
    .pill.active{background:var(--active);border-color:var(--brand);box-shadow:0 0 0 1px inset var(--brand)}
    .pill.error{background:var(--danger);border-color:#ef4444}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    button{border:1px solid #e5e7eb;background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button.primary{border-color:var(--brand);box-shadow:0 0 0 1px inset var(--brand)}
    .muted{color:var(--muted);font-size:12px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
    .hl{color:var(--brand)}
    .hidden{display:none!important}
    .toast{position:fixed;right:16px;bottom:16px;padding:10px 14px;background:#fff;border:1px solid #e5e7eb;border-radius:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h1>MONA Onboarding Feedbackï½œæ–°é€²å“¡å·¥è¨“ç·´å›é¥‹ç³»çµ±ï¼ˆGAS å¯«å…¥ Google è©¦ç®—è¡¨ ç‰ˆï¼‰</h1>
        <div>
          <span class="badge">ä½¿ç”¨è€…IDï¼š<span id="userIdBadge"></span></span>
        </div>
      </div>
      <nav id="tabs"></nav>
    </div>
  </header>
  <main class="wrap">
    <section id="tab-0" class="card">
      <h2>ğŸ”‘ åŸºæœ¬è³‡è¨Š</h2>
      <p class="muted">è«‹å…ˆå¡«å¯«ä»¥ä¸‹è³‡è¨Šï¼Œä»¥åˆ©å°‡å›è¦†å¯«å…¥ Google è©¦ç®—è¡¨ã€‚ç®¡ç†è¨­å®šå·²ç§»è‡³ã€ŒğŸ› ï¸ ç®¡ç†è¨­å®šï¼ˆAdminï¼‰ã€åˆ†é ï¼Œæ–°äººç„¡éœ€æ“ä½œã€‚</p>
      <div class="row">
        <div>
          <label>ä½¿ç”¨è€…ä»£è™Ÿï¼ˆemployeeIdï¼‰</label>
          <input id="employeeId" type="text" placeholder="ä¾‹å¦‚ï¼šVHC-2025-001" />
        </div>
        <div>
          <label>å§“å</label>
          <input id="fullName" type="text" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>å–®ä½ / éƒ¨é–€</label>
          <input id="dept" type="text" placeholder="ä¾‹å¦‚ï¼šè»Šè¼›èª²ï¼è»ŒåœŸèª²ï¼é€šè™Ÿèª²" />
        </div>
        <div>
          <label>ä»Šå¤©æ—¥æœŸ</label>
          <input id="date" type="date" />
        </div>
      </div>
      <div class="btns">
        <button id="fillToday" type="button">å¡«å…¥ä»Šå¤©</button>
      </div>
    </section>

    <section id="tab-1" class="card hidden">
      <h2>ğŸ©µ æ–°é€²å“¡å·¥åˆæœŸè¨“ç·´å›é¥‹å•å·</h2>
      <p class="muted">èšç„¦ã€Œæˆ‘çŸ¥é“ã€ï¼šè¨­æ–½ä½ç½®ã€çµ„ç¹”æ¶æ§‹ã€é—œéµåŒäº‹ã€ä¸»ç®¡ã€æ±‚åŠ©çª—å£ã€‚</p>
      <div id="survey-locate"></div>
      <label>é–‹æ”¾æ„è¦‹ï¼ˆå¯ç•™ç©ºï¼‰</label>
      <textarea id="locate-open"></textarea>
      <div class="btns">
        <button class="primary" id="submitLocate" type="button">é€å‡ºå®šä½å•å·ï¼ˆå¯«å…¥ Google è©¦ç®—è¡¨ï¼‰</button>
      </div>
    </section>

    <section id="tab-2" class="card hidden">
      <h2>ğŸ’¡ æ–°é€²å“¡å·¥ä¸­æœŸæŠ€èƒ½åŸºç¤èª²ç¨‹å›é¥‹å•å·ï¼ˆå«å°æ¸¬é©—ï¼‰</h2>
      <p class="muted">èšç„¦ã€Œæˆ‘æœƒç”¨ã€ï¼šç†è«–èˆ‡å¯¦ä½œæ˜¯å¦éŠœæ¥ã€å®‰å…¨è¦ç¯„ç†è§£ã€SOPåŸ·è¡Œã€‚</p>
      <div id="survey-skill"></div>
      <label>é–‹æ”¾æ„è¦‹ï¼ˆå¯ç•™ç©ºï¼‰</label>
      <textarea id="skill-open"></textarea>
      <h3>ğŸ§ª å°æ¸¬é©—ï¼ˆç¤ºä¾‹ï¼‰</h3>
      <div id="quiz"></div>
      <div class="btns">
        <button class="primary" id="submitSkill" type="button">é€å‡ºç†Ÿç·´å•å·ï¼‹æ¸¬é©—ï¼ˆå¯«å…¥ Google è©¦ç®—è¡¨ï¼‰</button>
      </div>
    </section>

    <section id="tab-3" class="card hidden">
      <h2>ğŸ”¶ æ–°é€²å“¡å·¥å¾ŒæœŸ360åº¦å“¡å·¥è©•ä¼°èª¿æŸ¥</h2>
      <p class="muted">èšç„¦ã€Œæˆ‘æˆé•·ã€ï¼šè‡ªä¸»ç®¡ç†ã€å•é¡Œè§£æ±ºã€å”ä½œã€æŒçºŒæ”¹å–„ã€è·æ¶¯è·¯å¾‘èªçŸ¥ã€‚</p>
      <div id="survey-grow"></div>
      <label>360 è§’è‰²</label>
      <select id="raterRole">
        <option value="self">è‡ªè©•</option>
        <option value="manager">ç›´å±¬ä¸»ç®¡</option>
        <option value="peer">åŒå„•</option>
        <option value="mentor">å°å¸«/æ•™ç·´</option>
      </select>
      <label>è©•ä¼°å°è±¡ï¼ˆemployeeIdï¼‰</label>
      <input id="rateeId" type="text" placeholder="è‹¥è‡ªè©•å¯ç•™æœ¬äººID" />
      <div class="btns">
        <button class="primary" id="submitGrow" type="button">é€å‡ºå•Ÿç™¼ï¼‹360è©•ä¼°ï¼ˆå¯«å…¥ Google è©¦ç®—è¡¨ï¼‰</button>
      </div>
    </section>

    <section id="tab-4" class="card hidden">
      <h2>ğŸ’¬ æ„è¦‹åæ˜ </h2>
      <div class="row">
        <div>
          <label>ç•™è¨€å…§å®¹</label>
          <textarea id="msgBody" placeholder="é‡åˆ°çš„å›°é›£ã€å»ºè­°ã€å¸Œæœ›è£œå¼·çš„ä¸»é¡Œâ€¦"></textarea>
        </div>
        <div>
          <label>æ˜¯å¦åŒ¿å</label>
          <select id="msgAnon"><option value="yes">åŒ¿å</option><option value="no">ç½²å</option></select>
          <div class="btns" style="margin-top:12px">
            <button class="primary" id="submitMsg" type="button">é€å‡ºç•™è¨€ï¼ˆå¯«å…¥ Google è©¦ç®—è¡¨ï¼‰</button>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-5" class="card hidden">
      <h2>ğŸ› ï¸ ç®¡ç†è¨­å®šï¼ˆAdminï¼‰</h2>
      <p class="muted">æ­¤åˆ†é åƒ…ä¾›ç®¡ç†è€…è¨­å®šå¾Œç«¯é€£ç·šèˆ‡æ¬„ä½å°æ‡‰ï¼Œæ–°äººä¸éœ€é€²å…¥æ­¤åˆ†é ã€‚</p>
      <div class="btns">
        <input id="adminKey" type="password" placeholder="è¼¸å…¥ç®¡ç†é‡‘é‘°ï¼ˆä¾‹å¦‚ï¼šMONAADMIN2025ï¼‰" style="max-width:320px" />
        <button id="adminToggle" type="button">å•Ÿç”¨ï¼ˆè¼¸å…¥é‡‘é‘°å¾Œé¡¯ç¤ºè¡¨å–®è¨­å®šï¼‰</button>
      </div>
      <div id="adminPanel" class="card hidden" style="margin-top:8px">
        <h3>ğŸ§¾ å¾Œç«¯é€£ç·š</h3>
        <p class="muted">æ¨è–¦ä½¿ç”¨ <strong>Google Apps Scriptï¼ˆGASï¼‰Web App</strong> ä½œç‚º API ç›´æ¥å¯«å…¥ Google è©¦ç®—è¡¨ã€‚</p>
        <label>GAS Web App URLï¼ˆ/execï¼‰</label>
        <input id="gas_url" type="text" placeholder="https://script.google.com/macros/s/......../exec" />
        <div class="btns" style="margin-top:8px">
          <button id="gasTestBtn" type="button">æ¸¬è©¦é€£ç·šï¼ˆPINGï¼‰</button>
        </div>
        <details style="margin:8px 0 16px">
          <summary class="muted">è‹¥éœ€ä¿ç•™ Google è¡¨å–® formResponseï¼ˆå‚™ç”¨ï¼‰</summary>
          <div class="row">
            <div>
              <label>å®šä½ formResponse URL</label>
              <input id="gf_loc_url" type="text" placeholder="https://docs.google.com/forms/d/e/.../formResponse" />
              <label>å®šä½ payload entry ä»£è™Ÿ</label>
              <input id="gf_loc_entry" type="text" placeholder="entry.295725881" />
              <label>å®šä½ å§“å entryï¼ˆé¸å¡«ï¼‰</label>
              <input id="gf_loc_name" type="text" placeholder="entry.xxxxxx" />
              <label>å®šä½ å–®ä½ entryï¼ˆé¸å¡«ï¼‰</label>
              <input id="gf_loc_unit" type="text" placeholder="entry.xxxxxx" />
            </div>
            <div>
              <label>ç†Ÿç·´ formResponse URL</label>
              <input id="gf_skill_url" type="text" placeholder="https://docs.google.com/forms/d/e/.../formResponse" />
              <label>ç†Ÿç·´ payload entry ä»£è™Ÿ</label>
              <input id="gf_skill_entry" type="text" placeholder="entry.1423903952" />
              <label>ç†Ÿç·´ å§“å entryï¼ˆé¸å¡«ï¼‰</label>
              <input id="gf_skill_name" type="text" placeholder="entry.xxxxxx" />
              <label>ç†Ÿç·´ å–®ä½ entryï¼ˆé¸å¡«ï¼‰</label>
              <input id="gf_skill_unit" type="text" placeholder="entry.xxxxxx" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>å•Ÿç™¼ï¼‹360 formResponse URL</label>
              <input id="gf_grow_url" type="text" placeholder="https://docs.google.com/forms/d/e/.../formResponse" />
              <label>å•Ÿç™¼ payload entry ä»£è™Ÿ</label>
              <input id="gf_grow_entry" type="text" placeholder="entry.626056042" />
              <label>å•Ÿç™¼ å§“å entryï¼ˆé¸å¡«ï¼‰</label>
              <input id="gf_grow_name" type="text" placeholder="entry.xxxxxx" />
              <label>å•Ÿç™¼ å–®ä½ entryï¼ˆé¸å¡«ï¼‰</label>
              <input id="gf_grow_unit" type="text" placeholder="entry.xxxxxx" />
            </div>
            <div>
              <label>ç•™è¨€ formResponse URL</label>
              <input id="gf_msg_url" type="text" placeholder="https://docs.google.com/forms/d/e/.../formResponse" />
              <label>ç•™è¨€ payload entry ä»£è™Ÿ</label>
              <input id="gf_msg_entry" type="text" placeholder="entry.803463096" />
              <label>ç•™è¨€ å§“å entryï¼ˆé¸å¡«ï¼‰</label>
              <input id="gf_msg_name" type="text" placeholder="entry.xxxxxx" />
              <label>ç•™è¨€ å–®ä½ entryï¼ˆé¸å¡«ï¼‰</label>
              <input id="gf_msg_unit" type="text" placeholder="entry.xxxxxx" />
            </div>
          </div>
        </details>
        <div class="btns">
          <button class="primary" id="saveBtn" type="button">å„²å­˜è¨­å®š</button>
          <button id="resetBtn" type="button">æ¸…ç©ºç•¶å‰è¨­å®š</button>
          <button id="exportBtn" type="button">åŒ¯å‡ºè¨­å®š JSON</button>
          <button id="importBtn" type="button">åŒ¯å…¥è¨­å®š JSON</button>
        </div>
      </div>
    </section>

    <footer class="wrap">
      <div>Â© 2025 MONA Onboarding Â· Vanilla JS Demo</div>
      <div class="btns" style="margin-top:12px">
        <button id="runTestsBtn" type="button">ğŸ” åŸ·è¡Œå…§å»ºæ¸¬è©¦ï¼ˆé¡¯ç¤ºæ–¼ Consoleï¼‰</button>
      </div>
    </footer>
  </main>

  <iframe name="sink" id="sink" style="display:none"></iframe>
  <form id="ghost" method="POST" target="sink" class="hidden"></form>

<script>
const ADMIN_KEY = 'MONAADMIN2025';
const STORAGE_KEY = 'mona_onboarding_cfg_v4';
const CONFIG_DEFAULTS = {
  gf:{
    locate:{ url:'https://docs.google.com/forms/d/e/1FAIpQLSfv3HxifEycHeJrHDW9E127JwqdtTkFI0fUgYsDw3a68RahrQ/formResponse', entry:'entry.295725881', name:'', unit:'' },
    skill :{ url:'https://docs.google.com/forms/d/e/1FAIpQLSek4o8CDj1h87HgTIxGlcf17wzddjfIabjsD67N3_iRrFAHwg/formResponse', entry:'entry.1423903952', name:'', unit:'' },
    grow  :{ url:'https://docs.google.com/forms/d/e/1FAIpQLSfKEsz8QXI41oWJft-QWsZzGnSQQefX6YkInOjjo2ewQzZkWw/formResponse', entry:'entry.626056042', name:'', unit:'' },
    msg   :{ url:'https://docs.google.com/forms/d/e/1FAIpQLScYpa7i_tkXiulrgtv3icf8PegxfXambQElH5nH1I1cp3W3-w/formResponse', entry:'entry.803463096', name:'', unit:'' }
  }
};
let profile = { employeeId:'', fullName:'', dept:'', date:'', api:{ gasUrl:'' }, gf: JSON.parse(JSON.stringify(CONFIG_DEFAULTS.gf)) };

function hydrateAdminFields(){
  const map = [['loc','locate'],['skill','skill'],['grow','grow'],['msg','msg']];
  const gas = document.getElementById('gas_url');
  if(gas) gas.value = profile.api?.gasUrl || '';
  map.forEach(([short,key])=>{
    const g = profile.gf[key];
    const byId = id=>document.getElementById(id);
    const urlEl = byId(`gf_${short}_url`);
    const entEl = byId(`gf_${short}_entry`);
    const nameEl = byId(`gf_${short}_name`);
    const unitEl = byId(`gf_${short}_unit`);
    if(urlEl) urlEl.value = g.url||'';
    if(entEl) entEl.value = g.entry||'';
    if(nameEl) nameEl.value = g.name||'';
    if(unitEl) unitEl.value = g.unit||'';
  });
}
function saveConfigOnly(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({api: profile.api, gf: profile.gf})); }
function restoreConfig(){
  profile.gf = JSON.parse(JSON.stringify(CONFIG_DEFAULTS.gf));
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){ try{ const cached = JSON.parse(raw); if(cached.gf){ profile.gf = {...profile.gf, ...cached.gf}; } if(cached.api){ profile.api = {...(profile.api||{}), ...cached.api}; } }catch(e){} }
  hydrateAdminFields();
}
function exportConfig(){
  const cfg = {gf: profile.gf, api: profile.api};
  const blob = new Blob([JSON.stringify(cfg,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='onboarding-config.json'; a.click(); URL.revokeObjectURL(url);
}
function importConfig(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
  inp.onchange = e=>{
    const file = e.target.files[0]; if(!file) return;
    file.text().then(text=>{
      try{ const cfg = JSON.parse(text); if(!cfg.gf) throw new Error('ç¼ºå°‘ gf');
        profile.gf = cfg.gf; if(cfg.api) profile.api = cfg.api; hydrateAdminFields(); saveConfigOnly(); toast('è¨­å®šå·²åŒ¯å…¥');
      }catch(err){ toast('åŒ¯å…¥å¤±æ•—ï¼š'+err.message); }
    });
  };
  inp.click();
}
function toggleAdmin(){
  const panel = document.getElementById('adminPanel');
  const keyInput = document.getElementById('adminKey');
  const typed = keyInput ? keyInput.value.trim() : '';
  if(panel.classList.contains('hidden')){
    let key = typed;
    if(!key){ key = (typeof prompt==='function') ? prompt('è¼¸å…¥ç®¡ç†é‡‘é‘°ä»¥å•Ÿç”¨ Admin æ¨¡å¼') : ''; }
    if(key!==ADMIN_KEY){ toast('é‡‘é‘°éŒ¯èª¤'); keyInput && keyInput.focus(); return; }
    panel.classList.remove('hidden');
    document.getElementById('adminToggle').textContent = 'åœç”¨';
    if(keyInput){ keyInput.value=''; }
  }else{
    panel.classList.add('hidden');
    document.getElementById('adminToggle').textContent = 'å•Ÿç”¨ï¼ˆè¼¸å…¥é‡‘é‘°å¾Œé¡¯ç¤ºè¡¨å–®è¨­å®šï¼‰';
  }
}
function prefillFromQuery(){
  const q = new URLSearchParams(location.search);
  const eid = q.get('eid')||q.get('id');
  const name = q.get('name');
  const dept = q.get('dept');
  if(eid) document.getElementById('employeeId').value = eid;
  if(name) document.getElementById('fullName').value = name;
  if(dept) document.getElementById('dept').value = dept;
}

const Likert = [
  {v:1,t:'éå¸¸ä¸åŒæ„'},{v:2,t:'ä¸åŒæ„'},{v:3,t:'æ™®é€š'},{v:4,t:'åŒæ„'},{v:5,t:'éå¸¸åŒæ„'}
];
const Q_LOCATE = [
  'æˆ‘çŸ¥é“ä¸»è¦è¨­æ–½ä½ç½®ï¼ˆè¾¦å…¬å®¤/ç¶­ä¿®å ´/é¤å»³/æ€¥æ•‘ç®±ï¼‰ã€‚',
  'æˆ‘æ¸…æ¥šçµ„ç¹”æ¶æ§‹èˆ‡éƒ¨é–€è·è²¬ã€‚',
  'æˆ‘çŸ¥é“æˆ‘çš„ç›´æ¥ä¸»ç®¡èˆ‡é—œéµåŒäº‹æ˜¯èª°ã€‚',
  'æˆ‘æ¸…æ¥šè«‹å‡ã€å ±ä¿®ã€å ±å¸³ç­‰åŸºæœ¬æµç¨‹ã€‚',
  'é‡åˆ°å•é¡Œæ™‚ï¼Œæˆ‘çŸ¥é“æ±‚åŠ©ç®¡é“èˆ‡è¯çµ¡æ–¹å¼ã€‚',
];
const Q_SKILL = [
  'æˆ‘èƒ½å°‡ç†è«–èª²å…§å®¹æ‡‰ç”¨åˆ°å¯¦ä½œä¸­ã€‚',
  'æˆ‘èƒ½æ­£ç¢ºä¾æ“š SOP åŸ·è¡Œæ—¥å¸¸ä»»å‹™ã€‚',
  'æˆ‘äº†è§£ä¸¦éµå®ˆå®‰å…¨è¦ç¯„ã€‚',
  'è¬›å¸«/æ•™ç·´çš„æŒ‡å°æœ‰åŠ©æ–¼æˆ‘å®Œæˆå·¥ä½œã€‚',
  'æˆ‘éœ€è¦çš„æ•™æèˆ‡å·¥å…·å®¹æ˜“å–å¾—ã€‚',
];
const QUIZ = [
  {q:'ç¶­ä¿®ä½œæ¥­é–‹å§‹å‰ï¼Œç¬¬ä¸€æ­¥æ‡‰ç¢ºèªçš„æ˜¯ï¼Ÿ', a:['å€‹äººé˜²è­·è£å‚™å°±ç·’','å·¥å…·æ˜¯å¦é½Šå…¨','æ‰“å¡ç´€éŒ„','åˆé¤æ˜¯å¦è¨‚å¥½'], ans:0},
  {q:'ä¸‹åˆ—ä½•è€…ä¸æ˜¯æ¨™æº–ç¶­ä¿®å ±å‘Šå¿…è¦æ¬„ä½ï¼Ÿ', a:['æ•…éšœæè¿°','æª¢æ¸¬æ­¥é©Ÿ','è™•ç†æ–¹å¼','å“¡å·¥å®¶åº­ç‹€æ³'], ans:3},
];
const Q_GROW = [
  'æˆ‘èƒ½è‡ªè¡Œè¦åŠƒèˆ‡ç®¡ç†å·¥ä½œé€²åº¦ï¼ˆè‡ªä¸»ç®¡ç†ï¼‰ã€‚',
  'æˆ‘èƒ½æ‹†è§£å•é¡Œä¸¦æå‡ºå¯è¡Œæ–¹æ¡ˆï¼ˆå•é¡Œè§£æ±ºï¼‰ã€‚',
  'æˆ‘èƒ½æœ‰æ•ˆèˆ‡ä»–äººå”ä½œèˆ‡æºé€šï¼ˆå”ä½œæºé€šï¼‰ã€‚',
  'æˆ‘æœƒä¸»å‹•æå‡ºæµç¨‹æˆ–å“è³ªæ”¹å–„å»ºè­°ï¼ˆæŒçºŒæ”¹å–„ï¼‰ã€‚',
  'æˆ‘æ¸…æ¥šè·æ¶¯ç™¼å±•èˆ‡æ™‰å‡è·¯å¾‘ã€‚',
];

function renderTabs(){
  const tabs = document.getElementById('tabs');
  const tabSpecs = [
    { id:'tab-0', name:'åŸºæœ¬è³‡è¨Š' },
    { id:'tab-1', name:'æ–°é€²å“¡å·¥åˆæœŸè¨“ç·´å›é¥‹å•å·' },
    { id:'tab-2', name:'ä¸­æœŸæŠ€èƒ½åŸºç¤èª²ç¨‹å›é¥‹ï¼ˆå«å°æ¸¬é©—ï¼‰' },
    { id:'tab-3', name:'å¾ŒæœŸ360åº¦å“¡å·¥è©•ä¼°èª¿æŸ¥' },
    { id:'tab-4', name:'æ„è¦‹åæ˜ ' },
    { id:'tab-5', name:'ç®¡ç†è¨­å®šï¼ˆAdminï¼‰' },
  ];
  window.__TAB_SPECS = tabSpecs;
  tabs.innerHTML = '';
  tabSpecs.forEach((t,i)=>{
    const btn = document.createElement('button');
    btn.className = 'tab'+(i===0?' active':'');
    btn.textContent = t.name;
    btn.addEventListener('click',()=>switchTab(i, tabSpecs));
    tabs.appendChild(btn);
  });
}
function switchTab(i, tabSpecs){
  if(!tabSpecs) tabSpecs = window.__TAB_SPECS || [];
  const tabs = document.getElementById('tabs').children;
  for(let k=0;k<tabs.length;k++) tabs[k].classList.toggle('active', k===i);
  tabSpecs.forEach((t,idx)=>{
    document.getElementById(t.id).classList.toggle('hidden', idx!==i);
  });
}
function renderScale(containerId, prefix, questions){
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  questions.forEach((text, idx)=>{
    const row = document.createElement('div');
    const lab = document.createElement('label'); lab.textContent = `${idx+1}. ${text}`; row.appendChild(lab);
    const scale = document.createElement('div'); scale.className = 'scale';
    Likert.forEach(opt=>{
      const id = `${prefix}-${idx}-${opt.v}`;
      const pill = document.createElement('label'); pill.className = 'pill'; pill.setAttribute('for', id);
      pill.innerHTML = `<input type=\"radio\" name=\"${prefix}-${idx}\" id=\"${id}\" value=\"${opt.v}\"> ${opt.v} ${opt.t}`;
      pill.addEventListener('click',()=>{
        document.querySelectorAll(`input[name='${prefix}-${idx}']`).forEach(r=>{
          const p = r.closest('label');
          p.classList.remove('active','error');
        });
        pill.classList.add('active');
      });
      scale.appendChild(pill);
    });
    row.appendChild(scale);
    container.appendChild(row);
  });
}
function renderQuiz(){
  const host = document.getElementById('quiz'); host.innerHTML = '';
  QUIZ.forEach((item, i)=>{
    const wrap = document.createElement('div'); wrap.className = 'card'; wrap.style.padding='12px';
    const q = document.createElement('div'); q.innerHTML = `<strong>Q${i+1}.</strong> ${item.q}`; wrap.appendChild(q);
    item.a.forEach((opt,j)=>{
      const id = `quiz-${i}-${j}`;
      const r = document.createElement('div');
      r.innerHTML = `<label class='pill' for='${id}'><input type='radio' id='${id}' name='quiz-${i}' value='${j}'> ${String.fromCharCode(65+j)}. ${opt}</label>`;
      r.addEventListener('click',()=>{
        document.querySelectorAll(`input[name='quiz-${i}']`).forEach(n=>n.closest('label').classList.remove('active','error'));
        r.querySelector('label').classList.add('active');
      });
      wrap.appendChild(r);
    });
    host.appendChild(wrap);
  });
}

function toast(t){
  const el = document.createElement('div'); el.className='toast'; el.textContent=t; document.body.appendChild(el);
  setTimeout(()=>{ el.remove(); }, 2200);
}
function readBasic(){
  profile.employeeId = document.getElementById('employeeId').value.trim();
  profile.fullName = document.getElementById('fullName').value.trim();
  profile.dept = document.getElementById('dept').value.trim();
  const d = document.getElementById('date').value;
  profile.date = d || new Date().toISOString().slice(0,10);
  document.getElementById('userIdBadge').textContent = profile.employeeId || 'æœªè¨­å®š';
}
function saveProfile(){
  profile.employeeId = document.getElementById('employeeId').value.trim();
  if(!profile.employeeId) return toast('è«‹å¡«å¯«ä½¿ç”¨è€…ä»£è™Ÿ');
  profile.fullName = document.getElementById('fullName').value.trim();
  profile.dept = document.getElementById('dept').value.trim();
  profile.date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
  const gas = document.getElementById('gas_url');
  if(gas) profile.api.gasUrl = gas.value.trim();
  profile.gf.locate.url = document.getElementById('gf_loc_url')?.value.trim()||profile.gf.locate.url;
  profile.gf.locate.entry = document.getElementById('gf_loc_entry')?.value.trim()||profile.gf.locate.entry;
  profile.gf.locate.name  = document.getElementById('gf_loc_name')?.value.trim()||profile.gf.locate.name;
  profile.gf.locate.unit  = document.getElementById('gf_loc_unit')?.value.trim()||profile.gf.locate.unit;
  profile.gf.skill.url = document.getElementById('gf_skill_url')?.value.trim()||profile.gf.skill.url;
  profile.gf.skill.entry = document.getElementById('gf_skill_entry')?.value.trim()||profile.gf.skill.entry;
  profile.gf.skill.name  = document.getElementById('gf_skill_name')?.value.trim()||profile.gf.skill.name;
  profile.gf.skill.unit  = document.getElementById('gf_skill_unit')?.value.trim()||profile.gf.skill.unit;
  profile.gf.grow.url = document.getElementById('gf_grow_url')?.value.trim()||profile.gf.grow.url;
  profile.gf.grow.entry = document.getElementById('gf_grow_entry')?.value.trim()||profile.gf.grow.entry;
  profile.gf.grow.name  = document.getElementById('gf_grow_name')?.value.trim()||profile.gf.grow.name;
  profile.gf.grow.unit  = document.getElementById('gf_grow_unit')?.value.trim()||profile.gf.grow.unit;
  profile.gf.msg.url = document.getElementById('gf_msg_url')?.value.trim()||profile.gf.msg.url;
  profile.gf.msg.entry = document.getElementById('gf_msg_entry')?.value.trim()||profile.gf.msg.entry;
  profile.gf.msg.name  = document.getElementById('gf_msg_name')?.value.trim()||profile.gf.msg.name;
  profile.gf.msg.unit  = document.getElementById('gf_msg_unit')?.value.trim()||profile.gf.msg.unit;
  document.getElementById('userIdBadge').textContent = profile.employeeId || 'æœªè¨­å®š';
  saveConfigOnly();
  toast('è¨­å®šå·²æ›´æ–°');
}
function resetProfile(){
  profile = { employeeId:'', fullName:'', dept:'', date:'', api:{ gasUrl:'' }, gf: JSON.parse(JSON.stringify(CONFIG_DEFAULTS.gf)) };
  document.getElementById('userIdBadge').textContent = 'æœªè¨­å®š';
  saveConfigOnly();
  hydrateAdminFields();
  toast('å·²æ¸…ç©ºç•¶å‰è¨­å®š');
}
function normalizeFormUrl(url){
  if(!url) return url;
  return url.replace(/\/u\/\d+\/d\/e\//,'/d/e/');
}

function isLikelyGas(url){
  return /^https:\/\/script\.google\.com\/macros\/s\//.test(url) && /\/exec(\?|$)/.test(url);
}

async function submitToGoogle(url, entry, payload, optNameEntry, optUnitEntry){
  // === Route A: GAS Web App ===
  if(profile?.api?.gasUrl){
    const gas = profile.api.gasUrl.trim();
    if(!isLikelyGas(gas)){
      throw new Error('GAS URL æ ¼å¼éŒ¯èª¤ï¼Œéœ€ä»¥ https://script.google.com/macros/s/.../exec é–‹é ­');
    }
    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), 15000); // 15 ç§’é€¾æ™‚ï¼Œé¿å…éæ—© abort é€ æˆ Failed to fetch
    try{
      const res = await fetch(gas + '?origin=' + encodeURIComponent(location.origin), {
        method: 'POST',
        headers: { 'Content-Type':'text/plain;charset=utf-8' }, // é¿å… preflight
        body: JSON.stringify(payload),
        signal: controller.signal
      });
      clearTimeout(t);
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      let bodyText = '';
      let data = null;
      try{
        if(ct.includes('application/json')){
          data = await res.json();
        }else{
          bodyText = await res.text();
          try{ data = JSON.parse(bodyText); }catch(_){ /* not json */ }
        }
      }catch(_){ /* ignore */ }
      const okFlag = data && (data.ok===true || data.success===true);
      if(res.ok && (okFlag || (!data && bodyText))){
        return { ok:true, data: data || bodyText, via:'fetch-post' };
      }
      console.error('GAS å›æ‡‰ç•°å¸¸', res.status, data||bodyText);
      throw new Error('GAS proxy failed');
    }catch(err){
      clearTimeout(t);
      console.warn('fetch POST å¤±æ•—ï¼Œå˜—è©¦ fallbackâ€¦', err);
      // === Fallback 1: sendBeaconï¼ˆä¸è®€å›æ‡‰ï¼Œä½†å¹¾ä¹ä¸æœƒè¢« CORS æ“‹ï¼‰ ===
      try{
        if(navigator.sendBeacon){
          const ok = navigator.sendBeacon(gas + '?origin=' + encodeURIComponent(location.origin) + '&beacon=1', new Blob([JSON.stringify(payload)], {type:'text/plain;charset=utf-8'}));
          if(ok){
            toast('å·²æ”¹ç”¨ä½é¢¨éšªå‚³é€ï¼ˆbeaconï¼‰ï¼Œè«‹ç¨å¾Œåœ¨è©¦ç®—è¡¨ç¢ºèª');
            return { ok:true, via:'beacon' };
          }
        }
      }catch(be){ console.warn('beacon ä¹Ÿå¤±æ•—', be); }
      // === Fallback 2: GET å¸¶åƒæ•¸ ===
      try{
        const url2 = gas + '?origin=' + encodeURIComponent(location.origin) + '&get=1&payload=' + encodeURIComponent(JSON.stringify(payload));
        const res2 = await fetch(url2, { method:'GET' });
        const txt2 = await res2.text();
        if(res2.ok){ return { ok:true, data: txt2, via:'fetch-get' }; }
      }catch(getErr){ console.warn('GET fallback å¤±æ•—', getErr); }
      // å…¨éƒ¨å¤±æ•—æ‰æ‹‹å‡º
      toast('é€£ç·š GAS å¤±æ•—ï¼šè«‹æª¢æŸ¥ URL/éƒ¨ç½²æ¬Šé™/ç¶²è·¯');
      throw err;
    }
  }

  // === Route B: Google è¡¨å–®ï¼ˆå‚™ç”¨ï¼Œä¸å»ºè­°ï¼‰ ===
  if(!url||!entry) { toast('å°šæœªè¨­å®š Google è¡¨å–® URL æˆ– entry ä»£è™Ÿ'); return Promise.reject(new Error('missing url/entry')); }
  const targetUrl = normalizeFormUrl(url);
  const badUrl = !/^https:\/\/docs\.google\.com\/forms\/d\/e\/.+\/formResponse$/.test(targetUrl);
  const badEntry = !/^entry\.[0-9]+$/.test(entry);
  if(badUrl){ toast('è¡¨å–® URL éœ€ç‚º https://docs.google.com/forms/d/e/.../formResponse'); return Promise.reject(new Error('bad url')); }
  if(badEntry){ toast('entry æ ¼å¼éŒ¯èª¤ï¼Œéœ€ç‚º entry.å¾Œæ¥æ•¸å­—'); return Promise.reject(new Error('bad entry')); }
  const ghost = document.getElementById('ghost');
  const sink = document.getElementById('sink');
  ghost.setAttribute('action', targetUrl);
  ghost.innerHTML = '';
  const inputPayload = document.createElement('input');
  inputPayload.type = 'hidden'; inputPayload.name = entry; inputPayload.value = JSON.stringify(payload);
  ghost.appendChild(inputPayload);
  if(optNameEntry){ const i = document.createElement('input'); i.type='hidden'; i.name=optNameEntry; i.value = profile.fullName; ghost.appendChild(i); }
  if(optUnitEntry){ const i = document.createElement('input'); i.type='hidden'; i.name=optUnitEntry; i.value = profile.dept; ghost.appendChild(i); }
  const pageHistory = document.createElement('input'); pageHistory.type='hidden'; pageHistory.name='pageHistory'; pageHistory.value='0'; ghost.appendChild(pageHistory);
  const fvv = document.createElement('input'); fvv.type='hidden'; fvv.name='fvv'; fvv.value='1'; ghost.appendChild(fvv);
  return new Promise((resolve)=>{
    let settled = false; const finish = (via)=>{ if(settled) return; settled = true; resolve({ok:true, via}); };
    const timer = setTimeout(()=>finish('timeout'), 5000);
    const handleLoad = ()=>{ clearTimeout(timer); sink.removeEventListener('load', handleLoad); finish('onload'); };
    sink.addEventListener('load', handleLoad, {once:true});
    HTMLFormElement.prototype.submit.call(ghost);
  });
}

function gatherScale(prefix, questions){
  const answers = [];
  for(let i=0;i<questions.length;i++){
    const picked = document.querySelector(`input[name='${prefix}-${i}']:checked`);
    answers.push(picked?Number(picked.value):null);
  }
  return answers;
}
function highlightMissing(prefix, questions){
  for(let i=0;i<questions.length;i++){
    const opts = document.querySelectorAll(`input[name='${prefix}-${i}']`);
    const anyChecked = Array.from(opts).some(o=>o.checked);
    opts.forEach(o=>{
      const lab = o.closest('label');
      lab.classList.toggle('error', !anyChecked);
      if(!anyChecked) lab.classList.remove('active');
    });
    if(!anyChecked){
      const first = opts[0]?.closest('label');
      if(first){ first.scrollIntoView({behavior:'smooth', block:'center'}); }
      break;
    }
  }
}
function validateRequired(kind){
  if(kind==='locate'){
    const vals = gatherScale('loc', Q_LOCATE);
    const missing = vals.map((v,i)=>v?null:i+1).filter(Boolean);
    if(missing.length){ highlightMissing('loc', Q_LOCATE); toast('è«‹å®Œæˆå®šä½å•å·ç¬¬ '+missing.join(', ')+' é¡Œ'); return false; }
    return true;
  }
  if(kind==='skill'){
    const vals = gatherScale('skill', Q_SKILL);
    const missing = vals.map((v,i)=>v?null:i+1).filter(Boolean);
    const quizMissing = [];
    for(let i=0;i<QUIZ.length;i++){
      const r = document.querySelector(`input[name='quiz-${i}']:checked`);
      if(!r) quizMissing.push(i+1);
    }
    if(missing.length){ highlightMissing('skill', Q_SKILL); toast('è«‹å®Œæˆç†Ÿç·´å•å·ç¬¬ '+missing.join(', ')+' é¡Œ'); return false; }
    if(quizMissing.length){
      const qs = document.querySelectorAll(`input[name='quiz-${quizMissing[0]-1}']`);
      qs.forEach(n=>{ n.closest('label').classList.add('error'); });
      qs[0]?.closest('label')?.scrollIntoView({behavior:'smooth', block:'center'});
      toast('è«‹ä½œç­”å°æ¸¬é©—ç¬¬ '+quizMissing.join(', ')+' é¡Œ'); return false;
    }
    return true;
  }
  if(kind==='grow360'){
    const vals = gatherScale('grow', Q_GROW);
    const missing = vals.map((v,i)=>v?null:i+1).filter(Boolean);
    const ratee = (document.getElementById('rateeId').value.trim() || profile.employeeId);
    if(!ratee){ toast('è«‹å¡«å¯«è©•ä¼°å°è±¡ employeeId'); return false; }
    if(missing.length){ highlightMissing('grow', Q_GROW); toast('è«‹å®Œæˆå•Ÿç™¼/360 å•å·ç¬¬ '+missing.join(', ')+' é¡Œ'); return false; }
    return true;
  }
  return true;
}
function ensureAdmin(kind){
  if(profile?.api?.gasUrl){ return { gas:true }; }
  const map = { locate: profile.gf.locate, skill: profile.gf.skill, grow360: profile.gf.grow, msg: profile.gf.msg };
  const cfg = map[kind];
  if(!cfg){ toast('æ‰¾ä¸åˆ°è©²å•å·çš„è¨­å®š'); throw new Error('no cfg'); }
  if(!cfg.url || !/https:\/\/docs\.google\.com\/forms\/d\/e\/.+\/formResponse$/.test(normalizeFormUrl(cfg.url))){ toast('è«‹åœ¨ Admin è¨­å®šè²¼ä¸Šä»¥ /formResponse çµå°¾çš„ URL'); throw new Error('bad url'); }
  if(!cfg.entry || !/^entry\.[0-9]+$/.test(cfg.entry)){ toast('è«‹åœ¨ Admin è¨­å®šå¡«å…¥æ­£ç¢ºçš„ entry.xxxxx'); throw new Error('bad entry'); }
  return cfg;
}
async function submitSurvey(kind){
  readBasic();
  if(!profile.employeeId){ toast('è«‹å…ˆæ–¼ã€ŒåŸºæœ¬è³‡è¨Šã€å¡«å¯«ä½¿ç”¨è€…ä»£è™Ÿ'); return; }
  if(!validateRequired(kind)) return;
  const base = { employeeId: profile.employeeId, fullName: profile.fullName, dept: profile.dept, date: profile.date, ts: Date.now() };
  if(kind==='locate'){
    const payload = { ...base, module:'locate', scores: gatherScale('loc', Q_LOCATE), open: document.getElementById('locate-open').value.trim() };
    const btn = document.getElementById('submitLocate'); const old=btn.textContent; btn.disabled=true; btn.textContent='å‚³é€ä¸­â€¦';
    try{ const cfg = ensureAdmin('locate'); await submitToGoogle(cfg.url, cfg.entry, payload, cfg.name, cfg.unit); btn.textContent='âœ” å·²é€å‡º'; toast('å®šä½å•å·å·²å¯«å…¥ Google è©¦ç®—è¡¨'); switchTab(0); }
    catch(err){ console.error(err); btn.disabled=false; btn.textContent=old; toast('é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Admin è¨­å®šæˆ– GAS'); }
    return;
  }
  if(kind==='skill'){
    const quizAns = QUIZ.map((_,i)=>{ const r = document.querySelector(`input[name='quiz-${i}']:checked`); return r?Number(r.value):null; });
    const quizScore = quizAns.reduce((acc,v,i)=>acc+(v===QUIZ[i].ans?1:0),0);
    const payload = { ...base, module:'skill', scores: gatherScale('skill', Q_SKILL), open: document.getElementById('skill-open').value.trim(), quizAns, quizScore, quizTotal: QUIZ.length };
    const btn = document.getElementById('submitSkill'); const old=btn.textContent; btn.disabled=true; btn.textContent='å‚³é€ä¸­â€¦';
    try{ const cfg = ensureAdmin('skill'); await submitToGoogle(cfg.url, cfg.entry, payload, cfg.name, cfg.unit); btn.textContent='âœ” å·²é€å‡º'; toast('ç†Ÿç·´å•å·ï¼‹æ¸¬é©—å·²å¯«å…¥ Google è©¦ç®—è¡¨'); switchTab(0); }
    catch(err){ console.error(err); btn.disabled=false; btn.textContent=old; toast('é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Admin è¨­å®šæˆ– GAS'); }
    return;
  }
  if(kind==='grow360'){
    const payload = { ...base, module:'grow360', role: document.getElementById('raterRole').value, rateeId: (document.getElementById('rateeId').value.trim() || profile.employeeId), scores: gatherScale('grow', Q_GROW) };
    const btn = document.getElementById('submitGrow'); const old=btn.textContent; btn.disabled=true; btn.textContent='å‚³é€ä¸­â€¦';
    try{ const cfg = ensureAdmin('grow360'); await submitToGoogle(cfg.url, cfg.entry, payload, cfg.name, cfg.unit); btn.textContent='âœ” å·²é€å‡º'; toast('å•Ÿç™¼ï¼‹360 è©•ä¼°å·²å¯«å…¥ Google è©¦ç®—è¡¨'); switchTab(0); }
    catch(err){ console.error(err); btn.disabled=false; btn.textContent=old; toast('é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Admin è¨­å®šæˆ– GAS'); }
    return;
  }
}
async function postMessage(){
  try{
    readBasic();
    if(!profile.employeeId) return toast('è«‹å…ˆæ–¼ã€ŒåŸºæœ¬è³‡è¨Šã€å¡«å¯«ä½¿ç”¨è€…ä»£è™Ÿ');
    const body = document.getElementById('msgBody').value.trim();
    if(!body) return toast('è«‹è¼¸å…¥ç•™è¨€å…§å®¹');
    const rec = { module:'messages', employeeId: (document.getElementById('msgAnon').value==='yes'?'åŒ¿å':profile.employeeId), fullName: profile.fullName, dept: profile.dept, body, date: profile.date, ts: Date.now() };
    const btn = document.getElementById('submitMsg'); const old = btn.textContent; btn.disabled=true; btn.textContent='å‚³é€ä¸­â€¦';
    const cfg = ensureAdmin('msg');
    await submitToGoogle(cfg.url, cfg.entry, rec, cfg.name, cfg.unit);
    document.getElementById('msgBody').value='';
    btn.textContent='âœ” å·²é€å‡º';
    toast('ç•™è¨€å·²å¯«å…¥ Google è©¦ç®—è¡¨');
    switchTab(0);
  }catch(err){
    console.error(err);
    const btn = document.getElementById('submitMsg');
    if(btn){ btn.disabled=false; btn.textContent='é€å‡ºç•™è¨€ï¼ˆå¯«å…¥ Google è©¦ç®—è¡¨ï¼‰'; }
    toast('é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Admin è¨­å®šæˆ– GAS');
  }
}

async function testGas(){
  const url = (document.getElementById('gas_url')?.value||'').trim();
  if(!url) return toast('è«‹å…ˆåœ¨ Admin å¡«å…¥ GAS URL');
  if(!isLikelyGas(url)) return toast('GAS URL æ ¼å¼éŒ¯èª¤ï¼Œè«‹è²¼ /exec çµå°¾çš„ URL');
  try{
    const res = await fetch(url, { method:'GET' });
    const text = await res.text();
    toast('GAS æ­£å¸¸ï¼š'+(text.slice(0,40)));
  }catch(err){ console.error(err); toast('ç„¡æ³•é€£ç·šåˆ° GASï¼Œè«‹æª¢æŸ¥éƒ¨ç½²æ¬Šé™èˆ‡ URL'); }
}

function assert(cond, msg){ if(!cond){ console.error('âŒ', msg); throw new Error(msg); } else { console.log('âœ…', msg); } }
async function runTests(){
  try{
    console.group('å…§å»ºæ¸¬è©¦');
    assert(CONFIG_DEFAULTS.gf.locate.url.includes('/formResponse'),'CONFIG é è¼‰ï¼šlocate URL å­˜åœ¨');
    assert(CONFIG_DEFAULTS.gf.locate.entry.startsWith('entry.'),'CONFIG é è¼‰ï¼šlocate entry æ­£ç¢ºæ ¼å¼');
    renderScale('survey-locate','loc', Q_LOCATE);
    const radios = document.querySelectorAll("input[type='radio'][name^='loc-']");
    assert(radios.length === Q_LOCATE.length * Likert.length, 'Likert é¡Œç›® Ã— é¸é …æ•¸é‡ æ­£ç¢º');
    const vals = gatherScale('loc', Q_LOCATE);
    assert(vals.length === Q_LOCATE.length, 'gatherScale é•·åº¦æ­£ç¢º');
    assert(vals.every(v=>v===null), 'gatherScale é è¨­ç‚º null');
    renderQuiz();
    assert(QUIZ.length > 0, 'QUIZ é¡Œåº«å­˜åœ¨');
    const q0 = QUIZ[0];
    assert(Array.isArray(q0.a) && typeof q0.ans === 'number', 'QUIZ çµæ§‹æ­£ç¢º');
    // ç¢ºä¿ä¸å—å·²è¨­å®šçš„ GAS å½±éŸ¿ï¼šæ­¤æ®µéœ€èµ° Google Form å‚™æ´è·¯å¾‘
    const prevGas = profile.api.gasUrl; profile.api.gasUrl = '';
    profile.employeeId = 'TEST-001'; profile.fullName='æ¸¬è©¦'; profile.dept='å–®ä½'; profile.date='2025-10-17';
    const payload = { employeeId: profile.employeeId, fullName: profile.fullName, dept: profile.dept, date: profile.date, ts: 1, module:'skill', scores:[1,2,3,4,5], open:'', quizAns:[0,1], quizScore:1, quizTotal:2 };
    const url = 'https://docs.google.com/forms/d/e/TEST/formResponse'; const entry = 'entry.123';
    try{ await submitToGoogle(url, entry, payload); }catch(e){}
    assert(document.getElementById('ghost').querySelectorAll('input').length >= 2, 'éš±è—è¡¨å–®å·²ç”Ÿæˆå¿…è¦æ¬„ä½');
    profile.api.gasUrl = prevGas; // é‚„åŸ

    const origPrompt = window.prompt; window.prompt = ()=>ADMIN_KEY;
    toggleAdmin();
    assert(!document.getElementById('adminPanel').classList.contains('hidden'), 'Admin é–‹å•Ÿ');
    toggleAdmin();
    assert(document.getElementById('adminPanel').classList.contains('hidden'), 'Admin é—œé–‰');
    window.prompt = origPrompt;
    assert(validateRequired('locate')===false, 'å¿…å¡«ï¼šå®šä½æœªå¡«æ™‚é˜»æ“‹');
    document.getElementById('employeeId').value = 'U-9999';
    readBasic();
    assert(profile.employeeId==='U-9999','readBasic å³æ™‚åŒæ­¥ employeeId');
    assert(typeof submitSurvey === 'function', 'submitSurvey å®šç¾©å­˜åœ¨');
    switchTab(1);
    assert(!document.getElementById('tab-1').classList.contains('hidden'),'Tab1 é¡¯ç¤º');
    switchTab(0);
    assert(!document.getElementById('tab-0').classList.contains('hidden'),'å®Œæˆå°å›åŸºæœ¬è³‡è¨Š Tab0 é¡¯ç¤º');
    assert(typeof postMessage === 'function', 'postMessage å®šç¾©å­˜åœ¨');
    const tabButtons = document.getElementById('tabs').children; 
    assert(tabButtons.length === 6, 'Tabs æ•¸é‡æ­£ç¢ºï¼ˆ6 å€‹ï¼‰');
    // Test 13: è¨­å®š GAS URL æ™‚ï¼ŒsubmitToGoogle æ‡‰èµ° GAS åˆ†æ”¯ï¼ˆåƒ…æª¢æŸ¥è·¯å¾‘ï¼Œä¸çœŸæ­£é€å‡ºï¼‰
    profile.api.gasUrl = 'https://script.google.com/macros/s/FAKE/exec';
    try{ await submitToGoogle('', '', {module:'locate'}); }catch(_){ }
    // Test 14: éŒ¯èª¤çš„ GAS URL æ‡‰è©²æ‹‹å‡ºéŒ¯èª¤
    let threw=false; profile.api.gasUrl='https://example.invalid/exec';
    try{ await submitToGoogle('', '', {module:'locate'}); }catch(e){ threw=true; }
    assert(threw===true,'GAS URL éŒ¯èª¤æ™‚æœƒæ‹’çµ•ä¸¦æç¤º');
    console.log('%cæ‰€æœ‰æ¸¬è©¦é€šé','color:#0ea5e9');
    toast('æ¸¬è©¦é€šéï¼ˆè©³è¦‹ Consoleï¼‰');
  }catch(e){
    console.error(e);
    toast('æœ‰æ¸¬è©¦å¤±æ•—ï¼Œè«‹é–‹ Console æª¢è¦–');
  }finally{
    console.groupEnd();
  }
}

function init(){
  renderTabs();
  renderScale('survey-locate','loc', Q_LOCATE);
  renderScale('survey-skill','skill', Q_SKILL);
  renderScale('survey-grow','grow', Q_GROW);
  renderQuiz();
  document.getElementById('date').value = new Date().toISOString().slice(0,10);
  prefillFromQuery();
  readBasic();
  ['employeeId','fullName','dept','date'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', readBasic);
  });
  document.getElementById('fillToday').addEventListener('click',()=>{ const today=new Date().toISOString().slice(0,10); document.getElementById('date').value=today; readBasic(); });
  document.getElementById('adminToggle').addEventListener('click', toggleAdmin);
  const keyInp = document.getElementById('adminKey');
  if(keyInp){ keyInp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); toggleAdmin(); } }); }
  document.getElementById('saveBtn').addEventListener('click', saveProfile);
  document.getElementById('resetBtn').addEventListener('click', resetProfile);
  document.getElementById('exportBtn').addEventListener('click', exportConfig);
  document.getElementById('importBtn').addEventListener('click', importConfig);
  document.getElementById('gasTestBtn').addEventListener('click', testGas);
  document.getElementById('submitLocate').addEventListener('click', ()=>submitSurvey('locate'));
  document.getElementById('submitSkill').addEventListener('click', ()=>submitSurvey('skill'));
  document.getElementById('submitGrow').addEventListener('click', ()=>submitSurvey('grow360'));
  document.getElementById('submitMsg').addEventListener('click', postMessage);
  document.getElementById('runTestsBtn').addEventListener('click', runTests);
  restoreConfig();
  try{
    const sp = new URLSearchParams(location.search);
    const ak = sp.get('admin');
    if(ak && ak===ADMIN_KEY){
      document.getElementById('adminPanel').classList.remove('hidden');
      document.getElementById('adminToggle').textContent = 'åœç”¨';
      toast('å·²ä»¥ç¶²å€åƒæ•¸å•Ÿç”¨ Admin æ¨¡å¼');
    }
  }catch(_){ }
  switchTab(0, [
    { id:'tab-0' },{ id:'tab-1' },{ id:'tab-2' },{ id:'tab-3' },{ id:'tab-4' },{ id:'tab-5' }
  ]);
}
init();
</script>
</body>
</html>
